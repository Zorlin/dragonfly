{% extends "base.html" %}

{% block title %}Dragonfly - Dashboard{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <h2 class="text-lg font-medium text-purple-600 dark:text-purple-400 uppercase tracking-wider mb-6">
        {% if is_demo_mode %}
            You're in demo mode - welcome to Dragonfly.
        {% else %}
            Welcome to Dragonfly.
        {% endif %}
    </h2>

    {# Conditional display: Installer or Regular Dashboard #}
    {% if installation_in_progress %}
    
    <!-- Installation Progress Section -->
    <div class="mb-8">
        <div class="flex justify-between items-center mb-4">
            <h2 id="installer-title" class="text-lg font-medium text-gray-900 dark:text-gray-200 uppercase tracking-wider">Installation</h2>
             {# Hide "View all machines" during install #}
        </div>
        <div id="installer-status-box" class="bg-white dark:bg-[#0A0B10] shadow-lg rounded-lg overflow-hidden border border-purple-500 dark:border-purple-700">
             <div class="px-6 py-16"> {# Increased padding for focus #}
                 <div class="text-center">
                     <div id="installer-rocket" class="mb-6 {{ initial_animation_class }}">
                         <svg class="mx-auto h-16 w-16 text-gray-500 rocket-svg" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" overflow="visible">
                             <!-- Main rocket path -->
                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.59 14.37a6 6 0 01-5.84 7.38v-4.8m5.84-2.58a14.98 14.98 0 006.16-12.12A14.98 14.98 0 009.631 8.41m5.96 5.96a14.926 14.926 0 01-5.841 2.58m-.119-8.54a6 6 0 00-7.381 5.84h4.8m2.581-5.84a14.927 14.927 0 00-2.58 5.84m2.699 2.7c-.103.021-.207.041-.311.06a15.09 15.09 0 01-2.448-2.448 14.9 14.9 0 01.06-.312M16.5 9a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z">
                                 <!-- SMIL animations for different phases -->
                                 <!-- 1. Initial glow (start) -->
                                 <animate id="anim-glow-initial" attributeName="opacity" values="0.9;1;0.9" dur="2s" repeatCount="indefinite" begin="indefinite" />
                                 
                                 <!-- 2. Network detection (big spark) -->
                                 <animate id="anim-big-spark" attributeName="opacity" values="0.8;1.2;0.8" dur="0.7s" repeatCount="1" begin="indefinite" />
                                 <animate id="anim-big-spark-flash" attributeName="stroke" values="currentColor;#f97316;currentColor" dur="0.7s" repeatCount="1" begin="indefinite" />
                                 
                                 <!-- 3. k3s installation (sparks continue) -->
                                 <animate id="anim-scanning" attributeName="opacity" values="0.9;1;0.9" dur="2s" repeatCount="indefinite" begin="indefinite" />
                                 <animateTransform id="anim-scale" attributeName="transform" type="scale" additive="sum" from="1 1" to="1.03 1.03" dur="2s" repeatCount="indefinite" begin="indefinite" />
                                 
                                 <!-- 4. Waiting for k3s (glow increases) -->
                                 <animate id="anim-glow-stronger" attributeName="opacity" values="0.9;1.1;0.9" dur="1.5s" repeatCount="indefinite" begin="indefinite" />
                                 <animate id="anim-glow-stronger-color" attributeName="stroke" values="currentColor;#a855f7;currentColor" dur="1.5s" repeatCount="indefinite" begin="indefinite" />
                                 
                                 <!-- 5. Tinkerbell installation (flicker begins) -->
                                 <animate id="anim-flicker" attributeName="opacity" values="0.9;1;0.8;1;0.9" dur="0.2s" repeatCount="indefinite" begin="indefinite" />
                                 
                                 <!-- 6. Dragonfly installation (faster flicker, pre-launch) -->
                                 <animate id="anim-fast-flicker" attributeName="opacity" values="0.8;1.1;0.7;1.2;0.8" dur="0.15s" repeatCount="indefinite" begin="indefinite" />
                                 
                                 <!-- 7. Installation complete (rocket fire) -->
                                 <animateTransform id="anim-fire" attributeName="transform" type="translate" additive="sum" from="0 0" to="0 -2" dur="0.3s" repeatCount="indefinite" begin="indefinite" />
                                 <animateTransform id="anim-shift" attributeName="transform" type="rotate" additive="sum" values="0;-0.5;0.5;0" dur="0.4s" repeatCount="indefinite" begin="indefinite" />
                             </path>
                             
                             <!-- Smoke trails group - initially hidden -->
                             <g id="smoke-particles" opacity="0">
                                 <circle id="smoke1" cx="7" cy="18" r="0.8" fill="rgba(200,200,200,0.4)" opacity="0">
                                     <animate id="smoke1-appear" attributeName="opacity" from="0" to="0.4" dur="0.3s" begin="indefinite" />
                                     <animate id="smoke1-fade" attributeName="opacity" from="0.4" to="0" dur="1.5s" begin="indefinite" />
                                     <animateMotion id="smoke1-move" path="M0,0 q-1,-10 -2,-20" dur="2s" begin="indefinite" fill="freeze" />
                                     <animate id="smoke1-grow" attributeName="r" from="0.8" to="2.5" dur="2s" begin="indefinite" />
                                 </circle>
                                 
                                 <circle id="smoke2" cx="7" cy="18" r="0.7" fill="rgba(200,200,200,0.4)" opacity="0">
                                     <animate id="smoke2-appear" attributeName="opacity" from="0" to="0.3" dur="0.3s" begin="indefinite" />
                                     <animate id="smoke2-fade" attributeName="opacity" from="0.3" to="0" dur="1.7s" begin="indefinite" />
                                     <animateMotion id="smoke2-move" path="M0,0 q1,-12 3,-22" dur="2.2s" begin="indefinite" fill="freeze" />
                                     <animate id="smoke2-grow" attributeName="r" from="0.7" to="2.2" dur="2.2s" begin="indefinite" />
                                 </circle>
                             </g>
                             
                             <!-- Spark particles group - initially hidden but positioned at bottom left of rocket -->
                             <g id="spark-particles" opacity="0">
                                 <!-- Bottom left sparks (45 degrees) -->
                                 <circle id="spark1" cx="7" cy="17" r="0.4" fill="orange" opacity="0">
                                     <animate id="spark1-appear" attributeName="opacity" from="0" to="1" dur="0.2s" begin="indefinite" />
                                     <animate id="spark1-fade" attributeName="opacity" from="1" to="0" dur="0.6s" begin="indefinite" />
                                     <animateMotion id="spark1-move" path="M0,0 q-3,4 -6,8" dur="0.8s" begin="indefinite" fill="freeze" />
                                 </circle>
                                 
                                 <circle id="spark2" cx="7" cy="17" r="0.3" fill="yellow" opacity="0">
                                     <animate id="spark2-appear" attributeName="opacity" from="0" to="1" dur="0.2s" begin="indefinite" />
                                     <animate id="spark2-fade" attributeName="opacity" from="1" to="0" dur="0.5s" begin="indefinite" />
                                     <animateMotion id="spark2-move" path="M0,0 q-2,5 -5,7" dur="0.7s" begin="indefinite" fill="freeze" />
                                 </circle>
                                 
                                 <circle id="spark3" cx="7" cy="17" r="0.25" fill="gold" opacity="0">
                                     <animate id="spark3-appear" attributeName="opacity" from="0" to="1" dur="0.1s" begin="indefinite" />
                                     <animate id="spark3-fade" attributeName="opacity" from="1" to="0" dur="0.4s" begin="indefinite" />
                                     <animateMotion id="spark3-move" path="M0,0 q-4,2 -7,5" dur="0.5s" begin="indefinite" fill="freeze" />
                                 </circle>
                                 
                                 <!-- Bottom right sparks (45 degrees) -->
                                 <circle id="spark4" cx="7" cy="17" r="0.35" fill="orange" opacity="0">
                                     <animate id="spark4-appear" attributeName="opacity" from="0" to="1" dur="0.2s" begin="indefinite" />
                                     <animate id="spark4-fade" attributeName="opacity" from="1" to="0" dur="0.6s" begin="indefinite" />
                                     <animateMotion id="spark4-move" path="M0,0 q-1,5 -3,10" dur="0.8s" begin="indefinite" fill="freeze" />
                                 </circle>
                                 
                                 <circle id="spark5" cx="7" cy="17" r="0.3" fill="yellow" opacity="0">
                                     <animate id="spark5-appear" attributeName="opacity" from="0" to="1" dur="0.2s" begin="indefinite" />
                                     <animate id="spark5-fade" attributeName="opacity" from="1" to="0" dur="0.5s" begin="indefinite" />
                                     <animateMotion id="spark5-move" path="M0,0 q-2,3 -4,8" dur="0.7s" begin="indefinite" fill="freeze" />
                                 </circle>
                                 
                                 <circle id="spark6" cx="7" cy="17" r="0.25" fill="gold" opacity="0">
                                     <animate id="spark6-appear" attributeName="opacity" from="0" to="1" dur="0.1s" begin="indefinite" />
                                     <animate id="spark6-fade" attributeName="opacity" from="1" to="0" dur="0.4s" begin="indefinite" />
                                     <animateMotion id="spark6-move" path="M0,0 q-3,3 -5,6" dur="0.5s" begin="indefinite" fill="freeze" />
                                 </circle>
                                 
                                 <!-- Additional angled sparks -->
                                 <circle id="spark7" cx="8" cy="18" r="0.2" fill="#FF9900" opacity="0">
                                     <animate id="spark7-appear" attributeName="opacity" from="0" to="1" dur="0.1s" begin="indefinite" />
                                     <animate id="spark7-fade" attributeName="opacity" from="1" to="0" dur="0.5s" begin="indefinite" />
                                     <animateMotion id="spark7-move" path="M0,0 q-4,1 -8,3" dur="0.6s" begin="indefinite" fill="freeze" />
                                 </circle>
                                 
                                 <circle id="spark8" cx="8" cy="18" r="0.2" fill="#FF9900" opacity="0">
                                     <animate id="spark8-appear" attributeName="opacity" from="0" to="1" dur="0.1s" begin="indefinite" />
                                     <animate id="spark8-fade" attributeName="opacity" from="1" to="0" dur="0.5s" begin="indefinite" />
                                     <animateMotion id="spark8-move" path="M0,0 q-2,4 -4,9" dur="0.6s" begin="indefinite" fill="freeze" />
                                 </circle>
                             </g>
                             
                             <!-- Glow effect at the bottom left -->
                             <g id="glow-effect" opacity="0">
                                 <!-- Main glow -->
                                 <circle id="glow-circle" cx="7" cy="17" r="2" fill="url(#glow-gradient)" opacity="0.7">
                                     <animate id="glow-pulse" attributeName="r" values="1.8;2.3;1.8" dur="1.5s" repeatCount="indefinite" begin="indefinite" />
                                     <animate id="glow-opacity" attributeName="opacity" values="0.5;0.8;0.5" dur="1.5s" repeatCount="indefinite" begin="indefinite" />
                                 </circle>
                                 
                                 <!-- Secondary glow -->
                                 <circle id="glow-circle-outer" cx="7" cy="17" r="3.5" fill="url(#glow-gradient-outer)" opacity="0.3">
                                     <animate id="glow-pulse-outer" attributeName="r" values="3;4;3" dur="2s" repeatCount="indefinite" begin="indefinite" />
                                     <animate id="glow-opacity-outer" attributeName="opacity" values="0.2;0.4;0.2" dur="2s" repeatCount="indefinite" begin="indefinite" />
                                 </circle>
                                 
                                 <!-- Big spark flash element -->
                                 <circle id="big-spark-circle" cx="7" cy="17" r="0" fill="url(#spark-gradient)" opacity="0">
                                     <animate id="big-spark-appear" attributeName="r" values="0;8;5;1;0" dur="0.7s" repeatCount="1" begin="indefinite" />
                                     <animate id="big-spark-opacity" attributeName="opacity" values="0;0.9;0.7;0.2;0" dur="0.7s" repeatCount="1" begin="indefinite" />
                                 </circle>
                             </g>
                             
                             <!-- Rocket flame - initially hidden, positioned to appear behind the rocket -->
                             <g id="rocket-flame" opacity="0" stroke="none">
                                 <!-- Simplified outer flame with natural, continuous shape -->
                                 <path d="M 8,17 C 3,22 -4,28 -8,32 C -3,29 -1,26 2,22 C 4,20 6,18 8,17 Z" fill="url(#flame-gradient)" stroke="none">
                                     <animate id="flame-flicker" attributeName="d" 
                                        values="M 8,17 C 3,22 -4,28 -8,32 C -3,29 -1,26 2,22 C 4,20 6,18 8,17 Z;
                                               M 8,17 C 2,23 -5,29 -9,33 C -4,30 -2,27 1,23 C 3,21 5,19 8,17 Z;
                                               M 8,17 C 4,21 -3,27 -7,31 C -2,28 0,25 3,21 C 5,19 7,17 8,17 Z;
                                               M 8,17 C 3,22 -4,28 -8,32 C -3,29 -1,26 2,22 C 4,20 6,18 8,17 Z" 
                                        dur="0.7s" repeatCount="indefinite" begin="indefinite" />
                                 </path>
                                 
                                 <!-- Simplified inner flame core with natural shape -->
                                 <path d="M 8,17 C 5,19 0,23 -3,27 C -1,25 1,22 3,20 C 5,18 7,17 8,17 Z" fill="url(#flame-core-gradient)" stroke="none">
                                     <animate id="flame-core-flicker" attributeName="d" 
                                        values="M 8,17 C 5,19 0,23 -3,27 C -1,25 1,22 3,20 C 5,18 7,17 8,17 Z;
                                               M 8,17 C 4,20 -1,24 -4,28 C -2,26 0,23 2,21 C 4,19 6,18 8,17 Z;
                                               M 8,17 C 6,18 1,22 -2,26 C 0,24 2,21 4,19 C 6,17 7,17 8,17 Z;
                                               M 8,17 C 5,19 0,23 -3,27 C -1,25 1,22 3,20 C 5,18 7,17 8,17 Z" 
                                        dur="0.5s" repeatCount="indefinite" begin="indefinite" />
                                 </path>
                             </g>
                             
                             <!-- Define gradients for glow effects -->
                             <defs>
                                 <radialGradient id="glow-gradient" cx="50%" cy="50%" r="50%" fx="50%" fy="50%">
                                     <stop offset="0%" stop-color="#a855f7" stop-opacity="0.9" />
                                     <stop offset="100%" stop-color="#a855f7" stop-opacity="0" />
                                 </radialGradient>
                                 
                                 <radialGradient id="glow-gradient-outer" cx="50%" cy="50%" r="50%" fx="50%" fy="50%">
                                     <stop offset="0%" stop-color="#a855f7" stop-opacity="0.5" />
                                     <stop offset="100%" stop-color="#a855f7" stop-opacity="0" />
                                 </radialGradient>
                                 
                                 <radialGradient id="glow-gradient-stronger" cx="50%" cy="50%" r="50%" fx="50%" fy="50%">
                                     <stop offset="0%" stop-color="#ec4899" stop-opacity="0.9" />
                                     <stop offset="100%" stop-color="#a855f7" stop-opacity="0" />
                                 </radialGradient>
                                 
                                 <!-- Spark gradient -->
                                 <radialGradient id="spark-gradient" cx="50%" cy="50%" r="50%" fx="50%" fy="50%">
                                     <stop offset="0%" stop-color="#fff" stop-opacity="0.95" />
                                     <stop offset="30%" stop-color="#f97316" stop-opacity="0.9" />
                                     <stop offset="70%" stop-color="#f97316" stop-opacity="0.7" />
                                     <stop offset="100%" stop-color="#f97316" stop-opacity="0" />
                                 </radialGradient>
                                 
                                 <!-- Flame gradients - updated for better visibility -->
                                 <linearGradient id="flame-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                     <stop offset="0%" stop-color="#ffffff" stop-opacity="0.95" />
                                     <stop offset="25%" stop-color="#f97316" stop-opacity="0.95" />
                                     <stop offset="60%" stop-color="#ef4444" stop-opacity="0.9" />
                                     <stop offset="100%" stop-color="#a855f7" stop-opacity="0.8" />
                                 </linearGradient>
                                 
                                 <linearGradient id="flame-core-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                     <stop offset="0%" stop-color="#ffffff" stop-opacity="1" />
                                     <stop offset="40%" stop-color="#fef3c7" stop-opacity="0.95" />
                                     <stop offset="80%" stop-color="#f97316" stop-opacity="0.9" />
                                     <stop offset="100%" stop-color="#ef4444" stop-opacity="0.8" />
                                 </linearGradient>
                             </defs>
                         </svg>
                     </div>
                     <p id="installer-message" class="mt-4 text-gray-500 dark:text-gray-300">{{ initial_install_message }}</p>
                 </div>
             </div>
        </div>
    </div>
    
    {% else %}

    <!-- Recent Machines Section (Regular View) -->
    <div class="mb-8">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-medium text-gray-900 dark:text-gray-200 uppercase tracking-wider">Recent Machines</h2>
            <a href="/machines" class="text-sm font-medium text-indigo-400 hover:text-indigo-300 flex items-center">
                <span>View all machines</span>
                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </a>
        </div>
        <div id="machine-list" class="bg-white dark:bg-[#0A0B10] shadow-lg rounded-lg overflow-hidden border border-purple-500 dark:border-purple-700">
            <ul class="divide-y divide-gray-800 dark:divide-gray-700">
                {% for machine in machines %}
                <li class="hover:bg-gray-50 dark:hover:bg-gray-900 cursor-pointer transition-colors duration-150" onclick="window.location='/machines/{{ machine.id }}'">
                    <div class="px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-indigo-400 truncate flex items-center">
                                    {% if machine.hostname %}
                                        <span class="mr-2">{{ machine.hostname }}</span>
                                    {% else %}
                                        <span class="tech-mono mr-2">{{ machine.id }}</span>
                                    {% endif %}
                                    
                                    {% if machine.memorable_name %}
                                        <span class="text-xs text-gray-500 dark:text-gray-400 italic">
                                            ({{ machine.memorable_name }})
                                        </span>
                                    {% endif %}
                                </p>
                            </div>
                            <div class="ml-2 flex-shrink-0 flex">
                                <p class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                    {% if machine.status|string == "Ready" %}
                                        bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200
                                    {% elif machine.status|string == "InstallingOS" %}
                                        bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200
                                    {% elif machine.status|string == "ReadyForAdoption" %}
                                        bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200
                                    {% else %}
                                        bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200
                                    {% endif %}">
                                    {{ machine.status }}
                                </p>
                            </div>
                        </div>
                        <div class="mt-2 flex flex-col sm:flex-row sm:justify-between text-xs">
                            <div class="flex flex-col sm:flex-row sm:space-x-4">
                                <p class="flex items-center text-gray-500 dark:text-gray-400">
                                    <span class="font-medium mr-1">MAC:</span>
                                    <span class="tech-mono">{{ machine.mac_address }}</span>
                                </p>
                                <p class="flex items-center text-gray-500 dark:text-gray-400 mt-1 sm:mt-0">
                                    <span class="font-medium mr-1">IP:</span>
                                    <span class="tech-mono">{{ machine.ip_address }}</span>
                                </p>
                            </div>
                            <p class="flex items-center text-gray-500 dark:text-gray-400 mt-1 sm:mt-0">
                                <span class="font-medium mr-1">Registered:</span>
                                <span class="tech-mono">{{ machine.created_at|string }}</span>
                            </p>
                        </div>
                    </div>
                </li>
                {% else %}
                <li class="px-6 py-16"> {# Increased padding #}
                    <div class="text-center">
                        <div class="mb-6">
                            <svg class="mx-auto h-16 w-16 text-gray-500 rocket-svg" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" overflow="visible">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.59 14.37a6 6 0 01-5.84 7.38v-4.8m5.84-2.58a14.98 14.98 0 006.16-12.12A14.98 14.98 0 009.631 8.41m5.96 5.96a14.926 14.926 0 01-5.841 2.58m-.119-8.54a6 6 0 00-7.381 5.84h4.8m2.581-5.84a14.927 14.927 0 00-2.58 5.84m2.699 2.7c-.103.021-.207.041-.311.06a15.09 15.09 0 01-2.448-2.448 14.9 14.9 0 01.06-.312M16.5 9a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z">
                                    <!-- SMIL animations for different phases -->
                                    <!-- 1. Initial glow (start) -->
                                    <animate id="anim-glow-initial" attributeName="opacity" values="0.9;1;0.9" dur="2s" repeatCount="indefinite" begin="indefinite" />
                                    
                                    <!-- 2. Network detection (big spark) -->
                                    <animate id="anim-big-spark" attributeName="opacity" values="0.8;1.2;0.8" dur="0.7s" repeatCount="1" begin="indefinite" />
                                    <animate id="anim-big-spark-flash" attributeName="stroke" values="currentColor;#f97316;currentColor" dur="0.7s" repeatCount="1" begin="indefinite" />
                                    
                                    <!-- 3. k3s installation (sparks continue) -->
                                    <animate id="anim-scanning" attributeName="opacity" values="0.9;1;0.9" dur="2s" repeatCount="indefinite" begin="indefinite" />
                                    <animateTransform id="anim-scale" attributeName="transform" type="scale" additive="sum" from="1 1" to="1.03 1.03" dur="2s" repeatCount="indefinite" begin="indefinite" />
                                    
                                    <!-- 4. Waiting for k3s (glow increases) -->
                                    <animate id="anim-glow-stronger" attributeName="opacity" values="0.9;1.1;0.9" dur="1.5s" repeatCount="indefinite" begin="indefinite" />
                                    <animate id="anim-glow-stronger-color" attributeName="stroke" values="currentColor;#a855f7;currentColor" dur="1.5s" repeatCount="indefinite" begin="indefinite" />
                                    
                                    <!-- 5. Tinkerbell installation (flicker begins) -->
                                    <animate id="anim-flicker" attributeName="opacity" values="0.9;1;0.8;1;0.9" dur="0.2s" repeatCount="indefinite" begin="indefinite" />
                                    
                                    <!-- 6. Dragonfly installation (faster flicker, pre-launch) -->
                                    <animate id="anim-fast-flicker" attributeName="opacity" values="0.8;1.1;0.7;1.2;0.8" dur="0.15s" repeatCount="indefinite" begin="indefinite" />
                                    
                                    <!-- 7. Installation complete (rocket fire) -->
                                    <animateTransform id="anim-fire" attributeName="transform" type="translate" additive="sum" from="0 0" to="0 -2" dur="0.3s" repeatCount="indefinite" begin="indefinite" />
                                </path>
                            </svg>
                        </div>
                        <p class="mt-4 text-gray-500 dark:text-gray-400">No machines discovered yet.</p>
                        <p class="mt-2 text-sm text-gray-500 dark:text-gray-500">Machines will appear here once they connect to Dragonfly.</p>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block styles %}
<style>
    /* Base styling */
    .rocket-svg {
        display: block;
        margin: 0 auto;
    }

    /* Direct animation classes applied to SVG */
    .rocket-svg.rocket-scanning {
        animation: scanning 2s infinite ease-in-out;
    }
    
    .rocket-svg.rocket-sparks {
        animation: sparks 0.6s infinite ease-in-out;
    }

    .rocket-svg.rocket-glowing {
        animation: glow 1.5s infinite ease-in-out;
    }

    .rocket-svg.rocket-flicker {
        animation: flicker 0.2s infinite linear;
    }
    
    .rocket-svg.rocket-fire {
        animation: fire 0.3s infinite ease-in-out;
    }
    
    .rocket-svg.rocket-shift {
        animation: fire 0.3s infinite ease-in-out, shift 0.4s ease-in-out;
    }
    
    .rocket-svg.rocket-error {
        filter: grayscale(0.8) drop-shadow(0 0 3px red);
        transform: rotate(-5deg) scale(0.95);
    }

    /* Simplified keyframes */
    @keyframes scanning {
        0% { transform: scale(1); }
        50% { transform: scale(1.03); }
        100% { transform: scale(1); }
    }

    @keyframes sparks {
        0% { transform: scale(1); }
        50% { transform: scale(1.05) rotate(2deg); }
        100% { transform: scale(1); }
    }

    @keyframes glow {
        0% { opacity: 0.9; }
        50% { opacity: 1; }
        100% { opacity: 0.9; }
    }

    @keyframes flicker {
        0% { opacity: 0.9; }
        25% { opacity: 1; }
        50% { opacity: 0.8; }
        75% { opacity: 1; }
        100% { opacity: 0.9; }
    }

    @keyframes fire {
        0% { transform: translateY(0); }
        50% { transform: translateY(-2px); }
        100% { transform: translateY(0); }
    }

    @keyframes shift {
        0% { transform: translateX(0); }
        25% { transform: translateX(-1px) rotate(-0.5deg); }
        75% { transform: translateX(1px) rotate(0.5deg); }
        100% { transform: translateX(0); }
    }
    
    /* Smoke animation setup */
    #installer-rocket.rocket-smoke {
        position: relative;
    }
    
    #installer-rocket.rocket-smoke::before, 
    #installer-rocket.rocket-smoke::after {
        content: '';
        position: absolute;
        bottom: -5px;
        left: 50%;
        width: 30px;
        height: 30px;
        background-color: rgba(128, 128, 128, 0.5);
        border-radius: 50%;
        filter: blur(8px);
        opacity: 0;
        animation: smokePuff 2.5s infinite ease-out;
        z-index: -1;
    }
    
    #installer-rocket.rocket-smoke::after {
        animation-delay: 0.8s; 
        width: 35px; 
        height: 35px;
        bottom: -8px;
        left: 55%;
    }
    
    @keyframes smokePuff {
        0% { transform: translate(-50%, 0) scale(0.5); opacity: 0; }
        50% { opacity: 0.3; }
        100% { transform: translate(-50%, -50px) scale(2); opacity: 0; }
    }
</style>
{% endblock %}

{% block scripts %}
    {# Conditionally include the correct script tag based on installation progress #}
    {% if installation_in_progress %}
    <script>
    // --- INSTALLER SCRIPT --- 
    (function() { // IIFE to scope variables
        console.log("Installation in progress, starting SSE listener...");
        // All possible rocket animation classes
        const rocketClasses = ['rocket-idle', 'rocket-scanning', 'rocket-sparks', 'rocket-glowing', 'rocket-smoke', 'rocket-flicker', 'rocket-fire', 'rocket-shift', 'rocket-error'];
        let evtSource = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 30; // Increased max attempts
        const initialReconnectDelay = 80; // Start with faster reconnect
        const maxReconnectDelay = 30000; // Cap at 30 seconds
        const backoffFactor = 1.5; // Exponential backoff multiplier
        let currentAnimationState = null; // Track current animation state
        let currentMessageState = null; // Track current message
        let reconnectTimer = null; // Track reconnect timer for cleanup

        // Function to update UI elements
        function updateUI(status) {
            if (!status) return;
            console.log("Updating UI with status:", status);

            // Get element references *inside* the update function
        const installerMessageEl = document.getElementById('installer-message');
        const installerRocketEl = document.getElementById('installer-rocket');
            const installerTitleEl = document.getElementById('installer-title');

            // Check if elements exist before trying to update
            if (installerMessageEl && status.message) {
                installerMessageEl.textContent = status.message;
                console.log("Updated message to:", status.message);
            }
            
            if (installerRocketEl && status.animation) {
                // Get direct reference to the SVG
                const svgEl = installerRocketEl.querySelector('svg');
                if (!svgEl) {
                    console.error("SVG element not found inside rocket container!");
                    return;
                }
                
                // Reset any inline styles from error state
                svgEl.style.filter = '';
                svgEl.style.transform = '';
                
                // Determine the phase based on the animation class
                let phase = 0;
                const animationClass = status.animation;
                
                // Test for each animation state in descending priority order
                if (animationClass.includes('rocket-fire')) {
                    phase = 7;
                } else if (animationClass.includes('rocket-flicker')) {
                    phase = 6;
                } else if (animationClass.includes('rocket-smoke')) {
                    phase = 5;
                } else if (animationClass.includes('rocket-k3s-ready') || 
                          (animationClass.includes('rocket-glowing') && 
                           document.getElementById('installer-message')?.textContent?.includes('waiting for k3s'))) {
                    phase = 4;
                } else if (animationClass.includes('rocket-sparks')) {
                    phase = 3;
                } else if (animationClass.includes('rocket-scanning')) {
                    phase = 2;
                } else if (animationClass.includes('rocket-glowing')) {
                    phase = 1;
                } else if (animationClass.includes('rocket-idle')) {
                    phase = 0;
                }
                
                console.log(`Current phase: ${phase}`);
                
                // Phase 7 (Ready) is special - we clear everything and show only the flame
                if (phase === 7) {
                    // Reset/stop all animations
                    const animations = svgEl.querySelectorAll('animate, animateTransform');
                    animations.forEach(anim => {
                        try {
                            anim.setAttribute('begin', 'indefinite');
                            if (anim.beginElement) anim.endElement();
                        } catch (e) {}
                    });
                    
                    // Hide all particle effects
                    [
                        '#spark-particles',
                        '#smoke-particles',
                        '#glow-effect'
                    ].forEach(selector => {
                        const el = svgEl.querySelector(selector);
                        if (el) el.setAttribute('opacity', '0');
                    });
                    
                    // Only show flame with explicit color overrides
                    const flameElement = svgEl.querySelector('#rocket-flame');
                    if (flameElement) {
                        flameElement.setAttribute('opacity', '1');
                        flameElement.setAttribute('stroke', 'none');
                        flameElement.style.stroke = 'none';
                        
                        // Explicit coloring for the flame paths
                        const flamePath = flameElement.querySelector('path:nth-child(1)');
                        const flameCorePath = flameElement.querySelector('path:nth-child(2)');
                        
                        if (flamePath) {
                            flamePath.setAttribute('fill', 'url(#flame-gradient)');
                            flamePath.setAttribute('stroke', 'none');
                            flamePath.style.fill = 'url(#flame-gradient)';
                            flamePath.style.stroke = 'none';
                        }
                        
                        if (flameCorePath) {
                            flameCorePath.setAttribute('fill', 'url(#flame-core-gradient)');
                            flameCorePath.setAttribute('stroke', 'none');
                            flameCorePath.style.fill = 'url(#flame-core-gradient)';
                            flameCorePath.style.stroke = 'none';
                        }
                        
                        startAnimations(svgEl, ['flame-flicker', 'flame-core-flicker']);
                    }
                    
                    console.log("Applied phase 7 (Ready) animation: flame only with color overrides");
                    return;
                }
                
                // For error state, just apply the error styling and exit
                if (animationClass.includes('rocket-error')) {
                    svgEl.style.filter = 'grayscale(0.8) drop-shadow(0 0 3px red)';
                    svgEl.style.transform = 'rotate(-5deg) scale(0.95)';
                    console.log("Applied error state styling");
                    return;
                }
                
                // Now apply animations based on the current phase - CUMULATIVE
                
                // Phase 1+ animations: Initial glow
                if (phase >= 1) {
                    const glowEffect = svgEl.querySelector('#glow-effect');
                    if (glowEffect) {
                        glowEffect.setAttribute('opacity', '1');
                        startAnimations(svgEl, ['glow-pulse', 'glow-opacity', 'glow-pulse-outer', 'glow-opacity-outer']);
                    }
                }
                
                // Phase 2 animations: Network detection (big spark)
                if (phase === 2) {
                    // Use the big-spark-circle instead of just changing the rocket color
                    const bigSparkCircle = svgEl.querySelector('#big-spark-circle');
                    const bigSparkAppear = svgEl.querySelector('#big-spark-appear');
                    const bigSparkOpacity = svgEl.querySelector('#big-spark-opacity');
                    
                    if (bigSparkCircle && bigSparkAppear && bigSparkOpacity) {
                        try {
                            bigSparkAppear.beginElement();
                            bigSparkOpacity.beginElement();
                        } catch (e) {
                            console.warn("Error starting big spark animation:", e);
                        }
                    } else {
                        console.warn("Big spark elements not found");
                    }
                }
                
                // Phase 3+ animations: K3s installation (sparks)
                if (phase >= 3) {
                    const sparkParticles = svgEl.querySelector('#spark-particles');
                    if (sparkParticles) {
                        sparkParticles.setAttribute('opacity', '1');
                        startSparkCycle(svgEl);
                    }
                }
                
                // Phase 4+ animations: Waiting for k3s (stronger glow)
                if (phase >= 4) {
                    startAnimations(svgEl, ['anim-glow-stronger', 'anim-glow-stronger-color']);
                }
                
                // Phase 5+ animations: Tinkerbell installation (smoke)
                if (phase >= 5) {
                    startSmokeTrails(svgEl);
                }
                
                // Phase 6+ animations: Dragonfly installation (flicker)
                if (phase >= 6) {
                    startAnimations(svgEl, ['anim-flicker']);
                }
                
                console.log(`Applied animations up to phase ${phase}`);
            }
            
            // Handle installation complete state
            if (status.animation?.includes('rocket-fire')) {
                if (installerTitleEl) installerTitleEl.textContent = "Installation Complete!";
                console.log("Installation complete. Reloading...");
                if (evtSource) evtSource.close();
                setTimeout(() => { window.location.reload(); }, 3000);
            }
        }

        function connectInstallEvents() {
            if (evtSource) { 
                evtSource.close();
            }
            
            if (reconnectTimer) {
                clearTimeout(reconnectTimer);
                reconnectTimer = null;
            }
            
            console.log(`Connecting to install SSE (attempt ${reconnectAttempts + 1})...`);
            // ENSURE THIS IS THE CORRECT ENDPOINT
            evtSource = new EventSource('/api/events'); 

            evtSource.onopen = function() {
                console.log("Install SSE connection opened successfully.");
                reconnectAttempts = 0; // Reset attempts on successful connection
            };

            evtSource.addEventListener('error', (e) => {
                console.warn("Install SSE connection error, will reconnect...", e);
                evtSource.close();
                
                // Calculate delay using exponential backoff
                const delay = Math.min(
                    initialReconnectDelay * Math.pow(backoffFactor, reconnectAttempts),
                    maxReconnectDelay
                );
                
                // Save state but don't show reconnection in UI
                if (reconnectAttempts === 0) {
                    const installerMessageEl = document.getElementById('installer-message');
                    if (installerMessageEl) {
                        // Save current message without changing it
                        currentMessageState = installerMessageEl.textContent;
                    }
                    
                    // Don't change the rocket animation - keep current state
                    console.log("Connection lost, silently attempting reconnection...");
                }
                
                reconnectAttempts++;
                console.log(`Attempting SSE reconnect in ${Math.round(delay / 1000)}s (attempt ${reconnectAttempts}/${maxReconnectAttempts})`);
                
                // Try to reconnect with exponential backoff
                reconnectTimer = setTimeout(connectInstallEvents, delay);
                
                // Only show error after many failed attempts
                if (reconnectAttempts >= maxReconnectAttempts) {
                    console.error("Max SSE reconnect attempts reached. Giving up.");
                    const installerMessageEl = document.getElementById('installer-message');
                    const installerRocketEl = document.getElementById('installer-rocket');
                    
                    if (installerMessageEl) {
                        installerMessageEl.textContent = "Connection lost. Please refresh the page.";
                    }
                    
                    if (installerRocketEl) {
                        // Save current animation state before changing to error
                        currentAnimationState = installerRocketEl.className;
                        installerRocketEl.className = 'mb-6 rocket-error';
                    }
                }
            });

            evtSource.addEventListener('install_status', function(event) {
                try {
                    const statusUpdate = JSON.parse(event.data);
                    console.log("Received 'install_status' SSE event:", statusUpdate);
                    
                    // Save current state for potential reconnects
                    if (statusUpdate.animation) {
                        currentAnimationState = statusUpdate.animation;
                    }
                    if (statusUpdate.message) {
                        currentMessageState = statusUpdate.message;
                    }
                    
                    // Apply animation and update message
                    updateUI(statusUpdate);
                } catch (e) { 
                    console.error("SSE JSON parse error:", e, "Raw data:", event.data); 
                }
            });
            
            // Add handler for browser_redirect event
            evtSource.addEventListener('browser_redirect', function(e) {
                console.log("Received browser_redirect event:", e.data);
                try {
                    const data = JSON.parse(e.data);
                    console.log("Redirect target:", data.url);
                    
                    // Show a message about the redirect
                    const installerMessageEl = document.getElementById('installer-message');
                    if (installerMessageEl) {
                        installerMessageEl.textContent = 
                            `Installation complete! Redirecting to Dragonfly in ${data.countdown || 1} second...`;
                    }
                    
                    // After the countdown, redirect the browser
                    setTimeout(() => {
                        console.log("Redirecting to:", data.url);
                        window.location.href = data.url;
                    }, (data.countdown || 1) * 1000);
                    
                    // Close the SSE connection
                    evtSource.close();
                } catch (err) {
                    console.error("Error handling redirect event:", err);
                }
            });
        }
        
        // Connect immediately, don't wait for DOMContentLoaded
        connectInstallEvents();
        
        // ADDED: Initialize animations based on initial class when page loads
        document.addEventListener('DOMContentLoaded', () => {
            const installerRocketEl = document.getElementById('installer-rocket');
            if (installerRocketEl) {
                const initialClass = installerRocketEl.className.replace('mb-6', '').trim();
                console.log("Initial rocket class:", initialClass);
                
                // If we have an initial animation class, trigger the corresponding phase
                if (initialClass) {
                    // Map classes to phases and initialize animations
                    let phase = 0;
                    if (initialClass.includes('rocket-idle')) {
                        phase = 0;
                    } else if (initialClass.includes('rocket-glowing') && !document.getElementById('installer-message')?.textContent?.includes('waiting for k3s')) {
                        phase = 1;
                    } else if (initialClass.includes('rocket-scanning')) {
                        phase = 2;
                    } else if (initialClass.includes('rocket-sparks')) {
                        phase = 3;
                    } else if (initialClass.includes('rocket-glowing') && document.getElementById('installer-message')?.textContent?.includes('waiting for k3s')) {
                        phase = 4;
                    } else if (initialClass.includes('rocket-smoke')) {
                        phase = 5;
                    } else if (initialClass.includes('rocket-flicker')) {
                        phase = 6;
                    } else if (initialClass.includes('rocket-fire')) {
                        phase = 7;
                    }
                    
                    console.log("Initializing animations for phase:", phase);
                    
                    // Use the existing testRocketAnimation function to initialize the phase
                    if (window.testRocketAnimation) {
                        window.testRocketAnimation(initialClass);
                    }
                }
            }
        });
        
        // Helper function to create repeating smoke trails
        function startSmokeTrails(svgElement) {
            // Make smoke particles group visible
            const smokeParticles = svgElement.querySelector('#smoke-particles');
            if (!smokeParticles) {
                console.warn("Smoke particles group not found");
                return;
            }
            
            smokeParticles.setAttribute('opacity', '1');
            
            const startSmoke = (num, delay) => {
                setTimeout(() => {
                    const appear = svgElement.querySelector(`#smoke${num}-appear`);
                    const fade = svgElement.querySelector(`#smoke${num}-fade`);
                    const move = svgElement.querySelector(`#smoke${num}-move`);
                    const grow = svgElement.querySelector(`#smoke${num}-grow`);
                    
                    if (appear && fade && move && grow) {
                        try {
                            // Start the smoke animation sequence
                            appear.beginElement();
                            move.beginElement();
                            grow.beginElement();
                            
                            // Start fade after a short delay
                            setTimeout(() => {
                                fade.beginElement();
                            }, 300);
                            
                            // Schedule the next smoke puff
                            setTimeout(() => {
                                const circle = svgElement.querySelector(`#smoke${num}`);
                                if (circle) {
                                    // Random delay for next smoke puff
                                    startSmoke(num, 1000 + Math.random() * 1000);
                                }
                            }, 2200); // After animation completes
                        } catch (e) {
                            console.warn(`Error animating smoke ${num}:`, e);
                        }
                    } else {
                        console.warn(`Missing smoke animation elements for smoke${num}`);
                    }
                }, delay);
            };
            
            // Start smoke trails with staggered delays
            startSmoke(1, 200);
            startSmoke(2, 800);
        }
        
        // Add manual test function accessible from console
        window.testRocketAnimation = function(animationClass) {
            // Support space-separated classes
            const classesToCheck = animationClass.split(' ');
            let validClass = false;
            
            // Check if any of the classes is a valid rocket class
            for (const classToCheck of classesToCheck) {
                if (rocketClasses.includes(classToCheck) || classToCheck === 'reset') {
                    validClass = true;
                    break;
                }
            }
            
            if (!validClass) {
                console.warn(`Unknown animation class: ${animationClass}. Available classes:`, rocketClasses);
                return;
            }
            
            const rocketEl = document.getElementById('installer-rocket');
            if (!rocketEl) {
                console.error("Rocket element not found!");
                return;
            }
            
            // Direct reference to the SVG
            const svgEl = rocketEl.querySelector('svg');
            if (!svgEl) {
                console.error("SVG element not found inside rocket!");
                return;
            }
            
            // Reset everything first
            // Pause all animations
            const allAnimations = svgEl.querySelectorAll('animate, animateTransform');
            allAnimations.forEach(anim => {
                try {
                    anim.setAttribute('begin', 'indefinite');
                    if (anim.beginElement) anim.endElement();
                } catch (e) {
                    console.warn("Error stopping animation:", e);
                }
            });
            
            // Get references to all particle groups upfront
            const sparkParticles = svgEl.querySelector('#spark-particles');
            const smokeParticles = svgEl.querySelector('#smoke-particles');
            const glowEffect = svgEl.querySelector('#glow-effect');
            const flameElement = svgEl.querySelector('#rocket-flame');
            
            // Reset any particles and effects
            if (sparkParticles) sparkParticles.setAttribute('opacity', '0');
            if (smokeParticles) smokeParticles.setAttribute('opacity', '0');
            if (glowEffect) glowEffect.setAttribute('opacity', '0');
            if (flameElement) flameElement.setAttribute('opacity', '0');
            
            // Reset any inline styles
            svgEl.style.filter = '';
            svgEl.style.transform = '';
            
            if (animationClass === 'reset') {
                console.log("Reset all animations");
                return;
            }
            
            console.log("Starting animation:", animationClass);
            
            // Determine the phase based on the animation class
            let phase = 0;
            
            // Test for each animation state in descending priority order
            if (animationClass.includes('rocket-fire')) {
                phase = 7;
            } else if (animationClass.includes('rocket-flicker')) {
                phase = 6;
            } else if (animationClass.includes('rocket-smoke')) {
                phase = 5;
            } else if (animationClass.includes('rocket-k3s-ready') || 
                      (animationClass.includes('rocket-glowing') && 
                       document.getElementById('installer-message')?.textContent?.includes('waiting for k3s'))) {
                phase = 4;
            } else if (animationClass.includes('rocket-sparks')) {
                phase = 3;
            } else if (animationClass.includes('rocket-scanning')) {
                phase = 2;
            } else if (animationClass.includes('rocket-glowing')) {
                phase = 1;
            } else if (animationClass.includes('rocket-idle')) {
                phase = 0;
            }
            
            console.log(`Test animation phase: ${phase}`);
            
            // Special handling for phase 7 (ready) and error states
            if (phase === 7) {
                // Phase 7: Only show flame, no other animations
                if (flameElement) {
                    flameElement.setAttribute('opacity', '1');
                    
                    // Make sure the paths have the correct fill applied
                    const flamePath = flameElement.querySelector('path:first-child');
                    const flameCorePath = flameElement.querySelector('path:last-child');
                    
                    if (flamePath) {
                        flamePath.setAttribute('fill', 'url(#flame-gradient)');
                    }
                    
                    if (flameCorePath) {
                        flameCorePath.setAttribute('fill', 'url(#flame-core-gradient)');
                    }
                    
                    startAnimations(svgEl, ['flame-flicker', 'flame-core-flicker']);
                }
                console.log("Applied phase 7 (Ready) animation: flame only");
                return;
            }
            
            if (animationClass === 'rocket-error') {
                // Error state
                svgEl.style.filter = 'grayscale(0.8) drop-shadow(0 0 3px red)';
                svgEl.style.transform = 'rotate(-5deg) scale(0.95)';
                console.log("Applied error state");
                return;
            }
            
            // Apply animations CUMULATIVELY based on phase
            
            // Phase 1+: Glow
            if (phase >= 1) {
                if (glowEffect) {
                    glowEffect.setAttribute('opacity', '1');
                    startAnimations(svgEl, ['glow-pulse', 'glow-opacity', 'glow-pulse-outer', 'glow-opacity-outer']);
                }
            }
            
            // Phase 2: Big spark
            if (phase === 2) {
                // Use the big-spark-circle instead of just changing the rocket color
                const bigSparkCircle = svgEl.querySelector('#big-spark-circle');
                const bigSparkAppear = svgEl.querySelector('#big-spark-appear');
                const bigSparkOpacity = svgEl.querySelector('#big-spark-opacity');
                
                if (bigSparkCircle && bigSparkAppear && bigSparkOpacity) {
                    try {
                        bigSparkAppear.beginElement();
                        bigSparkOpacity.beginElement();
                    } catch (e) {
                        console.warn("Error starting big spark animation:", e);
                    }
                } else {
                    console.warn("Big spark elements not found");
                }
            }
            
            // Phase 3+: Sparks
            if (phase >= 3) {
                if (sparkParticles) {
                    sparkParticles.setAttribute('opacity', '1');
                    startSparkCycle(svgEl);
                }
            }
            
            // Phase 4+: Stronger glow
            if (phase >= 4) {
                startAnimations(svgEl, ['anim-glow-stronger', 'anim-glow-stronger-color']);
            }
            
            // Phase 5+: Smoke
            if (phase >= 5) {
                startSmokeTrails(svgEl);
            }
            
            // Phase 6+: Flicker
            if (phase >= 6) {
                startAnimations(svgEl, ['anim-flicker']);
            }
            
            console.log(`Applied cumulative animations up to phase ${phase}`);
        };
        
        // Helper function to start SMIL animations by ID
        function startAnimations(svgElement, animationIds) {
            animationIds.forEach(id => {
                const anim = svgElement.querySelector('#' + id);
                if (anim) {
                    try {
                        // Set to start immediately 
                        anim.setAttribute('begin', '0s');
                        // Use beginElement if available (more reliable)
                        if (anim.beginElement) anim.beginElement();
                        console.log(`Started animation: ${id}`);
                    } catch (e) {
                        console.warn(`Error starting animation ${id}:`, e);
                    }
                } else {
                    console.warn(`Animation element #${id} not found`);
                }
            });
            
            // Special handling for the big spark animation
            if (animationIds.includes('anim-big-spark')) {
                const bigSparkCircle = svgElement.querySelector('#big-spark-circle');
                const bigSparkAppear = svgElement.querySelector('#big-spark-appear');
                const bigSparkOpacity = svgElement.querySelector('#big-spark-opacity');
                
                if (bigSparkCircle && bigSparkAppear && bigSparkOpacity) {
                    try {
                        bigSparkAppear.beginElement();
                        bigSparkOpacity.beginElement();
                    } catch (e) {
                        console.warn("Error starting big spark animation:", e);
                    }
                }
            }
            
            // Special handling for spark particles
            if (animationIds.includes('anim-sparks')) {
                const sparkParticles = svgElement.querySelector('#spark-particles');
                if (sparkParticles) {
                    sparkParticles.setAttribute('opacity', '1');
                    
                    // Start repeating spark animations
                    startSparkCycle(svgElement);
                } else {
                    console.warn('Spark particles group not found');
                }
            }
        }
        
        // Function to create repeating spark cycle
        function startSparkCycle(svgElement) {
            // Make spark particles group visible
            const sparkParticles = svgElement.querySelector('#spark-particles');
            if (sparkParticles) {
                sparkParticles.setAttribute('opacity', '1');
            }
            
            const startSpark = (num, delay) => {
                setTimeout(() => {
                    const appear = svgElement.querySelector(`#spark${num}-appear`);
                    const fade = svgElement.querySelector(`#spark${num}-fade`);
                    const move = svgElement.querySelector(`#spark${num}-move`);
                    
                    if (appear && fade && move) {
                        try {
                            appear.beginElement();
                            move.beginElement();
                            
                            // Start fade after a shorter delay for more realistic spark effect
                            setTimeout(() => {
                                fade.beginElement();
                            }, 100 + Math.random() * 100); // Variable fade timing (100-200ms)
                            
                            // Recursively schedule the next animation of this particle with variable timing
                            setTimeout(() => {
                                // Reset position for next animation
                                const circle = svgElement.querySelector(`#spark${num}`);
                                if (circle) {
                                    // Different timing for different spark types
                                    let nextDelay = 0;
                                    if (num <= 2) { // Main sparks more frequently
                                        nextDelay = 300 + Math.random() * 400; 
                                    } else if (num <= 6) { // Secondary sparks less frequently
                                        nextDelay = 500 + Math.random() * 600;
                                    } else { // Occasional center sparks
                                        nextDelay = 800 + Math.random() * 1000;
                                    }
                                    startSpark(num, nextDelay);
                                }
                            }, 600 + Math.random() * 200); // Complete cycle between 600-800ms
                        } catch (e) {
                            console.warn(`Error animating spark ${num}:`, e);
                        }
                    }
                }, delay);
            };
            
            // Start sparks with staggered delays for a more natural effect
            // Left side sparks
            startSpark(1, 100);
            startSpark(2, 250);
            startSpark(3, 400);
            
            // Right side sparks
            startSpark(4, 150);
            startSpark(5, 300);
            startSpark(6, 350);
            
            // Center sparks
            startSpark(7, 200);
            startSpark(8, 500);
        }
        
        window.addEventListener('beforeunload', () => { 
            if (evtSource) evtSource.close(); 
            if (reconnectTimer) clearTimeout(reconnectTimer);
        });
    })(); // End IIFE
    </script>
    {% else %}
    <script>
    // --- REGULAR DASHBOARD SCRIPT --- 
    document.addEventListener('DOMContentLoaded', () => {
        console.log("Not in installation mode, running regular dashboard JS.");
        // Add regular dashboard JS here...
        
        // Charting code (commented out)
        /* 
        const deploymentCtx = document.getElementById('deploymentChart');
        if (deploymentCtx) { 
            // ... rest of chart code ...
        } 
        */
    });
    // Add other non-DOMContentLoaded dashboard logic here if needed
    </script>
    {% endif %}

    <!-- This setup is only needed when we're in installation server mode -->
    {% if is_installation_server %}
    <script>
        let evtSource;
        let initialized = false;
        
        function initializeInstallEvents() {
            if (initialized) return;
            initialized = true;
            
            console.log("Initializing installation event listener");
            evtSource = new EventSource('/api/events');
            
            evtSource.addEventListener('install_status', function(e) {
                console.log("Received install_status event:", e.data);
                try {
                    const data = JSON.parse(e.data);
                    console.log("Parsed data:", data);
                    
                    // Update the message
                    if (data.message) {
                        document.getElementById("installer-message").textContent = data.message;
                    }
                    
                    // Update the animation class if provided
                    if (data.animation) {
                        const rocketEl = document.getElementById("installer-rocket");
                        
                        if (rocketEl) {
                            // Remove all existing animation classes
                            rocketEl.classList.remove(
                                "rocket-idle", "rocket-scanning", "rocket-sparks", 
                                "rocket-glowing", "rocket-smoke", "rocket-flicker", 
                                "rocket-fire", "rocket-shift", "rocket-error"
                            );
                            
                            // Add the new animation class(es)
                            data.animation.split(" ").forEach(cls => {
                                rocketEl.classList.add(cls);
                            });
                        }
                    }
                } catch (err) {
                    console.error("Error handling install status event:", err);
                }
            });
            
            // Add handler for browser_redirect event
            evtSource.addEventListener('browser_redirect', function(e) {
                console.log("Received browser_redirect event:", e.data);
                try {
                    const data = JSON.parse(e.data);
                    console.log("Redirect target:", data.url);
                    
                    // Show a message about the redirect
                    document.querySelector("#installer-message").textContent = 
                        `Installation complete! Redirecting to Dragonfly in ${data.countdown || 1} second...`;
                    
                    // After the countdown, redirect the browser
                    setTimeout(() => {
                        console.log("Redirecting to:", data.url);
                        window.location.href = data.url;
                    }, (data.countdown || 1) * 1000);
                    
                    // Close the SSE connection
                    evtSource.close();
                } catch (err) {
                    console.error("Error handling redirect event:", err);
                }
            });
            
            evtSource.onerror = function(err) {
                console.error("EventSource error:", err);
            };
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initializeInstallEvents);
    </script>
    {% endif %}
{% endblock %} 