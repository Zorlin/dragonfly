{% extends "base.html" %}

{% block title %}Dragonfly - Dashboard{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <h2 class="text-lg font-medium text-purple-600 dark:text-purple-400 uppercase tracking-wider mb-6">Welcome to Dragonfly.</h2>

    {# Conditional display: Installer or Regular Dashboard #}
    {% if installation_in_progress %}
    
    <!-- Installation Progress Section -->
    <div class="mb-8">
        <div class="flex justify-between items-center mb-4">
            <h2 id="installer-title" class="text-lg font-medium text-gray-900 dark:text-gray-200 uppercase tracking-wider">Installation</h2>
             {# Hide "View all machines" during install #}
        </div>
        <div id="installer-status-box" class="bg-white dark:bg-[#0A0B10] shadow-lg rounded-lg overflow-hidden border border-purple-500 dark:border-purple-700">
             <div class="px-6 py-16"> {# Increased padding for focus #}
                 <div class="text-center">
                     <div id="installer-rocket" class="mb-6 {{ initial_animation_class }}">
                         <svg class="mx-auto h-16 w-16 text-gray-500 rocket-svg" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.59 14.37a6 6 0 01-5.84 7.38v-4.8m5.84-2.58a14.98 14.98 0 006.16-12.12A14.98 14.98 0 009.631 8.41m5.96 5.96a14.926 14.926 0 01-5.841 2.58m-.119-8.54a6 6 0 00-7.381 5.84h4.8m2.581-5.84a14.927 14.927 0 00-2.58 5.84m2.699 2.7c-.103.021-.207.041-.311.06a15.09 15.09 0 01-2.448-2.448 14.9 14.9 0 01.06-.312M16.5 9a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"></path>
                         </svg>
                     </div>
                     <p id="installer-message" class="mt-4 text-gray-500 dark:text-gray-300">{{ initial_install_message }}</p>
                 </div>
             </div>
        </div>
    </div>
    
    {% else %}

    <!-- Recent Machines Section (Regular View) -->
    <div class="mb-8">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-medium text-gray-900 dark:text-gray-200 uppercase tracking-wider">Recent Machines</h2>
            <a href="/machines" class="text-sm font-medium text-indigo-400 hover:text-indigo-300 flex items-center">
                <span>View all machines</span>
                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </a>
        </div>
        <div id="machine-list" class="bg-white dark:bg-[#0A0B10] shadow-lg rounded-lg overflow-hidden border border-purple-500 dark:border-purple-700">
            <ul class="divide-y divide-gray-800 dark:divide-gray-700">
                {% for machine in machines %}
                <li class="hover:bg-gray-50 dark:hover:bg-gray-750 cursor-pointer transition-colors duration-150" onclick="window.location='/machines/{{ machine.id }}'">
                    <div class="px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-indigo-400 truncate flex items-center">
                                    {% if machine.hostname %}
                                        <span class="mr-2">{{ machine.hostname }}</span>
                                    {% else %}
                                        <span class="tech-mono mr-2">{{ machine.id }}</span>
                                    {% endif %}
                                    
                                    {% if machine.memorable_name %}
                                        <span class="text-xs text-gray-500 dark:text-gray-400 italic">
                                            ({{ machine.memorable_name }})
                                        </span>
                                    {% endif %}
                                </p>
                            </div>
                            <div class="ml-2 flex-shrink-0 flex">
                                <p class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                    {% if machine.status|string == "Ready" %}
                                        bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200
                                    {% elif machine.status|string == "InstallingOS" %}
                                        bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200
                                    {% elif machine.status|string == "ReadyForAdoption" %}
                                        bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200
                                    {% else %}
                                        bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200
                                    {% endif %}">
                                    {{ machine.status }}
                                </p>
                            </div>
                        </div>
                        <div class="mt-2 flex flex-col sm:flex-row sm:justify-between text-xs">
                            <div class="flex flex-col sm:flex-row sm:space-x-4">
                                <p class="flex items-center text-gray-500 dark:text-gray-400">
                                    <span class="font-medium mr-1">MAC:</span>
                                    <span class="tech-mono">{{ machine.mac_address }}</span>
                                </p>
                                <p class="flex items-center text-gray-500 dark:text-gray-400 mt-1 sm:mt-0">
                                    <span class="font-medium mr-1">IP:</span>
                                    <span class="tech-mono">{{ machine.ip_address }}</span>
                                </p>
                            </div>
                            <p class="flex items-center text-gray-500 dark:text-gray-400 mt-1 sm:mt-0">
                                <span class="font-medium mr-1">Registered:</span>
                                <span class="tech-mono">{{ machine.created_at|string }}</span>
                            </p>
                        </div>
                    </div>
                </li>
                {% else %}
                <li class="px-6 py-16"> {# Increased padding #}
                    <div class="text-center">
                        <div class="mb-6">
                            <svg class="mx-auto h-16 w-16 text-gray-500 rocket-svg" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.59 14.37a6 6 0 01-5.84 7.38v-4.8m5.84-2.58a14.98 14.98 0 006.16-12.12A14.98 14.98 0 009.631 8.41m5.96 5.96a14.926 14.926 0 01-5.841 2.58m-.119-8.54a6 6 0 00-7.381 5.84h4.8m2.581-5.84a14.927 14.927 0 00-2.58 5.84m2.699 2.7c-.103.021-.207.041-.311.06a15.09 15.09 0 01-2.448-2.448 14.9 14.9 0 01.06-.312M16.5 9a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"></path>
                            </svg>
                        </div>
                        <p class="mt-4 text-gray-500 dark:text-gray-400">No machines discovered yet.</p>
                        <p class="mt-2 text-sm text-gray-500 dark:text-gray-500">Machines will appear here once they connect to Dragonfly.</p>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block styles %}
<style>
    .rocket-svg {
        /* Base styles if needed */
        /* Remove base transition to avoid potential conflict with animation */
        /* transition: transform 0.3s ease-out, filter 0.3s ease-out; */ 
    }

    @keyframes scanning { /* Animation for DetectingNetwork */
        0%, 100% { 
            transform: scale(1); 
            filter: drop-shadow(0 0 3px #a855f7); /* Purple glow */
        }
        50% { 
            transform: scale(1.03);
            filter: drop-shadow(0 0 6px #ec4899); /* Pinkish glow */
        }
    }
    .rocket-scanning .rocket-svg {
        animation: scanning 2s infinite ease-in-out;
    }

    @keyframes sparks {
        0% { box-shadow: 0 0 0px gold, 0 5px 0px gold; opacity: 1; transform: scale(1); }
        50% { box-shadow: 5px -5px 2px orange, -5px 5px 2px yellow, 0 10px 5px gold; opacity: 0.8; transform: scale(1.05) rotate(2deg); }
        100% { box-shadow: 0 0 0px gold, 0 5px 0px gold; opacity: 1; transform: scale(1); }
    }
    .rocket-sparks .rocket-svg {
        animation: sparks 0.6s infinite ease-in-out;
    }

    @keyframes glow {
        0% { filter: drop-shadow(0 0 2px #fff) drop-shadow(0 0 5px #a855f7); }
        50% { filter: drop-shadow(0 0 5px #fff) drop-shadow(0 0 15px #a855f7); }
        100% { filter: drop-shadow(0 0 2px #fff) drop-shadow(0 0 5px #a855f7); }
    }
    .rocket-glowing .rocket-svg {
        animation: glow 1.5s infinite ease-in-out;
    }

    @keyframes smokePuff { /* Renamed from smoke for clarity */
        0% { transform: translate(-50%, 0) scale(0.5); opacity: 0; }
        50% { opacity: 0.3; }
        100% { transform: translate(-50%, -50px) scale(2); opacity: 0; }
    }
    /* Add a container for smoke puffs - TARGET THE DIV DIRECTLY */
    #installer-rocket.rocket-smoke {
        position: relative; /* Needed for ::after positioning */
    }
     /* Add multiple smoke puffs with delays - TARGET THE DIV DIRECTLY */
    #installer-rocket.rocket-smoke::before, 
    #installer-rocket.rocket-smoke::after {
        content: '';
        position: absolute;
        bottom: -5px; /* Start near the base */
        left: 50%;
        width: 30px;
        height: 30px;
        background-color: rgba(128, 128, 128, 0.5); /* Semi-transparent gray */
        border-radius: 50%;
        filter: blur(8px);
        opacity: 0;
        /* Use the renamed keyframes */
        animation: smokePuff 2.5s infinite ease-out;
    }
    #installer-rocket.rocket-smoke::after {
        animation-delay: 0.8s; /* Stagger the second puff */
        width: 35px; 
        height: 35px;
        bottom: -8px;
        left: 55%; /* Slightly offset */
    }

    @keyframes flicker { /* Engine flicker */
        0%, 100% { filter: drop-shadow(0 3px 3px orange); }
        25% { filter: drop-shadow(0 5px 5px orangered); }
        50% { filter: drop-shadow(0 2px 2px yellow); }
        75% { filter: drop-shadow(0 4px 4px orange); }
    }
    .rocket-flicker .rocket-svg {
         animation: flicker 0.2s infinite linear;
    }

    @keyframes fire { /* Main engine fire */
        0%   { filter: drop-shadow(0 8px 6px orangered); transform: translateY(0); }
        50%  { filter: drop-shadow(0 15px 10px red); transform: translateY(-2px); }
        100% { filter: drop-shadow(0 8px 6px orangered); transform: translateY(0); }
    }
    .rocket-fire .rocket-svg {
        animation: fire 0.3s infinite ease-in-out;
    }
    @keyframes shift { /* Rocket body momentum shift */
         0%, 100% { transform: translateX(0) rotate(0); }
         25% { transform: translateX(-1px) rotate(-0.5deg); }
         75% { transform: translateX(1px) rotate(0.5deg); }
    }
    .rocket-shift .rocket-svg {
        /* Apply shift animation alongside fire */
        animation: fire 0.3s infinite ease-in-out, shift 0.4s ease-in-out;
    }
    
    .rocket-error .rocket-svg {
        filter: grayscale(0.8) drop-shadow(0 0 3px red);
        transform: rotate(-5deg) scale(0.95);
    }
    /* Default state */
    .rocket-idle .rocket-svg {
         /* Add a subtle idle animation if desired, e.g., slight bob */
         /* animation: bob 3s infinite ease-in-out; */
    }
    /* @keyframes bob { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-2px); } } */

</style>
{% endblock %}

{% block scripts %}
    {# Conditionally include the correct script tag based on installation progress #}
    {% if installation_in_progress %}
    <script>
    // --- INSTALLER SCRIPT --- 
    (function() { // IIFE to scope variables
        console.log("Installation in progress, starting SSE listener...");
        const rocketClasses = ['rocket-idle', 'rocket-scanning', 'rocket-sparks', 'rocket-glowing', 'rocket-smoke', 'rocket-flicker', 'rocket-fire', 'rocket-shift', 'rocket-error'];
        let evtSource = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        const reconnectDelay = 2000; // ms

        // Function to update UI elements
        function updateUI(status) {
            if (!status) return;

            // Get element references *inside* the update function
            const installerMessageEl = document.getElementById('installer-message');
            const installerRocketEl = document.getElementById('installer-rocket');
            const installerTitleEl = document.getElementById('installer-title');

            // Check if elements exist before trying to update
            if (installerMessageEl && status.message) {
                installerMessageEl.textContent = status.message;
            }
            if (installerRocketEl && status.animation) {
                // Remove all known animation classes first
                installerRocketEl.classList.remove(...rocketClasses);
                // Ensure mb-6 is present if it got removed (it shouldn't be if only removing rocketClasses)
                if (!installerRocketEl.classList.contains('mb-6')) {
                    installerRocketEl.classList.add('mb-6');
                }
                // Add the new animation class(es)
                status.animation.split(' ').forEach(cls => { 
                    if (cls) installerRocketEl.classList.add(cls); 
                });
            }
            if (status.animation?.includes('rocket-fire')) {
                if(installerTitleEl) installerTitleEl.textContent = "Installation Complete!";
                console.log("Installation complete. Reloading...");
                if (evtSource) evtSource.close();
                setTimeout(() => { window.location.reload(); }, 3000);
            }
        }

        function connectInstallEvents() {
            if (evtSource) { evtSource.close(); }
            console.log("Connecting to install SSE...");
            // ENSURE THIS IS THE CORRECT ENDPOINT
            evtSource = new EventSource('/api/install-events'); 
            reconnectAttempts = 0; // Reset attempts on successful connection try

            evtSource.onopen = function() {
                console.log("Install SSE connection opened.");
                reconnectAttempts = 0;
            };

            evtSource.addEventListener('error', (e) => {
                console.error("Install SSE error:", e);
                evtSource.close();
                reconnectAttempts++;
                if (reconnectAttempts < maxReconnectAttempts) {
                    const delay = Math.min(reconnectDelay, 30000);
                    console.log(`Attempting SSE reconnect in ${Math.round(delay / 1000)}s`);
                    setTimeout(connectInstallEvents, delay);
                } else {
                    console.error("Max SSE reconnect attempts reached.");
                    if (installerMessageEl) installerMessageEl.textContent = "Lost connection. Check terminal.";
                    if (installerRocketEl) installerRocketEl.className = 'mb-6 rocket-error';
                }
            });

            evtSource.addEventListener('install_status', function(event) {
                try {
                    const statusUpdate = JSON.parse(event.data);
                    console.log("Received 'install_status' SSE event:", statusUpdate);
                    updateUI(statusUpdate);
                } catch (e) { console.error("SSE JSON parse error:", e, "Raw data:", event.data); }
            });
        }
        
        // Connect immediately, don't wait for DOMContentLoaded
        connectInstallEvents();
        window.addEventListener('beforeunload', () => { if (evtSource) evtSource.close(); });
    })(); // End IIFE
    </script>
    {% else %}
    <script>
    // --- REGULAR DASHBOARD SCRIPT --- 
    document.addEventListener('DOMContentLoaded', () => {
        console.log("Not in installation mode, running regular dashboard JS.");
        // Add regular dashboard JS here...
        
        // Charting code (commented out)
        /* 
        const deploymentCtx = document.getElementById('deploymentChart');
        if (deploymentCtx) { 
            // ... rest of chart code ...
        } 
        */
    });
    // Add other non-DOMContentLoaded dashboard logic here if needed
    </script>
    {% endif %}
{% endblock %} 