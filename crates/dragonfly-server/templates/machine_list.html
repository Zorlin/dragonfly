{% extends "base.html" %}

{% block title %}Dragonfly - Machines{% endblock %}

{% block content %}
<div class="px-4 sm:px-6 lg:px-8" x-data="{
    isAuthenticated: {{ is_authenticated }},
    updateDebounceTimer: null,
    statusModal: false,
    osModal: false,
    deleteModal: false,
    tagModal: false,
    reimageModal: false,
    powerModal: false,
    macConfirmModal: false,
    addMachineModal: false, // New modal for adding machines
    addPxeModal: false, // PXE Boot Machine modal
    externalMachineModal: false, // External Machine modal
    bmcMachineModal: false, // BMC Machine modal
    currentMachineId: null,
    currentMachineName: null,
    newMacAddress: null,
    osDropdowns: {}, // Track open state of OS dropdowns
    editingField: null, // Track which field is being edited
    fieldChanges: {}, // Track changes to fields
    originalValues: {}, // Track original values for fields
    pendingChanges: false, // Whether there are unsaved changes
    errorMessage: null, // Added for modals that might need it
    
    // Just Type functionality
    startEditing(machineId, fieldName, currentValue) {
        // Don't allow editing if not authenticated
        if (!this.isAuthenticated) return;
        
        // Store the field being edited
        this.editingField = `${machineId}-${fieldName}`;
        
        // Store the original value
        if (!this.originalValues[machineId]) {
            this.originalValues[machineId] = {};
        }
        this.originalValues[machineId][fieldName] = currentValue;
        
        // Initialize changes object if needed
        if (!this.fieldChanges[machineId]) {
            this.fieldChanges[machineId] = {};
        }
    },
    
    updateField(machineId, fieldName, newValue) {
        // Update the changes object
        if (!this.fieldChanges[machineId]) {
            this.fieldChanges[machineId] = {};
        }
        
        // Check if the value has actually changed
        if (newValue !== this.originalValues[machineId][fieldName]) {
            this.fieldChanges[machineId][fieldName] = newValue;
            this.pendingChanges = true;
        } else {
            // If value is back to original, remove it from changes
            delete this.fieldChanges[machineId][fieldName];
            
            // Check if there are any changes left for this machine
            if (Object.keys(this.fieldChanges[machineId]).length === 0) {
                delete this.fieldChanges[machineId];
            }
            
            // Check if there are any changes left at all
            this.pendingChanges = Object.keys(this.fieldChanges).length > 0;
        }
    },
    
    stopEditing() {
        this.editingField = null;
    },
    
    // Validate a MAC address
    validateMac(mac) {
        return /^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$/.test(mac);
    },
    
    // Validate a hostname (RFC-1123 compliant)
    validateHostname(hostname) {
        return /^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(hostname);
    },
    
    // Validate an IP address
    validateIp(ip) {
        return /^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(ip);
    },
    
    // Apply changes to a specific machine
    applyChanges(machineId) {
        if (!this.fieldChanges[machineId]) return;
        
        const changes = this.fieldChanges[machineId];
        const payload = {};
        
        // Convert changes to a payload
        Object.keys(changes).forEach(field => {
            payload[field] = changes[field];
        });
        
        // Submit changes via AJAX
        fetch(`/api/machines/${machineId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams(payload).toString()
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Clear changes for this machine
            delete this.fieldChanges[machineId];
            this.pendingChanges = Object.keys(this.fieldChanges).length > 0;
            
            // Show success toast
            showToast(`Machine ${machineId} updated: ${data.message}`, 'success');
            
            // Refresh the machine list
            refreshMachineList();
        })
        .catch(error => {
            showToast(`Failed to update machine: ${error.message}`, 'error');
        });
    },
    
    // Check if field has changes
    hasFieldChanged(machineId, fieldName) {
        return this.fieldChanges[machineId] && 
               this.fieldChanges[machineId][fieldName] !== undefined &&
               this.fieldChanges[machineId][fieldName] !== this.originalValues[machineId][fieldName];
    },
    
    confirmMacChange(machineId) {
        const newMac = this.fieldChanges[machineId].mac_address;
        
        if (!this.validateMac(newMac)) {
            showToast('Invalid MAC address format. Please use XX:XX:XX:XX:XX:XX format.', 'error');
            return;
        }
        
        this.currentMachineId = machineId;
        this.newMacAddress = newMac;
        this.macConfirmModal = true;
    },
    
    confirmMacChangeApply() {
        this.applyChanges(this.currentMachineId);
        this.macConfirmModal = false;
    },
    
    cancelMacChange() {
        // Revert changes if user cancels
        delete this.fieldChanges[this.currentMachineId].mac_address;
        if (Object.keys(this.fieldChanges[this.currentMachineId]).length === 0) {
            delete this.fieldChanges[this.currentMachineId];
        }
        this.pendingChanges = Object.keys(this.fieldChanges).length > 0;
        
        // Refresh the display
        refreshMachineList();
        
        this.macConfirmModal = false;
    },
    
    openTagModal(id, name) { this.tagModal = true; this.currentMachineId = id; this.currentMachineName = name; },
    openReimageModal(id) { this.reimageModal = true; this.currentMachineId = id; },
    openPowerModal(id) { this.powerModal = true; this.currentMachineId = id; },
    openDeleteModal(id) { this.deleteModal = true; this.currentMachineId = id; },
    toggleOsDropdown(id) { 
        this.osDropdowns[id] = !this.osDropdowns[id]; 
        // Close all other dropdowns
        Object.keys(this.osDropdowns).forEach(key => {
            if (key !== id && this.osDropdowns[key]) this.osDropdowns[key] = false;
        });
    },
    selectOs(id, os) {
        // Initialize changes object if needed
        if (!this.originalValues[id]) {
            this.originalValues[id] = {};
        }
        if (!this.originalValues[id]['os_choice']) {
            // Store original OS value from the DOM since we don't have it in our data model
            const osElement = document.querySelector('tr[data-machine-id=' + id + '] .os-current-value');
            this.originalValues[id]['os_choice'] = osElement ? osElement.textContent.trim() : '';
        }
        
        // Update the changes object
        if (!this.fieldChanges[id]) {
            this.fieldChanges[id] = {};
        }
        
        // Check if the value has actually changed
        if (os !== this.originalValues[id]['os_choice']) {
            this.fieldChanges[id]['os_choice'] = os;
            this.pendingChanges = true;
        } else {
            // If value is back to original, remove it from changes
            delete this.fieldChanges[id]['os_choice'];
            
            // Check if there are any changes left for this machine
            if (Object.keys(this.fieldChanges[id]).length === 0) {
                delete this.fieldChanges[id];
            }
            
            // Check if there are any changes left at all
            this.pendingChanges = Object.keys(this.fieldChanges).length > 0;
        }
        
        // Close the dropdown
        this.osDropdowns[id] = false;
        
        // For debugging
        console.log('Select OS ' + os + ' for machine ' + id);
    },
    
    // Function to delete a machine
    deleteMachine(machineId) {
        if (!this.isAuthenticated) {
            showToast('Authentication required to delete machines.', 'error');
            return;
        }
        this.errorMessage = null; // Clear previous errors
        fetch(`/api/machines/${machineId}`, {
            method: 'DELETE',
            headers: {
                // Add any necessary headers like CSRF token if required by your backend
            }
        })
        .then(response => {
            if (!response.ok) {
                // Try to get error message from response body
                return response.text().then(text => {
                    throw new Error(text || `HTTP error! status: ${response.status}`);
                });
            }
            return response.text(); // Or response.json() if your API returns JSON
        })
        .then(data => {
            showToast(`Machine ${machineId} deleted successfully.`, 'success');
            this.deleteModal = false; // Close the modal
            this.currentMachineId = null;
            // Refresh the machine list using the new function
            refreshMachineList();
        })
        .catch(error => {
            this.errorMessage = `Failed to delete machine: ${error.message}`;
            showToast(this.errorMessage, 'error');
        });
    }
}" x-init="window.isAuthenticated = isAuthenticated"
   @close-tag-modal.window="tagModal = false"
   @close-delete-modal.window="deleteModal = false"
   @click.window="stopEditing()">
    <div class="sm:flex sm:items-center">
        <div class="sm:flex-auto">
            <h1 class="text-xl font-semibold text-gray-900 dark:text-white">Machines</h1>
            <p class="mt-2 text-sm text-gray-700 dark:text-gray-300">A list of all machines that have been discovered or added.</p>
        </div>
        <div>
            <button type="button" 
                    class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                    {% if not is_authenticated %}style="display: none;"{% endif %}
                    @click="addMachineModal = true">
                <svg class="-ml-1 mr-2 h-5 w-5 text-gray-500 dark:text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                Add Machine
            </button>
        </div>
    </div>
    <div class="mt-8 flex flex-col">
        <div class="-my-2 -mx-4 overflow-x-auto sm:-mx-6 lg:-mx-8">
          <div class="inline-block min-w-full py-2 align-middle md:px-6 lg:px-8">
            <div class="overflow-hidden rounded-xl border border-purple-500 dark:border-purple-700 shadow">
              <table class="min-w-full divide-y divide-gray-300 dark:divide-purple-800/50">
                <thead class="bg-gray-50 dark:bg-gray-950">      
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-200 uppercase tracking-wider">
                                    Name
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-200 uppercase tracking-wider">
                                    MAC Address
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-200 uppercase tracking-wider">
                                    IP Address
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-200 uppercase tracking-wider">
                                    Status
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-200 uppercase tracking-wider">
                                    OS
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-200 uppercase tracking-wider">
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody id="machine-list" class="divide-y divide-gray-200 dark:divide-gray-700/60 bg-white dark:bg-black">
                            {% for machine in machines %}
                            <tr class="hover:ring-purple-500 dark:hover:ring-purple-700/60 hover:bg-gray-50 dark:hover:bg-gray-700/50 cursor-pointer" 
                                @click="window.location='/machines/{{ machine.id }}'"
                                data-machine-id="{{ machine.id }}">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm font-medium text-gray-900 dark:text-white">
                                        <div x-on:click.stop="startEditing('{{ machine.id }}', 'hostname', '{{ machine.hostname|default('') }}')" 
                                             :class="{'cursor-text': isAuthenticated}" 
                                             class="hover:text-indigo-600 dark:hover:text-indigo-400">
                                            <span x-show="editingField !== '{{ machine.id }}-hostname'"
                                                  :class="{'text-purple-700 dark:text-purple-400 font-medium': hasFieldChanged('{{ machine.id }}', 'hostname')}">
                                                <span x-text="fieldChanges['{{ machine.id }}'] && fieldChanges['{{ machine.id }}'].hostname !== undefined ? 
                                                             fieldChanges['{{ machine.id }}'].hostname : 
                                                             '{% if machine.hostname %}{{ machine.hostname }}{% else %}Set hostname...{% endif %}'"></span>
                                            </span>
                                            <input x-show="editingField === '{{ machine.id }}-hostname'"
                                                   x-ref="hostname{{ machine.id }}"
                                                   x-on:click.stop
                                                   x-on:keydown.enter.stop="validateHostname($event.target.value) ? (updateField('{{ machine.id }}', 'hostname', $event.target.value), stopEditing()) : (showToast('Invalid hostname. Must follow RFC-1123 format.', 'error'), $event.target.value = originalValues['{{ machine.id }}']['hostname'], stopEditing())"
                                                   x-on:keydown.escape.stop="stopEditing()"
                                                   x-on:blur="validateHostname($event.target.value) ? (updateField('{{ machine.id }}', 'hostname', $event.target.value), stopEditing()) : (showToast('Invalid hostname. Must follow RFC-1123 format.', 'error'), $event.target.value = originalValues['{{ machine.id }}']['hostname'], stopEditing())"
                                                   x-effect="if(editingField === '{{ machine.id }}-hostname') setTimeout(() => $refs['hostname{{ machine.id }}'].focus(), 50)"
                                                   type="text"
                                                   value="{{ machine.hostname|default('') }}"
                                                   class="w-full border-b border-indigo-500 bg-transparent focus:outline-none focus:border-indigo-700 dark:text-white">
                                        </div>
                                        {# Display memorable_name below if it exists #}
                                        {% if machine.memorable_name %}
                                        <div x-on:click.stop="startEditing('{{ machine.id }}', 'memorable_name', '{{ machine.memorable_name }}')" 
                                             :class="{'cursor-text': isAuthenticated}"
                                             class="mt-1 text-xs text-gray-500 dark:text-gray-400 tracking-tight italic">
                                            <span x-show="editingField !== '{{ machine.id }}-memorable_name'"
                                                  :class="{'text-purple-700 dark:text-purple-400 font-medium': hasFieldChanged('{{ machine.id }}', 'memorable_name')}">
                                                <span x-text="fieldChanges['{{ machine.id }}'] && fieldChanges['{{ machine.id }}'].memorable_name !== undefined ? 
                                                             fieldChanges['{{ machine.id }}'].memorable_name : 
                                                             '{{ machine.memorable_name }}'"></span>
                                            </span>
                                            <input x-show="editingField === '{{ machine.id }}-memorable_name'"
                                                   x-ref="memorableName{{ machine.id }}"
                                                   x-on:click.stop
                                                   x-on:keydown.enter.stop="updateField('{{ machine.id }}', 'memorable_name', $event.target.value); stopEditing();"
                                                   x-on:keydown.escape.stop="stopEditing()"
                                                   x-on:blur="updateField('{{ machine.id }}', 'memorable_name', $event.target.value); stopEditing();"
                                                   x-effect="if(editingField === '{{ machine.id }}-memorable_name') setTimeout(() => $refs['memorableName{{ machine.id }}'].focus(), 50)"
                                                   type="text"
                                                   value="{{ machine.memorable_name }}"
                                                   class="w-full border-b border-indigo-500 bg-transparent focus:outline-none focus:border-indigo-700 dark:text-white text-xs">
                                        </div>
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400 tech-mono">
                                    <div x-on:click.stop="startEditing('{{ machine.id }}', 'mac_address', '{{ machine.mac_address }}')" 
                                         :class="{'cursor-text': isAuthenticated}">
                                        <span x-show="editingField !== '{{ machine.id }}-mac_address'"
                                              :class="{'text-purple-700 dark:text-purple-400 font-medium': hasFieldChanged('{{ machine.id }}', 'mac_address')}"
                                              class="tech-mono">
                                            <span x-text="fieldChanges['{{ machine.id }}'] && fieldChanges['{{ machine.id }}'].mac_address !== undefined ? 
                                                         fieldChanges['{{ machine.id }}'].mac_address : 
                                                         '{{ machine.mac_address }}'" class="tech-mono"></span>
                                        </span>
                                        <input x-show="editingField === '{{ machine.id }}-mac_address'"
                                               x-ref="macAddress{{ machine.id }}"
                                               x-on:click.stop
                                               x-on:keydown.enter.stop="validateMac($event.target.value) ? (updateField('{{ machine.id }}', 'mac_address', $event.target.value), stopEditing()) : (showToast('Invalid MAC address format. Must be XX:XX:XX:XX:XX:XX', 'error'), $event.target.value = originalValues['{{ machine.id }}']['mac_address'], stopEditing())"
                                               x-on:keydown.escape.stop="stopEditing()"
                                               x-on:blur="validateMac($event.target.value) ? (updateField('{{ machine.id }}', 'mac_address', $event.target.value), stopEditing()) : (showToast('Invalid MAC address format. Must be XX:XX:XX:XX:XX:XX', 'error'), $event.target.value = originalValues['{{ machine.id }}']['mac_address'], stopEditing())"
                                               x-effect="if(editingField === '{{ machine.id }}-mac_address') setTimeout(() => $refs['macAddress{{ machine.id }}'].focus(), 50)"
                                               type="text"
                                               value="{{ machine.mac_address }}"
                                               class="w-full border-b border-indigo-500 bg-transparent focus:outline-none focus:border-indigo-700 dark:text-white tech-mono">
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400 tech-mono">
                                    <div x-on:click.stop="startEditing('{{ machine.id }}', 'ip_address', '{{ machine.ip_address }}')" 
                                         :class="{'cursor-text': isAuthenticated}">
                                        <span x-show="editingField !== '{{ machine.id }}-ip_address'"
                                              :class="{'text-purple-700 dark:text-purple-400 font-medium': hasFieldChanged('{{ machine.id }}', 'ip_address')}"
                                              class="tech-mono">
                                            <span x-text="fieldChanges['{{ machine.id }}'] && fieldChanges['{{ machine.id }}'].ip_address !== undefined ? 
                                                         fieldChanges['{{ machine.id }}'].ip_address : 
                                                         '{{ machine.ip_address }}'" class="tech-mono"></span>
                                        </span>
                                        <input x-show="editingField === '{{ machine.id }}-ip_address'"
                                               x-ref="ipAddress{{ machine.id }}"
                                               x-on:click.stop
                                               x-on:keydown.enter.stop="validateIp($event.target.value) ? (updateField('{{ machine.id }}', 'ip_address', $event.target.value), stopEditing()) : (showToast('Invalid IP address format. Must be a valid IPv4 address.', 'error'), $event.target.value = originalValues['{{ machine.id }}']['ip_address'], stopEditing())"
                                               x-on:keydown.escape.stop="stopEditing()"
                                               x-on:blur="validateIp($event.target.value) ? (updateField('{{ machine.id }}', 'ip_address', $event.target.value), stopEditing()) : (showToast('Invalid IP address format. Must be a valid IPv4 address.', 'error'), $event.target.value = originalValues['{{ machine.id }}']['ip_address'], stopEditing())"
                                               x-effect="if(editingField === '{{ machine.id }}-ip_address') setTimeout(() => $refs['ipAddress{{ machine.id }}'].focus(), 50)"
                                               type="text"
                                               value="{{ machine.ip_address }}"
                                               class="w-full border-b border-indigo-500 bg-transparent focus:outline-none focus:border-indigo-700 dark:text-white tech-mono">
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-3 py-1 inline-flex text-sm leading-5 font-semibold rounded-full 
                                        {% if machine.status == "Ready" %}
                                            bg-green-100 text-green-800 dark:bg-green-400/10 dark:text-green-300 dark:border dark:border-green-500/20
                                        {% elif machine.status == "InstallingOS" %}
                                            bg-yellow-100 text-yellow-800 dark:bg-yellow-400/10 dark:text-yellow-300 dark:border dark:border-yellow-500/20
                                        {% elif machine.status == "AwaitingAssignment" %}
                                            bg-blue-100 text-blue-800 dark:bg-blue-400/10 dark:text-blue-300 dark:border dark:border-blue-500/20
                                        {% elif machine.status == "ExistingOS" %}
                                            bg-sky-100 text-sky-800 dark:bg-sky-400/10 dark:text-sky-300 dark:border dark:border-sky-500/20
                                        {% else %}
                                            bg-red-100 text-red-800 dark:bg-red-400/10 dark:text-red-300 dark:border dark:border-red-500/20
                                        {% endif %}">
                                        {% if machine.status == "Ready" %}
                                            Provisioned
                                        {% elif machine.status == "InstallingOS" %}
                                            Installing OS
                                        {% elif machine.status == "AwaitingAssignment" %}
                                            Awaiting OS Selection
                                        {% elif machine.status == "ExistingOS" %}
                                            Existing OS
                                        {% else %}
                                            Error {# Explicitly handle Error or other unexpected statuses #}
                                        {% endif %}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                    <div class="relative" @click.stop>
                                        <div class="flex items-center cursor-pointer" @click="toggleOsDropdown('{{ machine.id }}')">
                                            {% if machine.os_choice %}
                                                <span class="flex items-center">
                                                    {{ machine.os_choice | format_os_icon | safe }} 
                                                    <span class="ml-1">{{ machine.os_choice | format_os }}</span>
                                                </span>
                                            {% else %}
                                                <span class="text-gray-400 italic flex items-center">
                                                    <i class="fas fa-square-question text-gray-400 mr-1"></i> No OS
                                                </span>
                                            {% endif %}
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                            </svg>
                                        </div>
                                        
                                        <!-- OS Dropdown -->
                                        <div 
                                            x-show="osDropdowns['{{ machine.id }}'] === true"
                                            x-transition:enter="transition ease-out duration-100"
                                            x-transition:enter-start="transform opacity-0 scale-95"
                                            x-transition:enter-end="transform opacity-100 scale-100"
                                            x-transition:leave="transition ease-in duration-75"
                                            x-transition:leave-start="transform opacity-100 scale-100"
                                            x-transition:leave-end="transform opacity-0 scale-95"
                                            class="absolute z-10 mt-1 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none dark:bg-black dark:ring-gray-700"
                                            @click.outside="osDropdowns['{{ machine.id }}'] = false"
                                            x-cloak
                                        >
                                            <div class="py-1">
                                                <!-- OS Options -->
                                                <a href="#" @click.prevent="selectOs('{{ machine.id }}', 'ubuntu-2204')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-gray-700 dark:hover:text-white flex items-center">
                                                    <i class="fab fa-ubuntu text-orange-500 dark:text-orange-500 no-invert mr-2"></i> Ubuntu 22.04
                                                </a>
                                                <a href="#" @click.prevent="selectOs('{{ machine.id }}', 'ubuntu-2404')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-gray-700 dark:hover:text-white flex items-center">
                                                    <i class="fab fa-ubuntu text-orange-500 dark:text-orange-500 no-invert mr-2"></i> Ubuntu 24.04
                                                </a>
                                                <a href="#" @click.prevent="selectOs('{{ machine.id }}', 'debian-12')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-gray-700 dark:hover:text-white flex items-center">
                                                    <i class="fab fa-debian text-red-500 mr-2"></i> Debian 12
                                                </a>
                                                <a href="#" @click.prevent="selectOs('{{ machine.id }}', 'proxmox')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-gray-700 dark:hover:text-white flex items-center">
                                                    <i class="fas fa-server text-blue-500 mr-2"></i> Proxmox
                                                </a>
                                                <a href="#" @click.prevent="selectOs('{{ machine.id }}', 'talos')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-gray-700 dark:hover:text-white flex items-center">
                                                    <i class="fas fa-robot text-purple-500 mr-2"></i> Talos
                                                </a>
                                                <!-- Add more OS options as needed -->
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                    {% if machine.status == "InstallingOS" %}
                                        {% if workflow_infos[machine.id] %}
                                            <div class="flex flex-col space-y-1 pointer-events-none">
                                                <div class="flex justify-between text-xs">
                                                    <span>{{ workflow_infos[machine.id].progress }}%</span>
                                                    {% if workflow_infos[machine.id].current_action %}
                                                        <span class="ml-2 truncate max-w-[120px]">
                                                            {{ workflow_infos[machine.id].current_action }}
                                                        </span>
                                                    {% endif %}
                                                </div>
                                                <div class="w-full bg-gray-200 rounded-full h-2 dark:bg-gray-700">
                                                    <div class="bg-yellow-500 h-2 rounded-full dark:bg-yellow-600 workflow-progress-bar" data-machine-id="{{ machine.id }}" data-progress="{{ workflow_infos[machine.id].progress }}"></div>
                                                </div>
                                            </div>
                                        {% else %}
                                            <span class="text-xs italic text-gray-400 pointer-events-none">Awaiting progress data...</span>
                                        {% endif %}
                                    {% else %}
                                        {% if is_admin %} {# Wrap all actions in is_admin check #}
                                        <div class="flex space-x-1 items-center" @click.stop hx-preserve="true">
                                            {# Common Actions - Tags #}
                                            <button 
                                                @click="openTagModal(
                                                    '{{ machine.id }}', 
                                                    `{% if machine.hostname %}{{ machine.hostname }}{% elif machine.memorable_name %}{{ machine.memorable_name }}{% else %}{{ machine.id }}{% endif %}`.trim()
                                                )"
                                                class="inline-flex items-center px-3 py-1 border border-transparent text-sm leading-5 font-medium rounded text-purple-700 bg-purple-100 hover:bg-purple-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 dark:bg-purple-900 dark:text-purple-200 dark:hover:bg-purple-800"
                                            >
                                                🏷️ Tags
                                            </button>
                                            
                                            {# Apply Button - Only show when there are changes to apply #}
                                            <template x-if="fieldChanges['{{ machine.id }}'] && Object.keys(fieldChanges['{{ machine.id }}']).length > 0">
                                                <button @click="fieldChanges['{{ machine.id }}'].mac_address ? confirmMacChange('{{ machine.id }}') : applyChanges('{{ machine.id }}')" 
                                                        class="inline-flex items-center px-3 py-1 border border-transparent text-sm leading-5 font-medium rounded text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:bg-blue-900 dark:text-blue-200 dark:hover:bg-blue-800">
                                                    ⚡ Apply
                                                </button>
                                            </template>
                                            
                                            {# Reimage Action - Only show when there are no changes to apply #}
                                            <template x-if="!fieldChanges['{{ machine.id }}'] || Object.keys(fieldChanges['{{ machine.id }}']).length === 0">
                                                {% if machine.status == "Ready" or machine.status == "AwaitingAssignment" or machine.status == "ExistingOS" or machine.status == "Offline" %}
                                                <button @click="openReimageModal('{{ machine.id }}')" class="inline-flex items-center px-3 py-1 border border-transparent text-sm leading-5 font-medium rounded text-cyan-700 bg-cyan-100 hover:bg-cyan-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500 dark:bg-cyan-900 dark:text-cyan-200 dark:hover:bg-cyan-800">
                                                    ♻️ Reimage
                                                </button>
                                                {% endif %}
                                            </template>

                                            {# Power Action #}
                                            {% if machine.bmc_credentials %}
                                            <button @click="openPowerModal('{{ machine.id }}')" class="inline-flex items-center px-3 py-1 border border-transparent text-sm leading-5 font-medium rounded text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                                ⏻ Power
                                            </button>
                                            {% endif %}
                                            
                                            {# Delete Action #}
                                            <button @click="openDeleteModal('{{ machine.id }}')" class="ml-3 inline-flex items-center p-1 border border-transparent text-sm leading-5 font-medium rounded text-red-700 bg-red-100 hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 dark:bg-red-900 dark:text-red-200 dark:hover:bg-red-800"> {# Added ml-3 for spacing #}
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                                                </svg>
                                            </button>
                                        </div>
                                        {% endif %} {# End is_admin check for actions #}
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="6" class="px-6 py-10 text-center text-gray-500 dark:text-gray-400">
                                    <p class="mb-2">No machines discovered yet.</p>
                                    <p class="text-sm italic">Machines will appear here once they connect to Dragonfly.</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    {# === MODALS === (Moved inside the main x-data div) #}
    <div id="status-modal" class="relative z-10" aria-labelledby="modal-title" role="dialog" aria-modal="true" x-show="statusModal" x-cloak>
        <!-- Removed background overlay -->
        <div class="fixed inset-0 z-10 overflow-y-auto" @click="statusModal = false">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6" 
                    @click.stop>
                    <!-- Status modal content (Placeholder/Not Used Currently) -->
                    Status Modal Content
                </div>
            </div>
        </div>
    </div>

    <div id="os-modal" class="relative z-10" aria-labelledby="modal-title" role="dialog" aria-modal="true" x-show="osModal" x-cloak>
        <!-- Removed background overlay -->
        <div class="fixed inset-0 z-10 overflow-y-auto" @click="osModal = false">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6" 
                    @click.stop>
                    <!-- OS modal content (Placeholder/Not Used Currently) -->
                    OS Modal Content
                </div>
            </div>
        </div>
    </div>

    <div id="delete-modal" class="relative z-10" aria-labelledby="modal-title" role="dialog" aria-modal="true" x-show="deleteModal" x-cloak>
        <!-- Removed background overlay -->
        <div class="fixed inset-0 z-10 overflow-y-auto" @click="deleteModal = false">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6" 
                    @click.stop>
                    <!-- Delete modal content (Generated by showDeleteModal in JS) -->
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                            <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left">
                            <h3 class="text-base font-semibold leading-6 text-gray-900 dark:text-white" id="modal-title">Delete Machine</h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500 dark:text-gray-300">
                                    Are you sure you want to delete machine <code x-text="currentMachineId"></code>? This action cannot be undone.
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                        <button type="button" class="inline-flex w-full justify-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 sm:ml-3 sm:w-auto" @click="deleteMachine(currentMachineId)">Delete</button>
                        <button type="button" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto dark:bg-gray-600 dark:text-white dark:ring-gray-500 dark:hover:bg-gray-500" @click="deleteModal = false">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Tag Editor Modal #}
    <div id="tag-modal" class="relative z-20" aria-labelledby="tag-modal-title" role="dialog" aria-modal="true" x-show="tagModal" x-cloak>
        <!-- Removed background overlay -->
        <div class="fixed inset-0 z-20 overflow-y-auto" @click="$dispatch('close-tag-modal')">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6" 
                    @click.stop x-data="tagEditorData()" x-init="if (tagModal) loadTags(currentMachineId)" x-show="tagModal">
                    <h3 class="text-lg font-medium leading-6 text-gray-900 dark:text-white mb-1" id="tag-modal-title">
                        Edit Tags for <code class="text-purple-600 dark:text-purple-400" x-text="currentMachineName"></code>
                    </h3>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">Machine ID: <code class="text-xs" x-text="currentMachineId"></code></p>

                    {# Loading State #}
                    <template x-if="isLoading">
                        <div class="text-center p-4">
                            <span class="text-gray-500 dark:text-gray-400">Loading tags...</span>
                        </div>
                    </template>

                    {# Error Message #}
                    <template x-if="errorMessage">
                        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                            <strong class="font-bold">Error:</strong>
                            <span class="block sm:inline" x-text="errorMessage"></span>
                        </div>
                    </template>

                    {# Tag Editor Content #}
                    <template x-if="!isLoading">
                        <div>
                            {# Display existing tags #}
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Current Tags:</label>
                                <div class="mt-1 flex flex-wrap gap-2" x-show="tags.length > 0">
                                    <template x-for="(tag, index) in tags" :key="index">
                                        <span class="inline-flex items-center rounded-full bg-purple-100 dark:bg-purple-900 py-0.5 pl-2.5 pr-1 text-sm font-medium text-purple-700 dark:text-purple-200">
                                            <span x-text="tag"></span>
                                            <button @click="removeTag(index)" type="button" class="ml-0.5 inline-flex h-4 w-4 flex-shrink-0 items-center justify-center rounded-full text-purple-400 hover:bg-purple-200 hover:text-purple-500 focus:bg-purple-500 focus:text-white focus:outline-none">
                                                <span class="sr-only">Remove tag</span>
                                                <svg class="h-2 w-2" stroke="currentColor" fill="none" viewBox="0 0 8 8">
                                                    <path stroke-linecap="round" stroke-width="1.5" d="M1 1l6 6m0-6L1 7" />
                                                </svg>
                                            </button>
                                        </span>
                                    </template>
                                </div>
                                <p x-show="tags.length === 0" class="mt-1 text-sm text-gray-500 dark:text-gray-400 italic">No tags assigned.</p>
                            </div>

                            {# Add New Tag Input #}
                            <div class="mb-4">
                                <label for="new-tag-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Add New Tag:</label>
                                <div class="mt-1 flex rounded-md shadow-sm">
                                    <input type="text" id="new-tag-input" x-model="newTag" @keydown.enter.prevent="addTag()" @keydown.space.prevent="addTag()" placeholder="Enter tag name" class="block w-full flex-1 rounded-none rounded-l-md border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    <button @click="addTag()" type="button" class="relative -ml-px inline-flex items-center space-x-2 rounded-r-md border border-gray-300 bg-gray-50 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100 focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 dark:bg-gray-600 dark:border-gray-600 dark:text-gray-200 dark:hover:bg-gray-500">
                                        <span>Add</span>
                                    </button>
                                </div>
                                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Press Enter or Space to add the tag.</p>
                            </div>
                        </div>
                    </template>

                    {# Modal Buttons #}
                    <div class="mt-5 sm:mt-6 sm:grid sm:grid-flow-row-dense sm:grid-cols-2 sm:gap-3">
                        <button 
                            type="button" 
                            class="inline-flex w-full justify-center rounded-md border border-transparent bg-indigo-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 sm:col-start-2 sm:text-sm disabled:opacity-50"
                            @click="saveTags()" 
                            :disabled="isLoading"
                        >
                            Save Tags
                        </button>
                        <button 
                            type="button" 
                            class="mt-3 inline-flex w-full justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-base font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 sm:col-start-1 sm:mt-0 sm:text-sm dark:bg-gray-600 dark:text-white dark:border-gray-500 dark:hover:bg-gray-500"
                            @click="$dispatch('close-tag-modal')"
                        >
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Reimage Modal #}
    <div id="reimage-modal" class="relative z-10" aria-labelledby="modal-title" role="dialog" aria-modal="true" x-show="reimageModal" x-cloak>
        <!-- Removed background overlay -->
        <div class="fixed inset-0 z-10 overflow-y-auto" @click="reimageModal = false">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6" 
                    @click.stop>
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-cyan-100 sm:mx-0 sm:h-10 sm:w-10">
                            <svg class="h-6 w-6 text-cyan-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12c0-1.232-.046-2.453-.138-3.662a4.006 4.006 0 0 0-3.7-3.7 48.678 48.678 0 0 0-7.324 0 4.006 4.006 0 0 0-3.7 3.7c-.092 1.21-.138 2.43-.138 3.662v.012c0 1.232.046 2.453.138 3.662a4.006 4.006 0 0 0 3.7 3.7 48.656 48.656 0 0 0 7.324 0 4.006 4.006 0 0 0 3.7-3.7c.092-1.21.138-2.43.138-3.662v-.012Zm-7 0a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Z" />
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left">
                            <h3 class="text-base font-semibold leading-6 text-gray-900 dark:text-white" id="modal-title">Reimage Machine</h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500 dark:text-gray-300">Select an OS to reimage machine <code x-text="currentMachineId"></code> with. (Not Implemented)</p>
                                {# TODO: Add OS selection dropdown/buttons and trigger reimage API call #}
                            </div>
                        </div>
                    </div>
                    <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                        <button type="button" class="disabled:opacity-50 inline-flex w-full justify-center rounded-md bg-cyan-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-cyan-500 sm:ml-3 sm:w-auto" disabled>Reimage</button>
                        <button type="button" @click="reimageModal = false" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto dark:bg-gray-600 dark:text-white dark:ring-gray-500 dark:hover:bg-gray-500">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Power Modal #}
    <div id="power-modal" class="relative z-10" aria-labelledby="modal-title" role="dialog" aria-modal="true" x-show="powerModal" x-cloak>
        <!-- Removed background overlay -->
        <div class="fixed inset-0 z-10 overflow-y-auto" @click="powerModal = false">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6" 
                    @click.stop>
                     <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                            <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                               <path stroke-linecap="round" stroke-linejoin="round" d="M5.636 5.636a9 9 0 1 0 12.728 0M12 3v9" />
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left">
                            <h3 class="text-base font-semibold leading-6 text-gray-900 dark:text-white" id="modal-title">Power Control</h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500 dark:text-gray-300">Control power for machine <code x-text="currentMachineId"></code>. (Not Implemented)</p>
                                {# TODO: Add buttons for Power On, Power Off, Reboot using BMC API #}
                            </div>
                        </div>
                    </div>
                    <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse space-x-reverse space-x-2">
                        <button type="button" @click="powerModal = false" class="inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto dark:bg-gray-600 dark:text-white dark:ring-gray-500 dark:hover:bg-gray-500">Cancel</button>
                        <button type="button" class="disabled:opacity-50 inline-flex w-full justify-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 sm:w-auto" disabled>Power Off</button>
                        <button type="button" class="disabled:opacity-50 inline-flex w-full justify-center rounded-md bg-green-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-500 sm:w-auto" disabled>Power On</button>
                     </div>
                </div>
            </div>
        </div>
    </div>

    {# MAC Address Change Confirmation Modal #}
    <div id="mac-confirm-modal" class="relative z-50" aria-labelledby="modal-title" role="dialog" aria-modal="true" 
        x-show="macConfirmModal" 
        x-transition:enter="ease-out duration-200"
        x-transition:enter-start="opacity-0 scale-95"
        x-transition:enter-end="opacity-100 scale-100"
        x-transition:leave="ease-in duration-100"
        x-transition:leave-start="opacity-100 scale-100"
        x-transition:leave-end="opacity-0 scale-95"
        x-cloak>
        <!-- Removed background overlay -->
        <div class="fixed inset-0 z-50 overflow-y-auto" @click="macConfirmModal = false">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6 border border-purple-500/30 dark:border-purple-500/20" 
                    @click.stop>
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-yellow-100 sm:mx-0 sm:h-10 sm:w-10">
                            <svg class="h-6 w-6 text-yellow-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left">
                            <h3 class="text-base font-semibold leading-6 text-gray-900 dark:text-white" id="modal-title">Confirm MAC Address Change</h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500 dark:text-gray-300">
                                    Changing the MAC address for this machine will cause issues if the machine is still using the old one. Are you sure you want to change it to <code x-text="newMacAddress" class="font-mono text-purple-600 dark:text-purple-400"></code>?
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                        <button type="button" class="inline-flex w-full justify-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 sm:ml-3 sm:w-auto" @click="confirmMacChangeApply()">Confirm Change</button>
                        <button type="button" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto dark:bg-gray-600 dark:text-white dark:ring-gray-500 dark:hover:bg-gray-500" @click="cancelMacChange()">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Add Machine Modal #}
    <div id="add-machine-modal" class="relative z-10" aria-labelledby="modal-title" role="dialog" aria-modal="true" x-show="addMachineModal" x-cloak>
        <!-- Remove the background overlay div -->
        <div class="fixed inset-0 z-10 overflow-y-auto" @click="addMachineModal = false">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-4xl sm:p-6" 
                    @click.stop>
                    
                    <div class="mb-6 text-center">
                        <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Add Machine</h3>
                        <p class="text-gray-600 dark:text-gray-400">Select how you want to add a new machine to Dragonfly</p>
                    </div>
                    
                    <!-- Three card options similar to welcome.html -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- PXE Boot Machine -->
                        <div @click="addMachineModal = false; addPxeModal = true" 
                            class="bg-emerald-800 dark:bg-emerald-900/90 rounded-xl shadow-md overflow-hidden border border-emerald-700 dark:border-emerald-800 transition-all hover:shadow-lg hover:scale-[1.02] duration-300 flex flex-col cursor-pointer" 
                            style="height: 14em;">
                            <div class="p-4 flex-grow">
                                <div class="flex justify-center items-center mb-4">
                                    <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-emerald-700 dark:bg-emerald-800">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-emerald-300 dark:text-emerald-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
                                        </svg>
                                    </div>
                                </div>
                                <h3 class="text-xl font-semibold text-white mb-3 text-center">PXE Boot</h3>
                                <p class="text-emerald-100 dark:text-emerald-200 mt-2 text-center text-sm">
                                    Add a machine that will PXE boot and be provisioned automatically
                                </p>
                            </div>
                        </div>
                        
                        <!-- External Machine -->
                        <div @click="addMachineModal = false; externalMachineModal = true" 
                            class="bg-purple-900 dark:bg-purple-950/90 rounded-xl shadow-md overflow-hidden border border-purple-800 dark:border-purple-800 transition-all hover:shadow-lg hover:scale-[1.02] duration-300 flex flex-col cursor-pointer" 
                            style="height: 14em;">
                            <div class="p-4 flex-grow">
                                <div class="flex justify-center items-center mb-4">
                                    <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-purple-800 dark:bg-purple-800">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-300 dark:text-purple-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                                        </svg>
                                    </div>
                                </div>
                                <h3 class="text-center text-xl font-semibold text-white mb-2">External</h3>
                                <p class="text-center text-purple-100 dark:text-purple-200 mt-2 text-sm">
                                    Add an existing machine that won't be provisioned by Dragonfly
                                </p>
                            </div>
                        </div>
                        
                        <!-- Cloud Machine -->
                        <div @click="addMachineModal = false; cloudMachineModal = true" 
                            class="bg-cyan-800 dark:bg-cyan-900/90 rounded-xl shadow-md overflow-hidden border border-cyan-700 dark:border-cyan-800 transition-all hover:shadow-lg hover:scale-[1.02] duration-300 flex flex-col cursor-pointer" 
                            style="height: 14em;">
                            <div class="p-4 flex-grow">
                                <div class="flex justify-center items-center mb-4">
                                    <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-cyan-700 dark:bg-cyan-700">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-cyan-300 dark:text-cyan-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                    </div>
                                </div>
                                <h3 class="text-center text-xl font-semibold text-white mb-2">Cloud</h3>
                                <p class="text-center text-cyan-100 dark:text-cyan-200 mt-2 text-sm">
                                    Add a machine from a cloud provider
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cancel button -->
                    <div class="mt-6 text-center">
                        <button type="button" @click="addMachineModal = false"
                                class="inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-4 py-2 text-base font-medium text-gray-700 dark:text-gray-200 shadow-sm hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 sm:text-sm">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# PXE Boot Machine Modal #}
    <div id="add-pxe-modal" class="relative z-10" aria-labelledby="modal-title" role="dialog" aria-modal="true" x-show="addPxeModal" x-cloak>
        <!-- Removed background overlay -->
        <div class="fixed inset-0 z-10 overflow-y-auto" @click="addPxeModal = false">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6" 
                    @click.stop x-data="addMachineForm()" x-init="initForm()">
                    <div>
                        <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-emerald-100 dark:bg-emerald-900">
                            <svg class="h-6 w-6 text-emerald-600 dark:text-emerald-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:mt-5">
                            <h3 class="text-lg font-medium leading-6 text-gray-900 dark:text-white" id="modal-title">Connect a Machine</h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500 dark:text-gray-400">
                                    Add a machine that will be provisioned via PXE boot by providing its MAC address. You can optionally set a hostname and IP address.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Form fields -->
                    <div class="mt-5 sm:mt-6">
                        <form @submit.prevent="submitForm">
                            <div class="space-y-4">
                                <!-- MAC Address (required) -->
                                <div>
                                    <label for="mac-address" class="block text-sm font-medium text-gray-700 dark:text-gray-300">MAC Address <span class="text-red-500">*</span></label>
                                    <div class="mt-1">
                                        <input type="text" name="mac_address" id="mac-address" 
                                               x-model="formData.mac_address" 
                                               class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm"
                                               placeholder="e.g., 00:11:22:33:44:55" required>
                                    </div>
                                    <p class="mt-1 text-xs text-red-500" x-show="errors.mac_address" x-text="errors.mac_address"></p>
                                </div>
                                
                                <!-- Hostname (optional) -->
                                <div>
                                    <label for="hostname" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Hostname</label>
                                    <div class="mt-1">
                                        <input type="text" name="hostname" id="hostname" 
                                               x-model="formData.hostname" 
                                               class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm"
                                               placeholder="e.g., server01">
                                    </div>
                                    <p class="mt-1 text-xs text-red-500" x-show="errors.hostname" x-text="errors.hostname"></p>
                                </div>
                                
                                <!-- IP Address (optional) -->
                                <div>
                                    <label for="ip-address" class="block text-sm font-medium text-gray-700 dark:text-gray-300">IP Address</label>
                                    <div class="mt-1">
                                        <input type="text" name="ip_address" id="ip-address" 
                                               x-model="formData.ip_address" 
                                               class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm"
                                               placeholder="e.g., 192.168.1.100">
                                    </div>
                                    <p class="mt-1 text-xs text-red-500" x-show="errors.ip_address" x-text="errors.ip_address"></p>
                                </div>
                                
                                <!-- Initial Status -->
                                <div>
                                    <label for="status" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Initial Status</label>
                                    <div class="mt-1">
                                        <select id="status" name="status" x-model="formData.status" 
                                                class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm">
                                            <option value="AwaitingAssignment">Awaiting OS Assignment</option>
                                            <option value="ExistingOS">Existing OS</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Optional Descriptive Name -->
                                <div>
                                    <label for="memorable-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Descriptive Name</label>
                                    <div class="mt-1">
                                        <input type="text" name="memorable_name" id="memorable-name" 
                                               x-model="formData.memorable_name" 
                                               class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm"
                                               placeholder="e.g., Web Server">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Error message -->
                            <div class="mt-4" x-show="formError">
                                <p class="text-sm text-red-600 dark:text-red-400" x-text="formError"></p>
                            </div>
                            
                            <!-- Form buttons -->
                            <div class="mt-5 sm:mt-6 sm:grid sm:grid-flow-row-dense sm:grid-cols-2 sm:gap-3">
                                <button type="submit" 
                                        class="inline-flex w-full justify-center rounded-md border border-transparent bg-emerald-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 sm:col-start-2 sm:text-sm"
                                        :disabled="isSubmitting">
                                    <span x-show="!isSubmitting">Add PXE Machine</span>
                                    <span x-show="isSubmitting" class="flex items-center">
                                        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        Processing...
                                    </span>
                                </button>
                                <button type="button" @click="addPxeModal = false"
                                        class="mt-3 inline-flex w-full justify-center rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-4 py-2 text-base font-medium text-gray-700 dark:text-gray-200 shadow-sm hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 sm:col-start-1 sm:mt-0 sm:text-sm">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# External Machine Modal #}
    <div id="external-machine-modal" class="relative z-10" aria-labelledby="modal-title" role="dialog" aria-modal="true" x-show="externalMachineModal" x-cloak>
        <!-- Removed background overlay -->
        <div class="fixed inset-0 z-10 overflow-y-auto" @click="externalMachineModal = false">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6" 
                    @click.stop>
                    <div>
                        <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-purple-100 dark:bg-purple-900">
                            <svg class="h-6 w-6 text-purple-600 dark:text-purple-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:mt-5">
                            <h3 class="text-lg font-medium leading-6 text-gray-900 dark:text-white" id="modal-title">Add External Machine</h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500 dark:text-gray-400">
                                    Add an existing machine that will not be provisioned by Dragonfly.
                                </p>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mt-4">
                                    This feature is coming soon.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-5 sm:mt-6">
                        <button type="button" @click="externalMachineModal = false"
                                class="inline-flex w-full justify-center rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-4 py-2 text-base font-medium text-gray-700 dark:text-gray-200 shadow-sm hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 sm:text-sm">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    {# BMC Machine Modal #}
    <div id="bmc-machine-modal" class="relative z-10" aria-labelledby="modal-title" role="dialog" aria-modal="true" x-show="bmcMachineModal" x-cloak>
        <!-- Removed background overlay -->
        <div class="fixed inset-0 z-10 overflow-y-auto" @click="bmcMachineModal = false">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6" 
                    @click.stop>
                    <div>
                        <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-cyan-100 dark:bg-cyan-900">
                            <svg class="h-6 w-6 text-cyan-600 dark:text-cyan-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:mt-5">
                            <h3 class="text-lg font-medium leading-6 text-gray-900 dark:text-white" id="modal-title">Add BMC Managed Machine</h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500 dark:text-gray-400">
                                    Add a machine with BMC (IPMI, Redfish, iDRAC) for power control and management.
                                </p>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mt-4">
                                    This feature is coming soon.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-5 sm:mt-6">
                        <button type="button" @click="bmcMachineModal = false"
                                class="inline-flex w-full justify-center rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-4 py-2 text-base font-medium text-gray-700 dark:text-gray-200 shadow-sm hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:ring-offset-2 sm:text-sm">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div> {# End of main x-data div #}
{% endblock %}

{% block scripts %}
<script>
    // Add Machine Form Handler
    function addMachineForm() {
        return {
            formData: {
                mac_address: '',
                hostname: '',
                ip_address: '',
                memorable_name: '',
                status: 'AwaitingAssignment'
            },
            errors: {},
            formError: '',
            isSubmitting: false,
            
            initForm() {
                // Initialize the form
                this.resetForm();
            },
            
            resetForm() {
                this.formData = {
                    mac_address: '',
                    hostname: '',
                    ip_address: '',
                    memorable_name: '',
                    status: 'AwaitingAssignment'
                };
                this.errors = {};
                this.formError = '';
                this.isSubmitting = false;
            },
            
            validateForm() {
                this.errors = {};
                let isValid = true;
                
                // Validate MAC address (required and format)
                if (!this.formData.mac_address) {
                    this.errors.mac_address = 'MAC address is required';
                    isValid = false;
                } else if (!/^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$/.test(this.formData.mac_address)) {
                    this.errors.mac_address = 'Invalid MAC address format. Use XX:XX:XX:XX:XX:XX';
                    isValid = false;
                }
                
                // Validate hostname format if provided
                if (this.formData.hostname && !/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(this.formData.hostname)) {
                    this.errors.hostname = 'Invalid hostname format';
                    isValid = false;
                }
                
                // Validate IP address format if provided
                if (this.formData.ip_address && !/^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(this.formData.ip_address)) {
                    this.errors.ip_address = 'Invalid IP address format';
                    isValid = false;
                }
                
                return isValid;
            },
            
            async submitForm() {
                if (!this.validateForm()) return;
                
                this.isSubmitting = true;
                this.formError = '';
                
                try {
                    const response = await fetch('/api/machines', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(this.formData)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to add machine');
                    }
                    
                    const result = await response.json();
                    
                    // Show success message
                    showToast('Machine added successfully', 'success');
                    
                    // Close the modal
                    this.addPxeModal = false;
                    
                    // Reset the form
                    this.resetForm();
                    
                    // Refresh the machine list
                    refreshMachineList();
                    
                } catch (error) {
                    console.error('Error adding machine:', error);
                    this.formError = error.message || 'An error occurred while adding the machine';
                } finally {
                    this.isSubmitting = false;
                }
            }
        };
    }
    
    // Check if user is authenticated before allowing admin actions
    function requireAdmin(callback) {
        // window.isAuthenticated is now set by Alpine's x-init
        if (!window.isAuthenticated) {
            alert("You need to be logged in as admin to perform this action.");
            return false;
        }
        return callback();
    }

    // Alpine.js component for the Tag Editor Modal
    function tagEditorData() {
        return {
            tags: [],
            newTag: '',
            isLoading: false,
            machineId: null,
            
            init() {
                // Initial tags will be loaded when the modal is opened
            },
            addTag() {
                if (!this.newTag.trim()) return;
                if (this.tags.includes(this.newTag.trim())) {
                    this.newTag = '';
                    return;
                }
                this.isLoading = true;
                
                // Make API call to add tag
                fetch(`/api/machines/${this.machineId}/tags`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ tag: this.newTag.trim() })
                })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to add tag');
                    return response.json();
                })
                .then(data => {
                    this.tags.push(this.newTag.trim());
                    this.newTag = '';
                    this.isLoading = false;
                })
                .catch(error => {
                    this.isLoading = false;
                    alert('Failed to add tag. Please try again.');
                });
            },
            removeTag(tag) {
                this.isLoading = true;
                
                // Make API call to remove tag
                fetch(`/api/machines/${this.machineId}/tags/${encodeURIComponent(tag)}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to remove tag');
                    this.tags = this.tags.filter(t => t !== tag);
                    this.isLoading = false;
                })
                .catch(error => {
                    this.isLoading = false;
                    alert('Failed to remove tag. Please try again.');
                });
            },
            openModal(machineId) {
                this.machineId = machineId;
                this.isLoading = true;
                
                // Fetch existing tags for this machine
                fetch(`/api/machines/${machineId}/tags`)
                .then(response => {
                    if (!response.ok) throw new Error('Failed to fetch tags');
                    return response.json();
                })
                .then(data => {
                    this.tags = data.tags || [];
                    this.isLoading = false;
                })
                .catch(error => {
                    this.isLoading = false;
                    alert('Failed to load tags. Please try again.');
                });
            }
        };
    }

    // --- MODIFIED Progress Animation Logic --- 
    let machineProgressData = {}; // Stores { targetProgress, realProgress, lastTaskName }
    let animationFrameId = null;
    const FPS = 60;

    function startProgressAnimation() {
        if (animationFrameId) return; // Already running
        let lastFrameTime = performance.now();
        const frameInterval = 1000 / FPS;

        function updateFrame(now) {
            if (now - lastFrameTime < frameInterval) {
                animationFrameId = requestAnimationFrame(updateFrame);
                return;
            }
            lastFrameTime = now;
            let needsMoreFrames = false;

            Object.keys(machineProgressData).forEach(machineId => {
                const data = machineProgressData[machineId];
                // Ensure data exists AND has the new realProgress field
                if (!data || data.realProgress === undefined) return; 
                const machineRow = document.querySelector(`tr[data-machine-id=\"${machineId}\"]`);
                if (!machineRow) return;
                const progressBar = machineRow.querySelector('.workflow-progress-bar');
                const progressTextElement = machineRow.querySelector('.flex.justify-between.text-xs span:first-child');
                if (!progressBar || !progressTextElement) return;

                let currentProgress = parseFloat(progressBar.style.width) || 0;
                let targetVisualProgress = currentProgress; // What we aim for this frame

                // --- Prioritize Real Progress --- 
                if (data.realProgress !== null) { // Check if realProgress has a value
                    targetVisualProgress = data.realProgress; // Jump directly
                    // Only update DOM if significantly different to avoid thrashing
                    if (Math.abs(currentProgress - targetVisualProgress) > 0.1) { 
                        progressBar.style.width = `${targetVisualProgress}%`;
                        progressTextElement.textContent = `${Math.round(targetVisualProgress)}%`;
                        // console.log(`Jumped ${machineId} to real progress: ${targetVisualProgress.toFixed(1)}%`);
                    }
                    data.realProgress = null; // Consume the real progress value
                    needsMoreFrames = true; // Might need to animate towards target later if target > real
                } 
                // --- Fallback to Interpolation --- 
                else if (data.targetProgress !== undefined) {
                    // Use targetVisualProgress from potential real jump above as starting point
                    currentProgress = targetVisualProgress; 
                    if (currentProgress < data.targetProgress) {
                        const increment = (data.targetProgress - currentProgress) * 0.1; // Adjust for speed
                        targetVisualProgress = Math.min(data.targetProgress, currentProgress + increment);
                        progressBar.style.width = `${targetVisualProgress}%`;
                        progressTextElement.textContent = `${Math.round(targetVisualProgress)}%`;
                        needsMoreFrames = true; // Continue animating
                        // console.log(`Interpolating ${machineId} towards ${data.targetProgress.toFixed(1)}% (current: ${targetVisualProgress.toFixed(1)}%)`);
                    } else if (currentProgress > data.targetProgress) {
                       // If current visual > target (e.g., after a real jump), 
                       // just hold the current visual progress. Don't regress.
                       targetVisualProgress = currentProgress; 
                       // Check if target still needs update
                       if (data.targetProgress > 0) needsMoreFrames = true; 
                    } else {
                       // currentProgress == data.targetProgress, potentially stop animating
                       if (data.targetProgress < 100 && data.targetProgress > 0) {
                           // Keep checking if new data comes in
                           needsMoreFrames = true; 
                       }
                    }
                }
            });

            if (needsMoreFrames) {
                animationFrameId = requestAnimationFrame(updateFrame);
            } else {
                // console.log("Animation loop stopping.");
                animationFrameId = null;
            }
        }
        // console.log("Animation loop starting.");
        animationFrameId = requestAnimationFrame(updateFrame);
    }

    // SSE connection setup
    function connectEventSource() {
        // Check if already connected
        if (window.dragonflyEvtSource && window.dragonflyEvtSource.readyState !== EventSource.CLOSED) {
            return; 
        }

        if (evtSource) { // Reuse existing evtSource variable if page reloaded strangely
            evtSource.close();
        }

        evtSource = new EventSource('/api/events');
        window.dragonflyEvtSource = evtSource; // Store globally to check existence
        window.globalEvtSource = evtSource; // Also store as globalEvtSource for compatibility
        
        evtSource.onmessage = function(event) {
            try {
                // Parse the JSON data
                const data = JSON.parse(event.data);
                
                // Find the machine row in the table
                const machineRow = document.querySelector(`tr[data-machine-id="${data.id}"]`);
                if (!machineRow) return; // Not found in this table
                
                // Find the status badge within the row
                const statusBadge = machineRow.querySelector('.machine-status-badge');
                if (!statusBadge) return;
                
                // Update the status indicator
                if (data.state) {
                    if (data.state === 'STATE_FAILED') {
                        statusBadge.textContent = 'Failed';
                        statusBadge.classList.remove('bg-yellow-100', 'text-yellow-800', 'dark:bg-yellow-400/10', 'dark:text-yellow-300', 
                                                   'bg-green-100', 'text-green-800', 'dark:bg-green-400/10', 'dark:text-green-300');
                        statusBadge.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-400/10', 'dark:text-red-300');
                    } else if (data.state === 'STATE_SUCCESS') {
                        statusBadge.textContent = 'Success';
                        statusBadge.classList.remove('bg-yellow-100', 'text-yellow-800', 'dark:bg-yellow-400/10', 'dark:text-yellow-300',
                                                   'bg-red-100', 'text-red-800', 'dark:bg-red-400/10', 'dark:text-red-300');
                        statusBadge.classList.add('bg-green-100', 'text-green-800', 'dark:bg-green-400/10', 'dark:text-green-300');
                    }
                }
                
                // Update progress if machine is installing OS
                if (statusBadge.textContent === 'Installing OS' || data.state === 'STATE_RUNNING') {
                    const progressBar = machineRow.querySelector('.workflow-progress-bar');
                    const progressText = machineRow.querySelector('.flex.justify-between.text-xs span:first-child');
                    
                    if (progressBar && typeof data.progress === 'number') {
                        // Use ratcheting to prevent progress going backwards
                        const currentWidth = progressBar.style.width || '0%';
                        const currentProgress = parseInt(currentWidth.replace('%', ''), 10) || 0;
                        const newProgress = Math.max(currentProgress, data.progress);
                        
                        progressBar.style.width = `${newProgress}%`;
                        if (progressText) {
                            progressText.textContent = `${newProgress}%`;
                        }
                        
                        // Show the container if it was hidden
                        const progressContainer = machineRow.querySelector('.progress-container');
                        if (progressContainer) {
                            progressContainer.classList.remove('hidden');
                        }
                    }
                    
                    // Update current action text if available
                    const actionText = machineRow.querySelector('.flex.justify-between.text-xs span:last-child');
                    if (actionText && data.current_action) {
                        actionText.textContent = data.current_action;
                        actionText.parentElement.classList.remove('hidden');
                    }
                }
                
                // If installation is complete, refresh the table
                if (data.status && data.status !== 'InstallingOS') {
                    refreshMachineList();
                }
            } catch (error) {
                // Silent error handling
            }
        };
        
        evtSource.onerror = function(error) {
            if (evtSource) {
                evtSource.close();
            }
            
            // Try to reconnect after a delay
            setTimeout(connectEventSource, 2000);
        };
        
        // Attach event handlers for 'machine_updated' event
        evtSource.addEventListener('machine_updated', function(event) {
            try {
                const data = JSON.parse(event.data);
                if (data.type === "machine_updated") {
                    // Refresh the machine list after a short delay to allow state to update
                    setTimeout(refreshMachineList, 200);
                }
            } catch (e) {
                // Silent error handling
            }
        });

        // Attach event handlers for 'ip_download_progress' event
        evtSource.addEventListener('ip_download_progress', function(event) {
            try {
                const data = JSON.parse(event.data);
                const machineIp = data.ip;
                
                // Find machine row by IP (more robust if multiple machines share IP initially?)
                // For now, assume IP is unique enough during installation
                const machineRows = document.querySelectorAll(`td:nth-child(3) > div > span:first-child:not([x-show])`); // Find IP address spans
                let targetMachineId = null;
                machineRows.forEach(span => {
                    if (span.textContent.trim() === machineIp) {
                        const row = span.closest('tr');
                        if(row) {
                            targetMachineId = row.getAttribute('data-machine-id');
                        }
                    }
                });

                if (targetMachineId && data.bytes_downloaded !== undefined && data.total_size !== undefined) {
                    const fileName = data.file_name || "File Download";
                    const bytesDownloaded = parseInt(data.bytes_downloaded) || 0;
                    const totalSize = parseInt(data.total_size) || 0;
                    
                    // *** Calculate the actual file download percentage ***
                    const fileProgressPercent = (totalSize > 0) ? (bytesDownloaded / totalSize * 100) : 0;
                    
                    // Only update progress if the task seems related to downloading/streaming
                    // We infer this if the filename suggests an image or kernel/initrd
                    let taskName = "Unknown Download";
                    const lowerFileName = fileName.toLowerCase();
                    if (lowerFileName.includes("vmlinuz") || lowerFileName.includes("kernel")) {
                        taskName = "Downloading kernel";
                    } else if (lowerFileName.includes("initrd") || lowerFileName.includes("initramfs")) {
                        taskName = "Downloading initramfs";
                    } else if (lowerFileName.includes(".img") || lowerFileName.includes(".iso") || lowerFileName.includes("cloudimg") || lowerFileName.includes("stream image")) {
                        taskName = "Streaming image"; // Use a consistent name
                    } else {
                        // If filename doesn't match known patterns, don't update progress bar based on this event
                        return; 
                    }
                    
                    // Use the CALCULATED percentage for the update
                    updateMachineProgress(targetMachineId, fileProgressPercent, taskName, bytesDownloaded, totalSize);
                }
            } catch (e) {
                console.error("Error processing ip_download_progress:", e, event.data);
            }
        });
    }

    let evtSource = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize SSE connection
        connectEventSource();
        
        // Listen for image progress events and update UI
        if (window.globalEvtSource) {
            // Handler for task-specific progress events
            window.globalEvtSource.addEventListener('task_progress', function(event) {
                try {
                    const rawData = event.data;
                    
                    // Format: "machine_id:task_name:percentage:bytes_downloaded:total_size"
                    const parts = rawData.split(':');
                    if (parts.length >= 5) {
                        const machineId = parts[0];
                        const taskName = parts[1];
                        const progressPercent = parseFloat(parts[2]);
                        const bytesDownloaded = parseInt(parts[3], 10);
                        const totalSize = parseInt(parts[4], 10);
                        
                        // Update the machine's progress bar in the machine list
                        updateMachineProgress(machineId, progressPercent, taskName, bytesDownloaded, totalSize);
                    }
                } catch (e) {
                    // Error processing task progress event
                }
            });
            
            // Handler for file-specific progress events
            window.globalEvtSource.addEventListener('file_progress', function(event) {
                try {
                    const rawData = event.data;
                    
                    // Format: "filename:percentage:bytes_downloaded:total_size"
                    const parts = rawData.split(':');
                    if (parts.length >= 4) {
                        const fileName = parts[0];
                        const progressPercent = parseFloat(parts[1]);
                        const bytesDownloaded = parseInt(parts[2], 10);
                        const totalSize = parseInt(parts[3], 10);
                        
                        // Determine task name based on filename
                        let taskName = "Downloading file";
                        if (fileName.includes("vmlinuz")) {
                            taskName = "Downloading kernel";
                        } else if (fileName.includes("initrd") || fileName.includes("initramfs")) {
                            taskName = "Downloading initramfs";
                        } else if (fileName.includes(".img") || fileName.includes(".iso") || fileName.includes("cloudimg")) {
                            taskName = "Downloading OS image";
                        }
                        
                        // Update progress for all machines that are installing OS
                        // (We don't know which machine this is for from this event type)
                        const installingMachines = document.querySelectorAll('tr span:contains("Installing OS")');
                        installingMachines.forEach(statusEl => {
                            const machineRow = statusEl.closest('tr');
                            if (machineRow) {
                                const machineId = machineRow.getAttribute('data-machine-id');
                                if (machineId) {
                                    updateMachineProgress(machineId, progressPercent, taskName, bytesDownloaded, totalSize);
                                }
                            }
                        });
                    }
                } catch (e) {
                    // Error processing file progress event
                }
            });
            
            // For backward compatibility
            window.globalEvtSource.addEventListener('image_progress', function(event) {
                try {
                    const rawData = event.data;
                    
                    // Format: "image_file:percent:total_size"
                    const parts = rawData.split(':');
                    if (parts.length >= 3) {
                        const imageFile = parts[0];
                        const progressPercent = parseFloat(parts[1]);
                        const totalSize = parseInt(parts[2], 10);
                        
                        // Update any machines that are in "Installing OS" state
                        const installingMachines = document.querySelectorAll('tr span:contains("Installing OS")');
                        installingMachines.forEach(statusElement => {
                            const machineRow = statusElement.closest('tr');
                            if (machineRow) {
                                const machineId = machineRow.getAttribute('data-machine-id');
                                if (machineId) {
                                    updateMachineProgress(machineId, progressPercent, "Downloading OS image", 0, totalSize);
                                }
                            }
                        });
                    }
                } catch (e) {
                    // Error processing image progress event
                }
            });
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (evtSource) {
                evtSource.close();
            }
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
        });
    });

    // MODIFIED Helper function to update machine progress data
    function updateMachineProgress(machineId, progressPercent, taskName, bytesDownloaded, totalSize) {
        // Initialize data structure if needed, adding realProgress
        if (!machineProgressData[machineId]) {
            machineProgressData[machineId] = { targetProgress: 0, realProgress: null, lastTaskName: null };
        }
        const data = machineProgressData[machineId];

        // Reset progress if task name changes
        if (data.lastTaskName !== taskName) {
            console.log(`Task changed for ${machineId}: '${data.lastTaskName}' -> '${taskName}'. Resetting progress.`);
            data.targetProgress = 0; 
            data.realProgress = null;
            data.lastTaskName = taskName;
        }

        // Update Target Progress (using existing logic)
        data.targetProgress = Math.max(
            progressPercent,
            data.targetProgress || 0
        );

        // --- ADDED: Calculate and Store Real Progress --- 
        if (bytesDownloaded !== undefined && bytesDownloaded !== null && totalSize !== undefined && totalSize !== null) {
            const realPercent = (totalSize > 0) ? (bytesDownloaded / totalSize * 100) : 0;
            data.realProgress = Math.max(
                 realPercent,
                 (data.realProgress !== null ? data.realProgress : 0) 
             ); 
            // console.log(`Real progress update stored for ${machineId} (${taskName}): ${data.realProgress.toFixed(1)}%`);
        } // else: Don't overwrite realProgress if it's just an estimated update
        
        // Find the machine row and update static text (action/byte counts)
        const machineRow = document.querySelector(`tr[data-machine-id=\"${machineId}\"]`);
        if (!machineRow) return;
        const actionTextElement = machineRow.querySelector('.flex.justify-between.text-xs span:last-child');
        const progressContainer = machineRow.querySelector('.flex.flex-col.space-y-1');

        if (actionTextElement && progressContainer) {
            progressContainer.classList.remove('hidden');
            progressContainer.classList.add('pointer-events-none');
            // --- ADDED: Update Action Text with MB/Total MB --- 
            if (totalSize !== undefined && totalSize !== null && totalSize > 0) {
                const totalMB = (totalSize / (1024 * 1024)).toFixed(1);
                if (bytesDownloaded !== undefined && bytesDownloaded !== null && bytesDownloaded >= 0) {
                    const downloadedMB = (bytesDownloaded / (1024 * 1024)).toFixed(1);
                    actionTextElement.textContent = `${taskName} (${downloadedMB}/${totalMB} MB)`;
                } else {
                    actionTextElement.textContent = `${taskName} (${totalMB} MB)`;
                }
            } else {
                actionTextElement.textContent = taskName;
            }
        }
        
        // Start/continue the animation loop
        startProgressAnimation();
    }
    
    // Function to refresh the machine list (Keep this)
    function refreshMachineList() {
        fetch('/machines')
            .then(response => response.text())
            .then(html => {
                // Create a temporary element to parse the HTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // Extract the machine list rows
                const newMachineList = tempDiv.querySelector('#machine-list');
                if (newMachineList) {
                    // Get the current machine list
                    const currentMachineList = document.getElementById('machine-list');
                    if (currentMachineList) {
                        // Replace the content
                        currentMachineList.innerHTML = newMachineList.innerHTML;
                        
                        // Re-initialize Alpine.js if needed
                        if (window.Alpine) {
                            window.Alpine.initTree(currentMachineList);
                        }
                    }
                }
            })
            .catch(error => {
                // Handle error silently
            });
    }
</script>
{% endblock %}