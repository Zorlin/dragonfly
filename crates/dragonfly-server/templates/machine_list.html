{% extends "base.html" %}

{% block title %}Dragonfly - Machines{% endblock %}

{% block content %}
<div class="px-4 sm:px-6 lg:px-8" x-data="{ updateDebounceTimer: null }">
    <div class="sm:flex sm:items-center">
        <div class="sm:flex-auto">
            <h1 class="text-xl font-semibold text-gray-900 dark:text-white">Machines</h1>
            <p class="mt-2 text-sm text-gray-700 dark:text-gray-300">A list of all machines that have been discovered or added.</p>
        </div>
    </div>
    <div class="mt-8 flex flex-col">
        <div class="-my-2 -mx-4 overflow-x-auto sm:-mx-6 lg:-mx-8">
            <div class="inline-block min-w-full py-2 align-middle md:px-6 lg:px-8">
                <div class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 md:rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-800">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                    Name
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                    MAC Address
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                    IP Address
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                    Status
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                    OS
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody 
                            id="machine-list" 
                            class="divide-y divide-gray-200 dark:divide-gray-600 bg-white dark:bg-gray-800" 
                            hx-get="/api/machines" 
                            hx-trigger="load, refreshMachines from:body"
                            hx-swap="innerHTML transition:true"
                        >
                            {% for machine in machines %}
                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="text-sm font-medium text-gray-900 dark:text-white">
                                            <a href="/machines/{{ machine.id }}" class="hover:text-indigo-600 dark:hover:text-indigo-400">
                                                {% if machine.hostname.is_some() %}
                                                    {{ machine.hostname.as_ref().unwrap() }}
                                                {% else if machine.memorable_name.is_some() %}
                                                    {{ machine.memorable_name.as_ref().unwrap() }}
                                                {% else %}
                                                    {% let id_str = machine.id.to_string() %}{{ id_str }}
                                                {% endif %}
                                            </a>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                    {{ machine.mac_address }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                    {{ machine.ip_address }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    {% match machine.status %}
                                        {% when MachineStatus::AwaitingAssignment %}
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200">
                                                Awaiting Assignment
                                            </span>
                                        {% when MachineStatus::InstallingOS %}
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-700/30 dark:text-yellow-200">
                                                Installing OS
                                            </span>
                                        {% when MachineStatus::Ready %}
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-700/30 dark:text-green-200">
                                                Ready
                                            </span>
                                        {% when MachineStatus::Error with (msg) %}
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-700/30 dark:text-red-200" title="{{ msg }}">
                                                Error
                                            </span>
                                        {% when MachineStatus::ExistingOS %}
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-700/30 dark:text-blue-200">
                                                Existing OS
                                            </span>
                                        {% when MachineStatus::Offline %}
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200">
                                                Offline
                                            </span>
                                    {% endmatch %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                    {% if machine.os_choice.is_some() %}
                                        üñ•Ô∏è {{ machine.os_choice.as_ref().unwrap() }}
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                    {% if machine.status == MachineStatus::InstallingOS %}
                                        {% if let Some(info) = workflow_infos.get(machine.id) %}
                                            <div class="flex flex-col space-y-1">
                                                <div class="flex justify-between text-xs">
                                                    <span>{{ info.progress }}%</span>
                                                    {% if info.current_action.is_some() %}
                                                        <span class="ml-2 truncate max-w-[120px]">
                                                            {{ info.current_action.as_ref().unwrap() }}
                                                        </span>
                                                    {% endif %}
                                                </div>
                                                <div class="w-full bg-gray-200 rounded-full h-2 dark:bg-gray-700">
                                                    <div class="bg-yellow-500 h-2 rounded-full dark:bg-yellow-600 workflow-progress-bar" data-machine-id="{{ machine.id }}" data-progress="{{ info.progress }}" style="width: {{ info.progress }}%"></div>
                                                </div>
                                            </div>
                                        {% endif %}
                                    {% else %}
                                        <div class="flex space-x-1">
                                            <a href="/machines/{{ machine.id }}" class="inline-flex items-center px-2.5 py-1 border border-transparent text-xs leading-4 font-medium rounded text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:bg-indigo-900 dark:text-indigo-200 dark:hover:bg-indigo-800">
                                                View
                                            </a>
                                            {% if is_admin %}
                                                <button onclick="showOsModal('{{ machine.id }}')" class="inline-flex items-center px-2.5 py-1 border border-transparent text-xs leading-4 font-medium rounded text-emerald-700 bg-emerald-100 hover:bg-emerald-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 dark:bg-emerald-900 dark:text-emerald-200 dark:hover:bg-emerald-800">
                                                    OS
                                                </button>
                                                <button onclick="showStatusModal('{{ machine.id }}')" class="inline-flex items-center px-2.5 py-1 border border-transparent text-xs leading-4 font-medium rounded text-yellow-700 bg-yellow-100 hover:bg-yellow-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500 dark:bg-yellow-900 dark:text-yellow-200 dark:hover:bg-yellow-800">
                                                    Status
                                                </button>
                                                <button onclick="showDeleteModal('{{ machine.id }}')" class="inline-flex items-center px-2.5 py-1 border border-transparent text-xs leading-4 font-medium rounded text-red-700 bg-red-100 hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 dark:bg-red-900 dark:text-red-200 dark:hover:bg-red-800">
                                                    Delete
                                                </button>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="status-modal" class="relative z-10" aria-labelledby="modal-title" role="dialog" aria-modal="true" x-show="statusModal" x-cloak>
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto" @click="statusModal = false">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-lg bg-white px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6" 
                @click.stop>
                <!-- Status modal content -->
            </div>
        </div>
    </div>
</div>

<div id="os-modal" class="relative z-10" aria-labelledby="modal-title" role="dialog" aria-modal="true" x-show="osModal" x-cloak>
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto" @click="osModal = false">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-lg bg-white px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6" 
                @click.stop>
                <!-- OS modal content -->
            </div>
        </div>
    </div>
</div>

<div id="delete-modal" class="relative z-10" aria-labelledby="modal-title" role="dialog" aria-modal="true" x-show="deleteModal" x-cloak>
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto" @click="deleteModal = false">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-lg bg-white px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6" 
                @click.stop>
                <!-- Delete modal content -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Check if user is authenticated before allowing admin actions
    function requireAdmin(callback) {
        if (!window.isAuthenticated) {
            alert("You need to be logged in as admin to perform this action.");
            return false;
        }
        return callback();
    }

    // Override the show modal functions to check for admin
    function showStatusModal(id) {
        requireAdmin(() => {
            statusModal = true;
            // Load status form
            fetch(`/api/machines/${id}/status`)
                .then(response => response.text())
                .then(html => {
                    document.querySelector('#status-modal > div:nth-child(2) > div > div').innerHTML = html;
                });
        });
    }

    function showOsModal(id) {
        requireAdmin(() => {
            osModal = true;
            // Load OS selection form
            fetch(`/api/machines/${id}/os`)
                .then(response => response.text())
                .then(html => {
                    document.querySelector('#os-modal > div:nth-child(2) > div > div').innerHTML = html;
                });
        });
    }

    function showDeleteModal(id) {
        requireAdmin(() => {
            deleteModal = true;
            // Prepare delete confirmation
            const content = `
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                        <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                        </svg>
                    </div>
                    <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left">
                        <h3 class="text-base font-semibold leading-6 text-gray-900" id="modal-title">Delete Machine</h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500">
                                Are you sure you want to delete this machine? This action cannot be undone.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                    <button 
                        type="button" 
                        class="inline-flex w-full justify-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 sm:ml-3 sm:w-auto"
                        onclick="deleteMachine('${id}')">
                        Delete
                    </button>
                    <button 
                        type="button" 
                        class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto"
                        onclick="deleteModal = false">
                        Cancel
                    </button>
                </div>
            `;
            document.querySelector('#delete-modal > div:nth-child(2) > div > div').innerHTML = content;
        });
    }

    function deleteMachine(id) {
        requireAdmin(() => {
            fetch(`/api/machines/${id}`, {
                method: 'DELETE',
            })
            .then(response => {
                if (response.ok) {
                    deleteModal = false;
                    htmx.trigger(document.querySelector('tbody'), 'refreshMachines');
                } else {
                    alert('Error deleting machine');
                }
            });
        });
    }

    // Debounced refresh function
    function debouncedRefresh() {
        clearTimeout(window._updateDebounceTimer);
        window._updateDebounceTimer = setTimeout(() => {
            htmx.trigger(document.body, 'refreshMachines');
        }, 250); // 250ms debounce
    }

    // Handle successful HTMX requests
    document.body.addEventListener('htmx:afterRequest', function(event) {
        if (event.detail.successful && event.detail.pathInfo.requestPath !== '/api/machines') {
            debouncedRefresh();
        }
    });

    // Server-sent events handling
    let evtSource = null;
    let reconnectAttempts = 0;
    const MAX_RECONNECT_ATTEMPTS = 5;
    
    // Map to track progress bars on the page
    let progressBars = {};
    let animationFrameId = null;
    
    // Function to update progress bars with smooth animation
    function updateProgressBarsAnimation() {
        let needsUpdate = false;
        
        // Update each progress bar
        for (const machineId in progressBars) {
            const {current, target} = progressBars[machineId];
            if (Math.abs(current - target) > 0.1) {
                // Smoothly animate towards target
                const delta = (target - current) * 0.1;
                progressBars[machineId].current += delta;
                needsUpdate = true;
                
                // Update the DOM
                const progressBar = document.querySelector(`.workflow-progress-bar[data-machine-id="${machineId}"]`);
                if (progressBar) {
                    // Update width
                    progressBar.style.width = `${Math.round(progressBars[machineId].current)}%`;
                    
                    // Update text
                    const textDisplay = progressBar.closest('div').previousElementSibling.querySelector('span:first-child');
                    if (textDisplay) {
                        textDisplay.textContent = `${Math.round(progressBars[machineId].current)}%`;
                    }
                }
            }
        }
        
        // Continue animation if needed
        if (needsUpdate) {
            animationFrameId = requestAnimationFrame(updateProgressBarsAnimation);
        } else {
            animationFrameId = null;
        }
    }
    
    // Initialize progress tracking
    function initializeProgressBars() {
        progressBars = {};
        document.querySelectorAll('.workflow-progress-bar').forEach(bar => {
            const machineId = bar.getAttribute('data-machine-id');
            const progress = parseInt(bar.getAttribute('data-progress'), 10);
            
            progressBars[machineId] = {
                current: progress,
                target: progress
            };
        });
        
        // Start animation if not already running
        if (Object.keys(progressBars).length > 0 && !animationFrameId) {
            animationFrameId = requestAnimationFrame(updateProgressBarsAnimation);
        }
    }
    
    // Update progress targets when the machine list refreshes
    document.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'machine-list') {
            // Save the current progress values
            const oldProgressBars = {...progressBars};
            
            // Initialize with new elements
            initializeProgressBars();
            
            // Reuse old progress values for bars that existed before
            for (const machineId in oldProgressBars) {
                if (progressBars[machineId]) {
                    progressBars[machineId].current = oldProgressBars[machineId].current;
                }
            }
        }
    });

    function connectEventSource() {
        if (evtSource) {
            evtSource.close();
        }

        evtSource = new EventSource('/api/events');
        
        evtSource.onmessage = function(event) {
            console.log('Event received:', event.data);
            const [type, id] = event.data.split(':');
            
            switch(type) {
                case 'machine_discovered':
                    console.log('New machine discovered!');
                    debouncedRefresh();
                    break;
                case 'machine_updated':
                    console.log('Machine updated!');
                    debouncedRefresh();
                    break;
                case 'machine_deleted':
                    console.log('Machine deleted!');
                    debouncedRefresh();
                    break;
            }
        };

        evtSource.onopen = function() {
            console.log('EventSource connected');
            reconnectAttempts = 0;
        };

        evtSource.onerror = function(err) {
            console.error("EventSource failed:", err);
            evtSource.close();
            
            if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                reconnectAttempts++;
                const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
                console.log(`Reconnecting in ${delay}ms (attempt ${reconnectAttempts})`);
                setTimeout(connectEventSource, delay);
            }
        };
    }

    // Initial connection
    connectEventSource();
    
    // Initialize progress bars on page load
    document.addEventListener('DOMContentLoaded', function() {
        initializeProgressBars();
    });

    // Clean up when leaving the page
    window.addEventListener('beforeunload', () => {
        if (evtSource) {
            evtSource.close();
        }
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
        }
    });
</script>
{% endblock %}