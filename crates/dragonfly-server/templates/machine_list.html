{% extends "base.html" %}

{% block title %}Dragonfly - Machines{% endblock %}

{% block content %}


<div class="px-4 sm:px-6 lg:px-8" x-data="{
    isAuthenticated: {{ is_authenticated }},
    updateDebounceTimer: null,
    statusModal: false,
    osModal: false,
    deleteModal: false,
    tagModal: false,
    reimageModal: false,
    powerModal: false,
    macConfirmModal: false,
    addMachineModal: false, // New modal for adding machines
    showManagedMachineModal: false, // NEW modal for the managed machine form
    externalMachineModal: false, // Placeholder for external machine modal state
    cloudMachineModal: false, // Placeholder for cloud machine modal state
    proxmoxMachineModal: false, // << NEW Proxmox Machine modal state >>
    temporaryNodeModal: false, // Placeholder for temporary node modal state
    discoverMachinesModal: false, // Placeholder for discover machines modal state
    bmcMachineModal: false, // BMC Machine modal
    currentMachineId: null,
    currentMachineName: null,
    newMacAddress: null,
    osDropdowns: {}, // Track open state of OS dropdowns
    editingField: null, // Track which field is being edited
    fieldChanges: {}, // Track changes to fields
    originalValues: {}, // Track original values for fields
    pendingChanges: false, // Whether there are unsaved changes
    errorMessage: null, // Added for modals that might need it
    reimageModalOpen: false,
    reimageTargetMachine: null,
    showBulkActions: false, // Controls visibility of bulk action header
    selectAll: false, // State for the header checkbox
    selectedMachines: {}, // Object to track selected machine IDs { machineId: true/false }
    
    // Just Type functionality
    startEditing(machineId, fieldName, currentValue) {
        // Don't allow editing if not authenticated
        if (!this.isAuthenticated) return;
        
        // Store the field being edited
        this.editingField = `${machineId}-${fieldName}`;
        
        // Store the original value
        if (!this.originalValues[machineId]) {
            this.originalValues[machineId] = {};
        }
        this.originalValues[machineId][fieldName] = currentValue;
        
        // Initialize changes object if needed
        if (!this.fieldChanges[machineId]) {
            this.fieldChanges[machineId] = {};
        }
    },
    
    updateField(machineId, fieldName, newValue) {
        // Update the changes object
        if (!this.fieldChanges[machineId]) {
            this.fieldChanges[machineId] = {};
        }
        
        // Check if the value has actually changed
        if (newValue !== this.originalValues[machineId][fieldName]) {
            this.fieldChanges[machineId][fieldName] = newValue;
            this.pendingChanges = true;
        } else {
            // If value is back to original, remove it from changes
            delete this.fieldChanges[machineId][fieldName];
            
            // Check if there are any changes left for this machine
            if (Object.keys(this.fieldChanges[machineId]).length === 0) {
                delete this.fieldChanges[machineId];
            }
            
            // Check if there are any changes left at all
            this.pendingChanges = Object.keys(this.fieldChanges).length > 0;
        }
    },
    
    stopEditing() {
        this.editingField = null;
    },
    
    // Validate a MAC address
    validateMac(mac) {
        return /^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$/.test(mac);
    },
    
    // Validate a hostname (RFC-1123 compliant)
    validateHostname(hostname) {
        return /^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(hostname);
    },
    
    // Validate an IP address
    validateIp(ip) {
        return /^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(ip);
    },
    
    // Apply changes to a specific machine (excluding OS choice, handled by selectOs)
    applyChanges(machineId) {
        if (!this.fieldChanges[machineId]) return;
        
        const changes = this.fieldChanges[machineId];
        const payload = {};
        
        // Build payload with non-OS changes
        Object.keys(changes).forEach(field => {
            if (field !== 'os_choice') { // Ensure os_choice is not included
                payload[field] = changes[field];
            }
        });

        // Only proceed if there are actual non-OS changes
        if (Object.keys(payload).length === 0) {
            console.warn('Apply called with no non-OS changes');
            // Optionally clear the (empty) changes if needed
            delete this.fieldChanges[machineId];
            this.pendingChanges = Object.keys(this.fieldChanges).length > 0;
            return;
        }
        
        // --- Apply Other Field Changes (Hostname, IP, MAC) --- 
        fetch(`/api/machines/${machineId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload)
        })
        .then(response => {
            if (!response.ok) {
                // Assume JSON error for this endpoint
                 return response.json().then(data => {
                    throw new Error(data.message || `HTTP error! Status: ${response.status}`);
                });
            }
            return response.json();
        })
        .then(data => {
            // Clear applied changes
            Object.keys(payload).forEach(field => {
                delete this.fieldChanges[machineId][field];
            });
            if (Object.keys(this.fieldChanges[machineId]).length === 0) {
                delete this.fieldChanges[machineId];
            }
            this.pendingChanges = Object.keys(this.fieldChanges).length > 0;
            
            showToast(`Machine ${machineId} updated: ${data.message || 'Changes applied'}`, 'success');
            refreshMachineList();
        })
        .catch(error => {
            console.error('Error applying other changes:', error);
            showToast(`Failed to update machine: ${error.message}`, 'error');
        });
    },
    
    // Check if field has changes
    hasFieldChanged(machineId, fieldName) {
        return this.fieldChanges[machineId] && 
               this.fieldChanges[machineId][fieldName] !== undefined &&
               this.fieldChanges[machineId][fieldName] !== this.originalValues[machineId][fieldName];
    },
    
    confirmMacChange(machineId) {
        const newMac = this.fieldChanges[machineId].mac_address;
        
        if (!this.validateMac(newMac)) {
            showToast('Invalid MAC address format. Please use XX:XX:XX:XX:XX:XX format.', 'error');
            return;
        }
        
        this.currentMachineId = machineId;
        this.newMacAddress = newMac;
        this.macConfirmModal = true;
    },
    
    confirmMacChangeApply() {
        this.applyChanges(this.currentMachineId);
        this.macConfirmModal = false;
    },
    
    cancelMacChange() {
        // Revert changes if user cancels
        delete this.fieldChanges[this.currentMachineId].mac_address;
        if (Object.keys(this.fieldChanges[this.currentMachineId]).length === 0) {
            delete this.fieldChanges[this.currentMachineId];
        }
        this.pendingChanges = Object.keys(this.fieldChanges).length > 0;
        
        // Refresh the display
        refreshMachineList();
        
        this.macConfirmModal = false;
    },
    
    openTagModal(id, name) { this.tagModal = true; this.currentMachineId = id; this.currentMachineName = name; },
    openReimageModal(id) { this.reimageModal = true; this.currentMachineId = id; },
    openPowerModal(id) { this.powerModal = true; this.currentMachineId = id; },
    openDeleteModal(id) { this.deleteModal = true; this.currentMachineId = id; },
    toggleOsDropdown(id) { 
        this.osDropdowns[id] = !this.osDropdowns[id]; 
        // Close all other dropdowns
        Object.keys(this.osDropdowns).forEach(key => {
            if (key !== id && this.osDropdowns[key]) this.osDropdowns[key] = false;
        });
    },
    selectOs(id, os) {
        if (!this.isAuthenticated) {
            showToast('Authentication required.', 'error');
            return;
        }
        
        // Close the dropdown immediately
        this.osDropdowns[id] = false;
        
        // Immediately send API request to update os_choice
        fetch(`/api/machines/${id}/os`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ os_choice: os })
        })
        .then(response => {
            if (!response.ok) {
                // Handle potential HTML error response
                 if (response.headers.get('content-type')?.includes('text/html')) {
                    return response.text().then(html => { 
                        const errorMatch = html.match(/<span class='font-medium'>Error!\s*<\/span>\s*(.*)/i);
                        throw new Error(errorMatch ? errorMatch[1].trim() : `HTTP error! Status: ${response.status}`); 
                    });
                } else {
                    return response.json().then(data => {
                        throw new Error(data.message || `HTTP error! Status: ${response.status}`);
                    });
                }
            }
            return response.text(); // Expecting HTML success response 
        })
        .then(() => {
            showToast(`OS choice for ${id} updated to ${os}.`, 'success');
            refreshMachineList(); // Refresh to show the updated choice visually
        })
        .catch(error => {
            console.error('Error selecting OS:', error);
            showToast(`Failed to set OS choice: ${error.message}`, 'error');
        });
    },
    
    // New function to cancel a pending OS choice
    cancelOsChoice(machineId) {
        if (!this.isAuthenticated) {
            showToast('Authentication required.', 'error');
            return;
        }
        
        // Send API request to clear os_choice
        fetch(`/api/machines/${machineId}/os`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ os_choice: '' }) // Send empty string to clear
        })
        .then(response => {
            if (!response.ok) {
                // Handle potential HTML error response
                 if (response.headers.get('content-type')?.includes('text/html')) {
                    return response.text().then(html => { 
                        const errorMatch = html.match(/<span class='font-medium'>Error!\s*<\/span>\s*(.*)/i);
                        throw new Error(errorMatch ? errorMatch[1].trim() : `HTTP error! Status: ${response.status}`); 
                    });
                } else {
                    return response.json().then(data => {
                        throw new Error(data.message || `HTTP error! Status: ${response.status}`);
                    });
                }
            }
            return response.text(); // Expecting HTML success response 
        })
        .then(() => {
            // Clear local state if needed (applyChanges might not have been hit yet)
            if (this.fieldChanges[machineId] && this.fieldChanges[machineId].os_choice) {
                delete this.fieldChanges[machineId].os_choice;
                 if (Object.keys(this.fieldChanges[machineId]).length === 0) {
                    delete this.fieldChanges[machineId];
                }
                this.pendingChanges = Object.keys(this.fieldChanges).length > 0;
            }
            
            // Close dropdown
            this.osDropdowns[machineId] = false;
            
            showToast(`Pending OS change for ${machineId} cancelled.`, 'success');
            refreshMachineList(); // Refresh to reflect the cleared choice
        })
        .catch(error => {
            console.error('Error cancelling OS choice:', error);
            showToast(`Failed to cancel OS change: ${error.message}`, 'error');
            // Optionally close dropdown on error too?
            this.osDropdowns[machineId] = false;
        });
    },
    
    // Function to delete a machine
    deleteMachine(machineId) {
        if (!this.isAuthenticated) {
            showToast('Authentication required to delete machines.', 'error');
            return;
        }
        this.errorMessage = null; // Clear previous errors
        fetch(`/api/machines/${machineId}`, {
            method: 'DELETE',
            headers: {
                // Add any necessary headers like CSRF token if required by your backend
            }
        })
        .then(response => {
            if (!response.ok) {
                // Try to get error message from response body
                return response.text().then(text => {
                    throw new Error(text || `HTTP error! status: ${response.status}`);
                });
            }
            return response.text(); // Or response.json() if your API returns JSON
        })
        .then(data => {
            showToast(`Machine ${machineId} deleted successfully.`, 'success');
            this.deleteModal = false; // Close the modal
            this.currentMachineId = null;
            // Refresh the machine list using the new function
            refreshMachineList();
        })
        .catch(error => {
            this.errorMessage = `Failed to delete machine: ${error.message}`;
            showToast(this.errorMessage, 'error');
        });
    },
    
    initMachineList() {
        this.fetchMachines();
        this.setupSSE();
    },
    
    fetchMachines() {
        // Implementation of fetchMachines method
    },
    
    setupSSE() {
        // Implementation of setupSSE method
    },

    toggleSelectAll() {
        // Implementation of toggleSelectAll method
    }
}" x-init="window.isAuthenticated = isAuthenticated"
   @close-tag-modal.window="tagModal = false"
   @close-delete-modal.window="deleteModal = false"
   @click.window="stopEditing()">
    <div class="sm:flex sm:items-center">
        <div class="sm:flex-auto">
            <h1 class="text-xl font-semibold text-gray-900 dark:text-white">Machines</h1>
            <p class="mt-2 text-sm text-gray-700 dark:text-gray-300">A list of all machines that have been discovered or added.</p>
        </div>
        <div>
            <button type="button"
                    class="inline-flex items-center px-4 py-2 border border-purple-500 dark:border-purple-700 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-black hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                    {% if not is_authenticated %}style="display: none;"{% endif %}
                    @click="console.log('Clicked Add Machine button. Setting addMachineModal=true'); addMachineModal = true">
                <svg class="-ml-1 mr-2 h-5 w-5 text-gray-500 dark:text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="false">
                    <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                Add
            </button>
        </div>
    </div>
    <div class="mt-8 flex flex-col">
        <div class="-my-2 -mx-4 overflow-x-auto sm:-mx-6 lg:-mx-8">
          <div class="inline-block min-w-full py-2 align-middle md:px-6 lg:px-8">
            <div class="overflow-hidden rounded-xl border border-purple-500 dark:border-purple-700 shadow">
              <table class="min-w-full divide-y divide-gray-300 dark:divide-purple-800/50">
                <thead class="bg-gray-50 dark:bg-gray-950">      
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-200 uppercase tracking-wider">
                                    Name
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-200 uppercase tracking-wider">
                                    MAC Address
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-200 uppercase tracking-wider">
                                    IP Address
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-200 uppercase tracking-wider">
                                    Status
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-200 uppercase tracking-wider">
                                    OS
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-200 uppercase tracking-wider">
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody id="machine-list" class="divide-y divide-gray-200 dark:divide-gray-700/60 bg-white dark:bg-black">
                            {% for machine in machines %}
                            <tr class="hover:ring-purple-500 dark:hover:ring-purple-700/60 hover:bg-gray-50 dark:hover:bg-gray-700/50 cursor-pointer" 
                                @click="window.location='/machines/{{ machine.id }}'"
                                data-machine-id="{{ machine.id }}">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm font-medium text-gray-900 dark:text-white">
                                        <div x-on:click.stop="startEditing('{{ machine.id }}', 'hostname', '{{ machine.hostname|default('') }}')" 
                                             :class="{'cursor-text': isAuthenticated}" 
                                             class="hover:text-indigo-600 dark:hover:text-indigo-400">
                                            <span x-show="editingField !== '{{ machine.id }}-hostname'"
                                                  :class="{'text-purple-700 dark:text-purple-400 font-medium': hasFieldChanged('{{ machine.id }}', 'hostname')}">
                                                <span x-text="fieldChanges['{{ machine.id }}'] && fieldChanges['{{ machine.id }}'].hostname !== undefined ? 
                                                             fieldChanges['{{ machine.id }}'].hostname : 
                                                             '{% if machine.hostname %}{{ machine.hostname }}{% else %}Set hostname...{% endif %}'"></span>
                                            </span>
                                            <input x-show="editingField === '{{ machine.id }}-hostname'"
                                                   x-ref="hostname{{ machine.id }}"
                                                   x-on:click.stop
                                                   x-on:keydown.enter.stop="validateHostname($event.target.value) ? (updateField('{{ machine.id }}', 'hostname', $event.target.value), stopEditing()) : (showToast('Invalid hostname. Must follow RFC-1123 format.', 'error'), $event.target.value = originalValues['{{ machine.id }}']['hostname'], stopEditing())"
                                                   x-on:keydown.escape.stop="stopEditing()"
                                                   x-on:blur="validateHostname($event.target.value) ? (updateField('{{ machine.id }}', 'hostname', $event.target.value), stopEditing()) : (showToast('Invalid hostname. Must follow RFC-1123 format.', 'error'), $event.target.value = originalValues['{{ machine.id }}']['hostname'], stopEditing())"
                                                   x-effect="if(editingField === '{{ machine.id }}-hostname') setTimeout(() => $refs['hostname{{ machine.id }}'].focus(), 50)"
                                                   type="text"
                                                   value="{{ machine.hostname|default('') }}"
                                                   class="w-full border-b border-indigo-500 bg-transparent focus:outline-none focus:border-indigo-700 dark:text-white">
                                        </div>
                                        {# Display memorable_name below if it exists #}
                                        {% if machine.memorable_name %}
                                        <div x-on:click.stop="startEditing('{{ machine.id }}', 'memorable_name', '{{ machine.memorable_name }}')" 
                                             :class="{'cursor-text': isAuthenticated}"
                                             class="mt-1 text-xs text-gray-500 dark:text-gray-400 tracking-tight italic">
                                            <span x-show="editingField !== '{{ machine.id }}-memorable_name'"
                                                  :class="{'text-purple-700 dark:text-purple-400 font-medium': hasFieldChanged('{{ machine.id }}', 'memorable_name')}">
                                                <span x-text="fieldChanges['{{ machine.id }}'] && fieldChanges['{{ machine.id }}'].memorable_name !== undefined ? 
                                                             fieldChanges['{{ machine.id }}'].memorable_name : 
                                                             '{{ machine.memorable_name }}'"></span>
                                            </span>
                                            <input x-show="editingField === '{{ machine.id }}-memorable_name'"
                                                   x-ref="memorableName{{ machine.id }}"
                                                   x-on:click.stop
                                                   x-on:keydown.enter.stop="updateField('{{ machine.id }}', 'memorable_name', $event.target.value); stopEditing();"
                                                   x-on:keydown.escape.stop="stopEditing()"
                                                   x-on:blur="updateField('{{ machine.id }}', 'memorable_name', $event.target.value); stopEditing();"
                                                   x-effect="if(editingField === '{{ machine.id }}-memorable_name') setTimeout(() => $refs['memorableName{{ machine.id }}'].focus(), 50)"
                                                   type="text"
                                                   value="{{ machine.memorable_name }}"
                                                   class="w-full border-b border-indigo-500 bg-transparent focus:outline-none focus:border-indigo-700 dark:text-white text-xs">
                                        </div>
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400 tech-mono">
                                    <div x-on:click.stop="startEditing('{{ machine.id }}', 'mac_address', '{{ machine.mac_address }}')" 
                                         :class="{'cursor-text': isAuthenticated}">
                                        <span x-show="editingField !== '{{ machine.id }}-mac_address'"
                                              :class="{'text-purple-700 dark:text-purple-400 font-medium': hasFieldChanged('{{ machine.id }}', 'mac_address')}"
                                              class="tech-mono">
                                            <span x-text="fieldChanges['{{ machine.id }}'] && fieldChanges['{{ machine.id }}'].mac_address !== undefined ? 
                                                         fieldChanges['{{ machine.id }}'].mac_address : 
                                                         '{{ machine.mac_address }}'" class="tech-mono"></span>
                                        </span>
                                        <input x-show="editingField === '{{ machine.id }}-mac_address'"
                                               x-ref="macAddress{{ machine.id }}"
                                               x-on:click.stop
                                               x-on:keydown.enter.stop="validateMac($event.target.value) ? (updateField('{{ machine.id }}', 'mac_address', $event.target.value), stopEditing()) : (showToast('Invalid MAC address format. Must be XX:XX:XX:XX:XX:XX', 'error'), $event.target.value = originalValues['{{ machine.id }}']['mac_address'], stopEditing())"
                                               x-on:keydown.escape.stop="stopEditing()"
                                               x-on:blur="validateMac($event.target.value) ? (updateField('{{ machine.id }}', 'mac_address', $event.target.value), stopEditing()) : (showToast('Invalid MAC address format. Must be XX:XX:XX:XX:XX:XX', 'error'), $event.target.value = originalValues['{{ machine.id }}']['mac_address'], stopEditing())"
                                               x-effect="if(editingField === '{{ machine.id }}-mac_address') setTimeout(() => $refs['macAddress{{ machine.id }}'].focus(), 50)"
                                               type="text"
                                               value="{{ machine.mac_address }}"
                                               class="w-full border-b border-indigo-500 bg-transparent focus:outline-none focus:border-indigo-700 dark:text-white tech-mono">
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400 tech-mono">
                                    <div x-on:click.stop="startEditing('{{ machine.id }}', 'ip_address', '{{ machine.ip_address }}')" 
                                         :class="{'cursor-text': isAuthenticated}">
                                        <span x-show="editingField !== '{{ machine.id }}-ip_address'"
                                              :class="{'text-purple-700 dark:text-purple-400 font-medium': hasFieldChanged('{{ machine.id }}', 'ip_address')}"
                                              class="tech-mono">
                                            <span x-text="fieldChanges['{{ machine.id }}'] && fieldChanges['{{ machine.id }}'].ip_address !== undefined ? 
                                                         fieldChanges['{{ machine.id }}'].ip_address : 
                                                         '{{ machine.ip_address }}'" class="tech-mono"></span>
                                        </span>
                                        <input x-show="editingField === '{{ machine.id }}-ip_address'"
                                               x-ref="ipAddress{{ machine.id }}"
                                               x-on:click.stop
                                               x-on:keydown.enter.stop="validateIp($event.target.value) ? (updateField('{{ machine.id }}', 'ip_address', $event.target.value), stopEditing()) : (showToast('Invalid IP address format. Must be a valid IPv4 address.', 'error'), $event.target.value = originalValues['{{ machine.id }}']['ip_address'], stopEditing())"
                                               x-on:keydown.escape.stop="stopEditing()"
                                               x-on:blur="validateIp($event.target.value) ? (updateField('{{ machine.id }}', 'ip_address', $event.target.value), stopEditing()) : (showToast('Invalid IP address format. Must be a valid IPv4 address.', 'error'), $event.target.value = originalValues['{{ machine.id }}']['ip_address'], stopEditing())"
                                               x-effect="if(editingField === '{{ machine.id }}-ip_address') setTimeout(() => $refs['ipAddress{{ machine.id }}'].focus(), 50)"
                                               type="text"
                                               value="{{ machine.ip_address }}"
                                               class="w-full border-b border-indigo-500 bg-transparent focus:outline-none focus:border-indigo-700 dark:text-white tech-mono">
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-3 py-1 inline-flex text-sm leading-5 font-semibold rounded-full 
                                        {% if machine.status == "Ready" %}
                                            bg-green-100 text-green-800 dark:bg-green-400/10 dark:text-green-300 dark:border dark:border-green-500/20
                                        {% elif machine.status == "InstallingOS" %}
                                            bg-yellow-100 text-yellow-800 dark:bg-yellow-400/10 dark:text-yellow-300 dark:border dark:border-yellow-500/20
                                        {% elif machine.status == "AwaitingAssignment" %}
                                            bg-blue-100 text-blue-800 dark:bg-blue-400/10 dark:text-blue-300 dark:border dark:border-blue-500/20
                                        {% elif machine.status == "ExistingOS" %}
                                            bg-sky-100 text-sky-800 dark:bg-sky-400/10 dark:text-sky-300 dark:border dark:border-sky-500/20
                                        {% elif machine.status == "Offline" %}
                                            bg-gray-100 text-gray-800 dark:bg-gray-400/10 dark:text-gray-300 dark:border dark:border-gray-500/20
                                        {% elif machine.status == "Failed" or machine.status.startswith("Error") %}
                                            bg-red-100 text-red-800 dark:bg-red-400/10 dark:text-red-300 dark:border dark:border-red-500/20
                                        {% elif machine.status == "Deploying" %}
                                            bg-indigo-100 text-indigo-800 dark:bg-indigo-400/10 dark:text-indigo-300 dark:border dark:border-indigo-500/20
                                        {% else %}
                                            bg-red-100 text-red-800 dark:bg-red-400/10 dark:text-red-300 dark:border dark:border-red-500/20
                                        {% endif %}">
                                        {% if machine.status == "Ready" %}
                                            Ready
                                        {% elif machine.status == "InstallingOS" %}
                                            Installing OS
                                        {% elif machine.status == "AwaitingAssignment" %}
                                            Choose OS
                                        {% elif machine.status == "ExistingOS" %}
                                            Existing OS
                                        {% elif machine.status == "Offline" %}
                                            Offline
                                        {% elif machine.status == "Failed" %}
                                            Failed
                                        {% elif machine.status.startswith("Error") %}
                                            {{ machine.status }}
                                        {% elif machine.status == "Deploying" %}
                                            Deploying
                                        {% else %}
                                            {{ machine.status }} {# Display the actual status if it doesn't match predefined ones #}
                                        {% endif %}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                    <div class="relative" @click.stop>
                                        <!-- Main Display: Installed OS -->
                                        <div class="flex items-center">
                                            {% set installed_os_display = machine.os_installed|default('Unknown') %}
                                            {% if installed_os_display != 'Unknown' %}
                                                {# Display installed OS with icon and name #}
                                                <span class="flex items-center os-current-value" data-os-raw="{{ machine.os_installed }}">
                                                    {{ machine.os_installed | format_os_icon | safe }}
                                                    <span class="ml-1">{{ machine.os_installed | format_os }}</span>
                                                </span>
                                            {% else %}
                                                {# Display Unknown OS #}
                                                <span class="text-gray-400 italic flex items-center os-current-value" data-os-raw="">
                                                    <i class="fas fa-square-question text-gray-400 mr-1"></i> Unknown
                                                </span>
                                            {% endif %}
                                            <!-- Dropdown Arrow -->
                                            <svg @click="toggleOsDropdown('{{ machine.id }}')" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1 text-gray-400 cursor-pointer hover:text-indigo-500 dark:hover:text-indigo-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                            </svg>
                                        </div>

                                        <!-- Secondary Display: Pending OS Choice from fieldChanges -->
                                        {# Check if os_choice exists in fieldChanges AND is different from the original value stored when editing started #}
                                        <template x-if="fieldChanges['{{ machine.id }}']?.hasOwnProperty('os_choice') && fieldChanges['{{ machine.id }}'].os_choice !== (originalValues['{{ machine.id }}'] ? originalValues['{{ machine.id }}'].os_choice : '')">
                                            <div class="mt-1 text-xs text-purple-600 dark:text-purple-400 italic font-thin flex items-center" title="Pending change">
                                                 {# Display pending choice - use JS helpers once added #}
                                                 <i class="fas fa-asterisk text-purple-400 mr-1 text-[0.6rem]"></i> {# Placeholder icon #}
                                                 <span class="ml-1" x-text="fieldChanges['{{ machine.id }}'].os_choice"></span>
                                                 <i class="fas fa-arrow-right-arrow-left ml-1 text-xs"></i>
                                            </div>
                                        </template>
                                        <!-- Secondary Display: Applied OS Choice different from Installed (and not currently pending change) -->
                                        {% if machine.os_choice and machine.os_choice != machine.os_installed %}
                                        <template x-if="!(fieldChanges['{{ machine.id }}']?.hasOwnProperty('os_choice'))">
                                             {# Ensure os_choice is not None/empty before applying filters - Jinja handles this now #}
                                             <div class="mt-1 text-xs text-purple-600 dark:text-purple-400 italic font-thin flex items-center" title="OS choice {{ machine.os_choice }} applies on next reimage">
                                                 {{ machine.os_choice | format_os_icon | safe }}
                                                 <span class="ml-1">{{ machine.os_choice | format_os }}</span>
                                                 <i class="fas fa-arrow-right-arrow-left ml-1 text-xs"></i>
                                            </div>
                                        </template>
                                        {% endif %}

                                        <!-- OS Selection Dropdown -->
                                        <div
                                            x-show="osDropdowns['{{ machine.id }}'] === true"
                                            x-transition:enter="transition ease-out duration-100"
                                            x-transition:enter-start="transform opacity-0 scale-95"
                                            x-transition:enter-end="transform opacity-100 scale-100"
                                            x-transition:leave="transition ease-in duration-75"
                                            x-transition:leave-start="transform opacity-100 scale-100"
                                            x-transition:leave-end="transform opacity-0 scale-95"
                                            class="absolute z-10 mt-1 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none dark:bg-black dark:ring-gray-700"
                                            @click.outside="osDropdowns['{{ machine.id }}'] = false"
                                            x-cloak
                                        >
                                            <div class="py-1">
                                                {# Cancel Pending OS Selection (from fieldChanges) #}
                                                <template x-if="fieldChanges['{{ machine.id }}']?.hasOwnProperty('os_choice') && fieldChanges['{{ machine.id }}'].os_choice !== (originalValues['{{ machine.id }}'] ? originalValues['{{ machine.id }}'].os_choice : '')">
                                                    <a href="#" @click.prevent="cancelOsChoice('{{ machine.id }}')" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100 hover:text-red-800 dark:text-red-400 dark:hover:bg-gray-700 dark:hover:text-red-300 flex items-center">
                                                        <i class="fas fa-times-circle mr-2"></i> Cancel Pending OS
                                                    </a>
                                                    <div class="border-t border-gray-200 dark:border-gray-600 my-1"></div>
                                                </template>
                                                {# Cancel Applied OS Choice (from machine data, if not currently pending) #}
                                                {% if machine.os_choice and machine.os_choice != machine.os_installed %}
                                                 <template x-if="!(fieldChanges['{{ machine.id }}']?.hasOwnProperty('os_choice'))">
                                                     <a href="#" @click.prevent="cancelOsChoice('{{ machine.id }}')" class="block px-4 py-2 text-sm text-green-600 hover:bg-gray-100 hover:text-green-800 dark:text-green-400 dark:hover:bg-gray-700 dark:hover:text-green-300 flex items-center">
                                                        <i class="fas fa-times-circle mr-2"></i> Keep existing OS
                                                    </a>
                                                    <div class="border-t border-gray-200 dark:border-gray-600 my-1"></div>
                                                </template>
                                                {% endif %}

                                                <!-- OS Options -->
                                                <a href="#" @click.prevent="selectOs('{{ machine.id }}', 'ubuntu-2204')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-gray-700 dark:hover:text-white flex items-center">
                                                    <i class="fab fa-ubuntu text-orange-500 dark:text-orange-500 no-invert mr-2"></i> Ubuntu 22.04
                                                </a>
                                                <a href="#" @click.prevent="selectOs('{{ machine.id }}', 'ubuntu-2404')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-gray-700 dark:hover:text-white flex items-center">
                                                    <i class="fab fa-ubuntu text-orange-500 dark:text-orange-500 no-invert mr-2"></i> Ubuntu 24.04
                                                </a>
                                                <a href="#" @click.prevent="selectOs('{{ machine.id }}', 'debian-12')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-gray-700 dark:hover:text-white flex items-center">
                                                    <i class="fab fa-debian text-red-500 mr-2"></i> Debian 12
                                                </a>
                                                <a href="#" @click.prevent="selectOs('{{ machine.id }}', 'proxmox')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-gray-700 dark:hover:text-white flex items-center">
                                                    <i class="fas fa-server text-blue-500 mr-2"></i> Proxmox
                                                </a>
                                                <a href="#" @click.prevent="selectOs('{{ machine.id }}', 'talos')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-gray-700 dark:hover:text-white flex items-center">
                                                    <i class="fas fa-robot text-purple-500 mr-2"></i> Talos
                                                </a>
                                                <!-- Add more OS options as needed -->
                                            </div>
                                        </div>
                                        <!-- Hidden span for JS to get installed OS -->
                                         <span class="hidden os-current-value">{{ machine.os_installed|default('') }}</span>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                    {% if machine.status == "InstallingOS" %}
                                        {% if workflow_infos[machine.id] %}
                                            <div class="flex flex-col space-y-1 pointer-events-none">
                                                <div class="flex justify-between text-xs">
                                                    <span>{{ workflow_infos[machine.id].progress }}%</span>
                                                    {% if workflow_infos[machine.id].current_action %}
                                                        <span class="ml-2 truncate max-w-[120px]">
                                                            {{ workflow_infos[machine.id].current_action }}
                                                        </span>
                                                    {% endif %}
                                                </div>
                                                <div class="w-full bg-gray-200 rounded-full h-2 dark:bg-gray-700">
                                                    <div class="bg-yellow-500 h-2 rounded-full dark:bg-yellow-600 workflow-progress-bar" data-machine-id="{{ machine.id }}" data-progress="{{ workflow_infos[machine.id].progress }}"></div>
                                                </div>
                                            </div>
                                        {% else %}
                                            <span class="text-xs italic text-gray-400 pointer-events-none">Awaiting progress data...</span>
                                        {% endif %}
                                    {% else %}
                                        {% if is_admin %} {# Wrap all actions in is_admin check #}
                                        <div class="flex space-x-1 items-center" @click.stop hx-preserve="true">
                                            {# Common Actions - Tags #}
                                            <button 
                                                @click="openTagModal(
                                                    '{{ machine.id }}', 
                                                    `{% if machine.hostname %}{{ machine.hostname }}{% elif machine.memorable_name %}{{ machine.memorable_name }}{% else %}{{ machine.id }}{% endif %}`.trim()
                                                )"
                                                class="inline-flex items-center px-3 py-1 border border-transparent text-sm leading-5 font-medium rounded text-purple-700 bg-purple-100 hover:bg-purple-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 dark:bg-purple-900 dark:text-purple-200 dark:hover:bg-purple-800"
                                            >
                                                🏷️ Tags
                                            </button>
                                            
                                            {# Apply Button - Only show when there are *non-OS* changes to apply #}
                                            <template x-if="fieldChanges['{{ machine.id }}'] && Object.keys(fieldChanges['{{ machine.id }}']).some(key => key !== 'os_choice')">
                                                <button @click="fieldChanges['{{ machine.id }}'].mac_address ? confirmMacChange('{{ machine.id }}') : applyChanges('{{ machine.id }}')" 
                                                        class="inline-flex items-center px-3 py-1 border border-transparent text-sm leading-5 font-medium rounded text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:bg-blue-900 dark:text-blue-200 dark:hover:bg-blue-800">
                                                    ⚡ Apply
                                                </button>
                                            </template>
                                            
                                            {# Reimage Action - Only show when there are no non-OS changes to apply #}
                                            <template x-if="!fieldChanges['{{ machine.id }}'] || !Object.keys(fieldChanges['{{ machine.id }}']).some(key => key !== 'os_choice')">
                                                {% if machine.status == "Ready" or machine.status == "AwaitingAssignment" or machine.status == "ExistingOS" or machine.status == "Offline" %}
                                                <button @click="openReimageModal('{{ machine.id }}')" class="inline-flex items-center px-3 py-1 border border-transparent text-sm leading-5 font-medium rounded text-cyan-700 bg-cyan-100 hover:bg-cyan-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500 dark:bg-cyan-900 dark:text-cyan-200 dark:hover:bg-cyan-800">
                                                    ♻️ Reimage
                                                </button>
                                                {% endif %}
                                            </template>

                                            {# Power Action #}
                                            {% if machine.bmc_credentials %}
                                            <button @click="openPowerModal('{{ machine.id }}')" class="inline-flex items-center px-3 py-1 border border-transparent text-sm leading-5 font-medium rounded text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                                ⏻ Power
                                            </button>
                                            {% endif %}
                                            
                                            <!-- Single Delete Icon (default) -->
                                            <template x-if="!selectAll">
                                                <button @click="confirmDelete('{{ machine.id }}', '{{ machine.hostname or machine.memorable_name or machine.mac_address }}')" 
                                                        class="ml-3 inline-flex items-center p-1 border border-transparent text-sm leading-5 font-medium rounded text-red-700 bg-red-100 hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 dark:bg-red-900 dark:text-red-200 dark:hover:bg-red-800"
                                                        title="Delete Machine">
                                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                                        <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                                                    </svg>
                                                </button>
                                            </template>
                                            
                                            <!-- Bulk Action Checkbox -->
                                            <template x-if="selectAll">
                                                <input type="checkbox" 
                                                       :id="'select-' + machine.id"
                                                       :value="machine.id"
                                                       x-model="selectedMachines[machine.id]"
                                                       class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:checked:bg-indigo-500 dark:focus:ring-indigo-600 dark:focus:ring-offset-gray-800">
                                            </template>
                                        </div>
                                        {% endif %} {# End is_admin check for actions #}
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="6" class="px-6 py-10 text-center text-gray-500 dark:text-gray-400">
                                    <p class="mb-2">No machines discovered yet.</p>
                                    <p class="text-sm italic">Machines will appear here once they connect to Dragonfly.</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% include "partials/machine_list_modals.html" %}

</div> {# End of main x-data div #}
{% endblock %}

{% block scripts %}

<script>
    // Add Machine Form Handler
    function addMachineForm() {
        return {
            formData: {
                mac_address: '',
                hostname: '',
                ip_address: '',
                memorable_name: '',
                status: 'AwaitingAssignment'
            },
            errors: {},
            formError: '',
            isSubmitting: false,
            
            initForm() {
                // Initialize the form
                this.resetForm();
            },
            
            resetForm() {
                this.formData = {
                    mac_address: '',
                    hostname: '',
                    ip_address: '',
                    memorable_name: '',
                    status: 'AwaitingAssignment'
                };
                this.errors = {};
                this.formError = '';
                this.isSubmitting = false;
            },
            
            validateForm() {
                this.errors = {};
                let isValid = true;
                
                // Validate MAC address (required and format)
                if (!this.formData.mac_address) {
                    this.errors.mac_address = 'MAC address is required';
                    isValid = false;
                } else if (!/^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$/.test(this.formData.mac_address)) {
                    this.errors.mac_address = 'Invalid MAC address format. Use XX:XX:XX:XX:XX:XX';
                    isValid = false;
                }
                
                // Validate hostname format if provided
                if (this.formData.hostname && !/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(this.formData.hostname)) {
                    this.errors.hostname = 'Invalid hostname format';
                    isValid = false;
                }
                
                // Validate IP address format if provided
                if (this.formData.ip_address && !/^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(this.formData.ip_address)) {
                    this.errors.ip_address = 'Invalid IP address format';
                    isValid = false;
                }
                
                return isValid;
            },
            
            async submitForm() {
                if (!this.validateForm()) return;
                
                this.isSubmitting = true;
                this.formError = '';
                
                try {
                    const response = await fetch('/api/machines', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(this.formData)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to add machine');
                    }
                    
                    const result = await response.json();
                    
                    // Show success message
                    showToast('Machine added successfully', 'success');
                    
                    // Close the modal
                    this.addManagedModal = false;
                    
                    // Reset the form
                    this.resetForm();
                    
                    // Refresh the machine list
                    refreshMachineList();
                    
                } catch (error) {
                    console.error('Error adding machine:', error);
                    this.formError = error.message || 'An error occurred while adding the machine';
                } finally {
                    this.isSubmitting = false;
                }
            }
        };
    }
    
    // Check if user is authenticated before allowing admin actions
    function requireAdmin(callback) {
        // window.isAuthenticated is now set by Alpine's x-init
        if (!window.isAuthenticated) {
            alert("You need to be logged in as admin to perform this action.");
            return false;
        }
        return callback();
    }

    // Alpine.js component for the Tag Editor Modal
    function tagEditorData() {
        return {
            tags: [],
            newTag: '',
            isLoading: false,
            machineId: null,
            
            init() {
                // Initial tags will be loaded when the modal is opened
            },
            addTag() {
                if (!this.newTag.trim()) return;
                if (this.tags.includes(this.newTag.trim())) {
                    this.newTag = '';
                    return;
                }
                this.isLoading = true;
                
                // Make API call to add tag
                fetch(`/api/machines/${this.machineId}/tags`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ tag: this.newTag.trim() })
                })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to add tag');
                    return response.json();
                })
                .then(data => {
                    this.tags.push(this.newTag.trim());
                    this.newTag = '';
                    this.isLoading = false;
                })
                .catch(error => {
                    this.isLoading = false;
                    alert('Failed to add tag. Please try again.');
                });
            },
            removeTag(tag) {
                this.isLoading = true;
                
                // Make API call to remove tag
                fetch(`/api/machines/${this.machineId}/tags/${encodeURIComponent(tag)}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to remove tag');
                    this.tags = this.tags.filter(t => t !== tag);
                    this.isLoading = false;
                })
                .catch(error => {
                    this.isLoading = false;
                    alert('Failed to remove tag. Please try again.');
                });
            },
            openModal(machineId) {
                this.machineId = machineId;
                this.isLoading = true;
                
                // Fetch existing tags for this machine
                fetch(`/api/machines/${machineId}/tags`)
                .then(response => {
                    if (!response.ok) throw new Error('Failed to fetch tags');
                    return response.json();
                })
                .then(data => {
                    this.tags = data.tags || [];
                    this.isLoading = false;
                })
                .catch(error => {
                    this.isLoading = false;
                    alert('Failed to load tags. Please try again.');
                });
            }
        };
    }

    // --- MODIFIED Progress Animation Logic --- 
    let machineProgressData = {}; // Stores { targetProgress, realProgress, lastTaskName }
    let animationFrameId = null;
    const FPS = 60;

    function startProgressAnimation() {
        if (animationFrameId) return; // Already running
        let lastFrameTime = performance.now();
        const frameInterval = 1000 / FPS;

        function updateFrame(now) {
            if (now - lastFrameTime < frameInterval) {
                animationFrameId = requestAnimationFrame(updateFrame);
                return;
            }
            lastFrameTime = now;
            let needsMoreFrames = false;

            Object.keys(machineProgressData).forEach(machineId => {
                const data = machineProgressData[machineId];
                // Ensure data exists AND has the new realProgress field
                if (!data || data.realProgress === undefined) return; 
                const machineRow = document.querySelector(`tr[data-machine-id='${machineId}']`);
                if (!machineRow) return;
                const progressBar = machineRow.querySelector('.workflow-progress-bar');
                const progressTextElement = machineRow.querySelector('.flex.justify-between.text-xs span:first-child');
                if (!progressBar || !progressTextElement) return;

                let currentProgress = parseFloat(progressBar.style.width) || 0;
                let targetVisualProgress = currentProgress; // What we aim for this frame

                // --- Prioritize Real Progress --- 
                if (data.realProgress !== null) { // Check if realProgress has a value
                    targetVisualProgress = data.realProgress; // Jump directly
                    // Only update DOM if significantly different to avoid thrashing
                    if (Math.abs(currentProgress - targetVisualProgress) > 0.1) { 
                        progressBar.style.width = `${targetVisualProgress}%`;
                        progressTextElement.textContent = `${Math.round(targetVisualProgress)}%`;
                        // console.log(`Jumped ${machineId} to real progress: ${targetVisualProgress.toFixed(1)}%`);
                    }
                    data.realProgress = null; // Consume the real progress value
                    needsMoreFrames = true; // Might need to animate towards target later if target > real
                } 
                // --- Fallback to Interpolation --- 
                else if (data.targetProgress !== undefined) {
                    // Use targetVisualProgress from potential real jump above as starting point
                    currentProgress = targetVisualProgress; 
                    if (currentProgress < data.targetProgress) {
                        const increment = (data.targetProgress - currentProgress) * 0.1; // Adjust for speed
                        targetVisualProgress = Math.min(data.targetProgress, currentProgress + increment);
                        progressBar.style.width = `${targetVisualProgress}%`;
                        progressTextElement.textContent = `${Math.round(targetVisualProgress)}%`;
                        needsMoreFrames = true; // Continue animating
                        // console.log(`Interpolating ${machineId} towards ${data.targetProgress.toFixed(1)}% (current: ${targetVisualProgress.toFixed(1)}%)`);
                    } else if (currentProgress > data.targetProgress) {
                       // If current visual > target (e.g., after a real jump), 
                       // just hold the current visual progress. Don't regress.
                       targetVisualProgress = currentProgress; 
                       // Check if target still needs update
                       if (data.targetProgress > 0) needsMoreFrames = true; 
                    } else {
                       // currentProgress == data.targetProgress, potentially stop animating
                       if (data.targetProgress < 100 && data.targetProgress > 0) {
                           // Keep checking if new data comes in
                           needsMoreFrames = true; 
                       }
                    }
                }
            });

            if (needsMoreFrames) {
                animationFrameId = requestAnimationFrame(updateFrame);
            } else {
                // console.log("Animation loop stopping.");
                animationFrameId = null;
            }
        }
        // console.log("Animation loop starting.");
        animationFrameId = requestAnimationFrame(updateFrame);
    }

    // SSE connection setup
    function connectEventSource() {
        // Check if already connected
        if (window.dragonflyEvtSource && window.dragonflyEvtSource.readyState !== EventSource.CLOSED) {
            return; 
        }

        if (evtSource) { // Reuse existing evtSource variable if page reloaded strangely
            evtSource.close();
        }

        evtSource = new EventSource('/api/events');
        window.dragonflyEvtSource = evtSource; // Store globally to check existence
        window.globalEvtSource = evtSource; // Also store as globalEvtSource for compatibility
        
        evtSource.onmessage = function(event) {
            try {
                // Parse the JSON data
                const data = JSON.parse(event.data);
                
                // Find the machine row in the table
                const machineRow = document.querySelector(`tr[data-machine-id='${data.id}']`);
                if (!machineRow) return; // Not found in this table
                
                // Find the status badge within the row
                const statusBadge = machineRow.querySelector('.machine-status-badge');
                if (!statusBadge) return;
                
                // Update the status indicator
                if (data.state) {
                    if (data.state === 'STATE_FAILED') {
                        statusBadge.textContent = 'Failed';
                        statusBadge.classList.remove('bg-yellow-100', 'text-yellow-800', 'dark:bg-yellow-400/10', 'dark:text-yellow-300', 
                                                   'bg-green-100', 'text-green-800', 'dark:bg-green-400/10', 'dark:text-green-300');
                        statusBadge.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-400/10', 'dark:text-red-300');
                    } else if (data.state === 'STATE_SUCCESS') {
                        statusBadge.textContent = 'Success';
                        statusBadge.classList.remove('bg-yellow-100', 'text-yellow-800', 'dark:bg-yellow-400/10', 'dark:text-yellow-300',
                                                   'bg-red-100', 'text-red-800', 'dark:bg-red-400/10', 'dark:text-red-300');
                        statusBadge.classList.add('bg-green-100', 'text-green-800', 'dark:bg-green-400/10', 'dark:text-green-300');
                    }
                }
                
                // Update progress if machine is installing OS
                if (statusBadge.textContent === 'Installing OS' || data.state === 'STATE_RUNNING') {
                    const progressBar = machineRow.querySelector('.workflow-progress-bar');
                    const progressText = machineRow.querySelector('.flex.justify-between.text-xs span:first-child');
                    
                    if (progressBar && typeof data.progress === 'number') {
                        // Use ratcheting to prevent progress going backwards
                        const currentWidth = progressBar.style.width || '0%';
                        const currentProgress = parseInt(currentWidth.replace('%', ''), 10) || 0;
                        const newProgress = Math.max(currentProgress, data.progress);
                        
                        progressBar.style.width = `${newProgress}%`;
                        if (progressText) {
                            progressText.textContent = `${newProgress}%`;
                        }
                        
                        // Show the container if it was hidden
                        const progressContainer = machineRow.querySelector('.progress-container');
                        if (progressContainer) {
                            progressContainer.classList.remove('hidden');
                        }
                    }
                    
                    // Update current action text if available
                    const actionText = machineRow.querySelector('.flex.justify-between.text-xs span:last-child');
                    if (actionText && data.current_action) {
                        actionText.textContent = data.current_action;
                        actionText.parentElement.classList.remove('hidden');
                    }
                }
                
                // If installation is complete, refresh the table
                if (data.status && data.status !== 'InstallingOS') {
                    refreshMachineList();
                }
            } catch (error) {
                // Silent error handling
            }
        };
        
        evtSource.onerror = function(error) {
            if (evtSource) {
                evtSource.close();
            }
            
            // Try to reconnect after a delay
            setTimeout(connectEventSource, 2000);
        };
        
        // Attach event handlers for 'machine_updated' event
        evtSource.addEventListener('machine_updated', function(event) {
            try {
                const data = JSON.parse(event.data);
                if (data.type === "machine_updated") {
                    // Refresh the machine list after a short delay to allow state to update
                    setTimeout(refreshMachineList, 200);
                }
            } catch (e) {
                // Silent error handling
            }
        });

        // Attach event handlers for 'ip_download_progress' event
        evtSource.addEventListener('ip_download_progress', function(event) {
            try {
                const data = JSON.parse(event.data);
                const machineIp = data.ip;
                
                // Find machine row by IP (more robust if multiple machines share IP initially?)
                // For now, assume IP is unique enough during installation
                const machineRows = document.querySelectorAll(`td:nth-child(3) > div > span:first-child:not([x-show])`); // Find IP address spans
                let targetMachineId = null;
                machineRows.forEach(span => {
                    if (span.textContent.trim() === machineIp) {
                        const row = span.closest('tr');
                        if(row) {
                            targetMachineId = row.getAttribute('data-machine-id');
                        }
                    }
                });

                if (targetMachineId && data.bytes_downloaded !== undefined && data.total_size !== undefined) {
                    const fileName = data.file_name || "File Download";
                    const bytesDownloaded = parseInt(data.bytes_downloaded) || 0;
                    const totalSize = parseInt(data.total_size) || 0;
                    
                    // *** Calculate the actual file download percentage ***
                    const fileProgressPercent = (totalSize > 0) ? (bytesDownloaded / totalSize * 100) : 0;
                    
                    // Only update progress if the task seems related to downloading/streaming
                    // We infer this if the filename suggests an image or kernel/initrd
                    let taskName = "Unknown Download";
                    const lowerFileName = fileName.toLowerCase();
                    if (lowerFileName.includes("vmlinuz") || lowerFileName.includes("kernel")) {
                        taskName = "Downloading kernel";
                    } else if (lowerFileName.includes("initrd") || lowerFileName.includes("initramfs")) {
                        taskName = "Downloading initramfs";
                    } else if (lowerFileName.includes(".img") || fileName.includes(".iso") || fileName.includes("cloudimg") || fileName.includes("stream image")) {
                        taskName = "Streaming image"; // Use a consistent name
                    } else {
                        // If filename doesn't match known patterns, don't update progress bar based on this event
                        return; 
                    }
                    
                    // Use the CALCULATED percentage for the update
                    updateMachineProgress(targetMachineId, fileProgressPercent, taskName, bytesDownloaded, totalSize);
                }
            } catch (e) {
                console.error("Error processing ip_download_progress:", e, event.data);
            }
        });
    }

    let evtSource = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize SSE connection
        connectEventSource();
        
        // Listen for image progress events and update UI
        if (window.globalEvtSource) {
            // Handler for task-specific progress events
            window.globalEvtSource.addEventListener('task_progress', function(event) {
                try {
                    const rawData = event.data;
                    
                    // Format: "machine_id:task_name:percentage:bytes_downloaded:total_size"
                    const parts = rawData.split(':');
                    if (parts.length >= 5) {
                        const machineId = parts[0];
                        const taskName = parts[1];
                        const progressPercent = parseFloat(parts[2]);
                        const bytesDownloaded = parseInt(parts[3], 10);
                        const totalSize = parseInt(parts[4], 10);
                        
                        // Update the machine's progress bar in the machine list
                        updateMachineProgress(machineId, progressPercent, taskName, bytesDownloaded, totalSize);
                    }
                } catch (e) {
                    // Error processing task progress event
                }
            });
            
            // Handler for file-specific progress events
            window.globalEvtSource.addEventListener('file_progress', function(event) {
                try {
                    const rawData = event.data;
                    
                    // Format: "filename:percentage:bytes_downloaded:total_size"
                    const parts = rawData.split(':');
                    if (parts.length >= 4) {
                        const fileName = parts[0];
                        const progressPercent = parseFloat(parts[1]);
                        const bytesDownloaded = parseInt(parts[2], 10);
                        const totalSize = parseInt(parts[3], 10);
                        
                        // Determine task name based on filename
                        let taskName = "Downloading file";
                        if (fileName.includes("vmlinuz")) {
                            taskName = "Downloading kernel";
                        } else if (fileName.includes("initrd") || fileName.includes("initramfs")) {
                            taskName = "Downloading initramfs";
                        } else if (fileName.includes(".img") || fileName.includes(".iso") || fileName.includes("cloudimg")) {
                            taskName = "Downloading OS image";
                        }
                        
                        // Update progress for all machines that are installing OS
                        // (We don't know which machine this is for from this event type)
                        const installingMachines = document.querySelectorAll('tr span:contains("Installing OS")');
                        installingMachines.forEach(statusEl => {
                            const machineRow = statusEl.closest('tr');
                            if (machineRow) {
                                const machineId = machineRow.getAttribute('data-machine-id');
                                if (machineId) {
                                    updateMachineProgress(machineId, progressPercent, taskName, bytesDownloaded, totalSize);
                                }
                            }
                        });
                    }
                } catch (e) {
                    // Error processing file progress event
                }
            });
            
            // For backward compatibility
            window.globalEvtSource.addEventListener('image_progress', function(event) {
                try {
                    const rawData = event.data;
                    
                    // Format: "image_file:percent:total_size"
                    const parts = rawData.split(':');
                    if (parts.length >= 3) {
                        const imageFile = parts[0];
                        const progressPercent = parseFloat(parts[1]);
                        const totalSize = parseInt(parts[2], 10);
                        
                        // Update any machines that are in "Installing OS" state
                        const installingMachines = document.querySelectorAll('tr span:contains("Installing OS")');
                        installingMachines.forEach(statusElement => {
                            const machineRow = statusElement.closest('tr');
                            if (machineRow) {
                                const machineId = machineRow.getAttribute('data-machine-id');
                                if (machineId) {
                                    updateMachineProgress(machineId, progressPercent, "Downloading OS image", 0, totalSize);
                                }
                            }
                        });
                    }
                } catch (e) {
                    // Error processing image progress event
                }
            });
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (evtSource) {
                evtSource.close();
            }
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
        });
    });

    // MODIFIED Helper function to update machine progress data
    function updateMachineProgress(machineId, progressPercent, taskName, bytesDownloaded, totalSize) {
        // Initialize data structure if needed, adding realProgress
        if (!machineProgressData[machineId]) {
            machineProgressData[machineId] = { targetProgress: 0, realProgress: null, lastTaskName: null };
        }
        const data = machineProgressData[machineId];

        // Reset progress if task name changes
        if (data.lastTaskName !== taskName) {
            console.log(`Task changed for ${machineId}: '${data.lastTaskName}' -> '${taskName}'. Resetting progress.`);
            data.targetProgress = 0; 
            data.realProgress = null;
            data.lastTaskName = taskName;
        }

        // Update Target Progress (using existing logic)
        data.targetProgress = Math.max(
            progressPercent,
            data.targetProgress || 0
        );

        // --- ADDED: Calculate and Store Real Progress --- 
        if (bytesDownloaded !== undefined && bytesDownloaded !== null && totalSize !== undefined && totalSize !== null) {
            const realPercent = (totalSize > 0) ? (bytesDownloaded / totalSize * 100) : 0;
            data.realProgress = Math.max(
                 realPercent,
                 (data.realProgress !== null ? data.realProgress : 0) 
             ); 
            // console.log(`Real progress update stored for ${machineId} (${taskName}): ${data.realProgress.toFixed(1)}%`);
        } // else: Don't overwrite realProgress if it's just an estimated update
        
        // Find the machine row and update static text (action/byte counts)
        const machineRow = document.querySelector(`tr[data-machine-id='${machineId}']`);
        if (!machineRow) return;
        const actionTextElement = machineRow.querySelector('.flex.justify-between.text-xs span:last-child');
        const progressContainer = machineRow.querySelector('.flex.flex-col.space-y-1');

        if (actionTextElement && progressContainer) {
            progressContainer.classList.remove('hidden');
            progressContainer.classList.add('pointer-events-none');
            // --- ADDED: Update Action Text with MB/Total MB --- 
            if (totalSize !== undefined && totalSize !== null && totalSize > 0) {
                const totalMB = (totalSize / (1024 * 1024)).toFixed(1);
                if (bytesDownloaded !== undefined && bytesDownloaded !== null && bytesDownloaded >= 0) {
                    const downloadedMB = (bytesDownloaded / (1024 * 1024)).toFixed(1);
                    actionTextElement.textContent = `${taskName} (${downloadedMB}/${totalMB} MB)`;
                } else {
                    actionTextElement.textContent = `${taskName} (${totalMB} MB)`;
                }
            } else {
                actionTextElement.textContent = taskName;
            }
        }
        
        // Start/continue the animation loop
        startProgressAnimation();
    }
    
    // Function to refresh the machine list (Keep this)
    function refreshMachineList() {
        fetch('/machines')
            .then(response => response.text())
            .then(html => {
                // Create a temporary element to parse the HTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // Extract the machine list rows
                const newMachineList = tempDiv.querySelector('#machine-list');
                if (newMachineList) {
                    // Get the current machine list
                    const currentMachineList = document.getElementById('machine-list');
                    if (currentMachineList) {
                        // Replace the content
                        currentMachineList.innerHTML = newMachineList.innerHTML;
                        
                        // Re-initialize Alpine.js if needed
                        if (window.Alpine) {
                            window.Alpine.initTree(currentMachineList);
                        }
                    }
                }
            })
            .catch(error => {
                // Handle error silently
            });
    }

    // --- NEW Proxmox Modal Logic ---
    function proxmoxData() {
        return {
            formData: {
                host: '',
                port: 8006,
                username: '',
                password: '',
                skipTlsVerify: false
            },
            vmSelectionOption: 'all', // 'all', 'none', 'tags'
            discoveredClusters: [], // Array to hold discovered machines {host: string, port?: number, hostname?: string}
            isConnecting: false,
            isScanning: false, // NEW state for scanning
            errorMessage: null,
            scanErrorMessage: null, // NEW state for scan errors

            initModal() {
                // Reset state when modal opens
                this.formData = { host: '', port: 8006, username: '', password: '', skipTlsVerify: false };
                this.vmSelectionOption = 'all';
                this.isConnecting = false;
                this.isScanning = false;
                this.errorMessage = null;
                this.scanErrorMessage = null;
                this.discoveredClusters = []; // Clear previous results
                // Don't trigger scan automatically, wait for button click
                console.log("Proxmox modal initialized.");
            },

            selectDiscoveredCluster(machine) {
                // Make sure we're handling the machine object correctly
                if (!machine) return;
                
                this.formData.host = machine.host || '';
                this.formData.port = machine.port || 8006;
                this.errorMessage = null; // Clear errors when selecting a machine
                this.scanErrorMessage = null;
                console.log(`Selected discovered machine: ${machine.hostname || machine.host}`);
            },

            scanForClusters() {
                this.isScanning = true;
                this.scanErrorMessage = null;
                this.discoveredClusters = []; // Clear previous results before scanning
                console.log("Scanning for Proxmox machines...");

                fetch('/api/proxmox/discover') // NEW API endpoint
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => { throw new Error(err.error || `HTTP error! status: ${response.status}`); });
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Make sure we have an array of machines, even if the API returns an empty array or undefined
                        this.discoveredClusters = data.machines || [];
                        
                        // Sort machines by type and hostname
                        this.discoveredClusters.sort((a, b) => {
                            // Sort by type first (host, then node, then VM)
                            const typeOrder = { 'host': 1, 'proxmox-host': 1, 'proxmox-node': 2, 'proxmox-vm': 3 };
                            const typeA = typeOrder[a.machine_type] || 99;
                            const typeB = typeOrder[b.machine_type] || 99;
                            if (typeA !== typeB) return typeA - typeB;
                            
                            // Then sort by hostname
                            const hostA = a.hostname || a.host;
                            const hostB = b.hostname || b.host;
                            return hostA.localeCompare(hostB);
                        });
                        
                        if (this.discoveredClusters.length === 0) {
                            this.scanErrorMessage = "No Proxmox machines found on the network.";
                        }
                        console.log("Scan complete. Found machines:", this.discoveredClusters);
                    })
                    .catch(error => {
                        console.error("Error scanning for Proxmox machines:", error);
                        this.scanErrorMessage = `Scan failed: ${error.message}`;
                    })
                    .finally(() => {
                        this.isScanning = false;
                    });
            },

            connectProxmox() {
                this.isConnecting = true;
                this.errorMessage = null;
                console.log("Connecting to Proxmox host...", this.formData, this.vmSelectionOption);

                // Validate form data
                if (!this.formData.host || !this.formData.username || !this.formData.password) {
                    this.errorMessage = "Host, Username, and Password/Token are required.";
                    this.isConnecting = false;
                    return;
                }
                
                // Make API call to connect to Proxmox
                fetch('/api/proxmox/connect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        host: this.formData.host,
                        port: this.formData.port || 8006,
                        username: this.formData.username,
                        password: this.formData.password,
                        vm_selection_option: this.vmSelectionOption.toLowerCase(),
                        skip_tls_verify: this.formData.skipTlsVerify
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { 
                            // Pass along the suggestion if it's a TLS error
                            if (err.suggest_disable_tls_verify) {
                                throw new Error(err.message + " Would you like to try again with certificate validation disabled?", 
                                               { cause: { suggestDisableTls: true }});
                            }
                            throw new Error(err.error || `HTTP error! status: ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    // Success - show success message and refresh the page
                    console.log("Successfully connected to Proxmox:", data);
                    this.proxmoxMachineModal = false;
                    
                    // Refresh the page to show new machines
                    window.location.reload();
                })
                .catch(error => {
                    console.error("Error connecting to Proxmox:", error);
                    
                    // Check if this is a TLS error with suggestion to disable verification
                    if (error.cause && error.cause.suggestDisableTls) {
                        this.errorMessage = error.message;
                        
                        // Ask user if they want to try again with TLS verification disabled
                        if (confirm("TLS certificate verification failed. Would you like to try again with certificate validation disabled?")) {
                            this.formData.skipTlsVerify = true;
                            this.connectProxmox(); // Try the connection again
                            return;
                        }
                    } else {
                        // Regular error
                        this.errorMessage = `Connection failed: ${error.message}`;
                    }
                    
                    this.isConnecting = false;
                });
            }
        };
    }
</script>
{% endblock %}