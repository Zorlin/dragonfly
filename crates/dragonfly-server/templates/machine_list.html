{% extends "base.html" %}

{% block title %}Dragonfly - Machines{% endblock %}

{% block content %}
<div class="px-4 sm:px-6 lg:px-8" x-data="{
    isAuthenticated: {{ is_authenticated }},
    updateDebounceTimer: null,
    statusModal: false,
    osModal: false,
    deleteModal: false,
    tagModal: false,
    reimageModal: false,
    powerModal: false,
    currentMachineId: null,
    currentMachineName: null,
    osDropdowns: {}, // Track open state of OS dropdowns
    editingField: null, // Track which field is being edited
    fieldChanges: {}, // Track changes to fields
    originalValues: {}, // Track original values for fields
    pendingChanges: false, // Whether there are unsaved changes
    
    // Just Type functionality
    startEditing(machineId, fieldName, currentValue) {
        // Don't allow editing if not authenticated
        if (!this.isAuthenticated) return;
        
        // Store the field being edited
        this.editingField = `${machineId}-${fieldName}`;
        
        // Store the original value
        if (!this.originalValues[machineId]) {
            this.originalValues[machineId] = {};
        }
        this.originalValues[machineId][fieldName] = currentValue;
        
        // Initialize changes object if needed
        if (!this.fieldChanges[machineId]) {
            this.fieldChanges[machineId] = {};
        }
    },
    
    updateField(machineId, fieldName, newValue) {
        // Update the changes object
        if (!this.fieldChanges[machineId]) {
            this.fieldChanges[machineId] = {};
        }
        
        // Check if the value has actually changed
        if (newValue !== this.originalValues[machineId][fieldName]) {
            this.fieldChanges[machineId][fieldName] = newValue;
            this.pendingChanges = true;
        } else {
            // If value is back to original, remove it from changes
            delete this.fieldChanges[machineId][fieldName];
            
            // Check if there are any changes left for this machine
            if (Object.keys(this.fieldChanges[machineId]).length === 0) {
                delete this.fieldChanges[machineId];
            }
            
            // Check if there are any changes left at all
            this.pendingChanges = Object.keys(this.fieldChanges).length > 0;
        }
    },
    
    stopEditing() {
        this.editingField = null;
    },
    
    // Validate a MAC address
    validateMac(mac) {
        return /^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$/.test(mac);
    },
    
    // Validate a hostname (RFC-1123 compliant)
    validateHostname(hostname) {
        return /^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(hostname);
    },
    
    // Validate an IP address
    validateIp(ip) {
        return /^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(ip);
    },
    
    // Apply changes to a specific machine
    applyChanges(machineId) {
        if (!this.fieldChanges[machineId]) return;
        
        const changes = this.fieldChanges[machineId];
        const payload = {};
        
        // Convert changes to a payload
        Object.keys(changes).forEach(field => {
            payload[field] = changes[field];
        });
        
        // Submit changes via AJAX
        fetch(`/api/machines/${machineId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams(payload).toString()
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Clear changes for this machine
            delete this.fieldChanges[machineId];
            this.pendingChanges = Object.keys(this.fieldChanges).length > 0;
            
            // Show success toast
            showToast(`Machine ${machineId} updated: ${data.message}`, 'success');
            
            // Refresh the machine list
            htmx.trigger(document.querySelector('tbody'), 'refreshMachines');
        })
        .catch(error => {
            console.error('Error:', error);
            showToast(`Failed to update machine: ${error.message}`, 'error');
        });
    },
    
    // Check if field has changes
    hasFieldChanged(machineId, fieldName) {
        return this.fieldChanges[machineId] && 
               this.fieldChanges[machineId][fieldName] !== undefined &&
               this.fieldChanges[machineId][fieldName] !== this.originalValues[machineId][fieldName];
    },
    
    confirmMacChange(machineId) {
        const newMac = this.fieldChanges[machineId].mac_address;
        
        if (!this.validateMac(newMac)) {
            showToast('Invalid MAC address format. Please use XX:XX:XX:XX:XX:XX format.', 'error');
            return;
        }
        
        if (confirm(`Changing the MAC address for this machine will cause issues if the machine is still using the old one. Are you sure you want to change it to ${newMac}?`)) {
            this.applyChanges(machineId);
        } else {
            // Revert changes if user cancels
            delete this.fieldChanges[machineId].mac_address;
            if (Object.keys(this.fieldChanges[machineId]).length === 0) {
                delete this.fieldChanges[machineId];
            }
            this.pendingChanges = Object.keys(this.fieldChanges).length > 0;
            
            // Refresh the display
            htmx.trigger(document.querySelector('tbody'), 'refreshMachines');
        }
    },
    
    openTagModal(id, name) { this.tagModal = true; this.currentMachineId = id; this.currentMachineName = name; },
    openReimageModal(id) { this.reimageModal = true; this.currentMachineId = id; },
    openPowerModal(id) { this.powerModal = true; this.currentMachineId = id; },
    openDeleteModal(id) { this.deleteModal = true; this.currentMachineId = id; },
    toggleOsDropdown(id) { 
        this.osDropdowns[id] = !this.osDropdowns[id]; 
        // Close all other dropdowns
        Object.keys(this.osDropdowns).forEach(key => {
            if (key !== id && this.osDropdowns[key]) this.osDropdowns[key] = false;
        });
    },
    selectOs(id, os) {
        // TODO: Implement OS selection API call
        console.log(`Select OS ${os} for machine ${id}`);
        this.osDropdowns[id] = false;
    }
}" x-init="window.isAuthenticated = isAuthenticated"
   @close-tag-modal.window="tagModal = false"
   @close-delete-modal.window="deleteModal = false"
   @click.window="stopEditing()">
    <div class="sm:flex sm:items-center">
        <div class="sm:flex-auto">
            <h1 class="text-xl font-semibold text-gray-900 dark:text-white">Machines</h1>
            <p class="mt-2 text-sm text-gray-700 dark:text-gray-300">A list of all machines that have been discovered or added.</p>
        </div>
    </div>
    <div class="mt-8 flex flex-col">
        <div class="-my-2 -mx-4 overflow-x-auto sm:-mx-6 lg:-mx-8">
          <div class="inline-block min-w-full py-2 align-middle md:px-6 lg:px-8">
            <div class="overflow-hidden rounded-xl border border-purple-500 dark:border-purple-700 shadow">
              <table class="min-w-full divide-y divide-gray-300 dark:divide-purple-800/50">
                <thead class="bg-gray-50 dark:bg-gray-950">      
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-200 uppercase tracking-wider">
                                    Name
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-200 uppercase tracking-wider">
                                    MAC Address
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-200 uppercase tracking-wider">
                                    IP Address
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-200 uppercase tracking-wider">
                                    Status
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-200 uppercase tracking-wider">
                                    OS
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-200 uppercase tracking-wider">
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody 
                            id="machine-list" 
                            class="divide-y divide-gray-200 dark:divide-gray-700/60 bg-white dark:bg-black" 
                            hx-get="/machines"
                            hx-select="#machine-list > tr"
                            hx-target="#machine-list"
                            hx-trigger="load, refreshMachines from:body"
                            hx-swap="morph:innerHTML"
                            hx-indicator=".htmx-indicator"
                        >
                            {% for machine in machines %}
                            <tr class="hover:ring-1 hover:ring-purple-500 dark:hover:ring-purple-700/60 hover:bg-gray-50 dark:hover:bg-gray-700/50 cursor-pointer" @click="window.location='/machines/{{ machine.id }}'">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm font-medium text-gray-900 dark:text-white">
                                        <div x-on:click.stop="startEditing('{{ machine.id }}', 'hostname', '{{ machine.hostname|default('') }}')" 
                                             :class="{'cursor-text': isAuthenticated}" 
                                             class="hover:text-indigo-600 dark:hover:text-indigo-400">
                                            <span x-show="editingField !== '{{ machine.id }}-hostname'"
                                                  :class="{'text-purple-700 dark:text-purple-400 font-medium': hasFieldChanged('{{ machine.id }}', 'hostname')}">
                                                <span x-text="fieldChanges['{{ machine.id }}'] && fieldChanges['{{ machine.id }}'].hostname !== undefined ? 
                                                             fieldChanges['{{ machine.id }}'].hostname : 
                                                             '{% if machine.hostname %}{{ machine.hostname }}{% else %}Set hostname...{% endif %}'"></span>
                                            </span>
                                            <input x-show="editingField === '{{ machine.id }}-hostname'"
                                                   x-ref="hostname{{ machine.id }}"
                                                   x-on:click.stop
                                                   x-on:keydown.enter.stop="if(validateHostname($event.target.value)) { updateField('{{ machine.id }}', 'hostname', $event.target.value); stopEditing(); }"
                                                   x-on:keydown.escape.stop="stopEditing()"
                                                   x-on:blur="if(validateHostname($event.target.value)) { updateField('{{ machine.id }}', 'hostname', $event.target.value); stopEditing(); }"
                                                   x-effect="if(editingField === '{{ machine.id }}-hostname') setTimeout(() => $refs['hostname{{ machine.id }}'].focus(), 50)"
                                                   type="text"
                                                   value="{{ machine.hostname|default('') }}"
                                                   class="w-full border-b border-indigo-500 bg-transparent focus:outline-none focus:border-indigo-700 dark:text-white">
                                        </div>
                                        {# Display memorable_name below if it exists #}
                                        {% if machine.memorable_name %}
                                        <div x-on:click.stop="startEditing('{{ machine.id }}', 'memorable_name', '{{ machine.memorable_name }}')" 
                                             :class="{'cursor-text': isAuthenticated}"
                                             class="mt-1 text-xs text-gray-500 dark:text-gray-400 tracking-tight italic">
                                            <span x-show="editingField !== '{{ machine.id }}-memorable_name'"
                                                  :class="{'text-purple-700 dark:text-purple-400 font-medium': hasFieldChanged('{{ machine.id }}', 'memorable_name')}">
                                                <span x-text="fieldChanges['{{ machine.id }}'] && fieldChanges['{{ machine.id }}'].memorable_name !== undefined ? 
                                                             fieldChanges['{{ machine.id }}'].memorable_name : 
                                                             '{{ machine.memorable_name }}'"></span>
                                            </span>
                                            <input x-show="editingField === '{{ machine.id }}-memorable_name'"
                                                   x-ref="memorableName{{ machine.id }}"
                                                   x-on:click.stop
                                                   x-on:keydown.enter.stop="updateField('{{ machine.id }}', 'memorable_name', $event.target.value); stopEditing();"
                                                   x-on:keydown.escape.stop="stopEditing()"
                                                   x-on:blur="updateField('{{ machine.id }}', 'memorable_name', $event.target.value); stopEditing();"
                                                   x-effect="if(editingField === '{{ machine.id }}-memorable_name') setTimeout(() => $refs['memorableName{{ machine.id }}'].focus(), 50)"
                                                   type="text"
                                                   value="{{ machine.memorable_name }}"
                                                   class="w-full border-b border-indigo-500 bg-transparent focus:outline-none focus:border-indigo-700 dark:text-white text-xs">
                                        </div>
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400 tech-mono">
                                    <div x-on:click.stop="startEditing('{{ machine.id }}', 'mac_address', '{{ machine.mac_address }}')" 
                                         :class="{'cursor-text': isAuthenticated}">
                                        <span x-show="editingField !== '{{ machine.id }}-mac_address'"
                                              :class="{'text-purple-700 dark:text-purple-400 font-medium': hasFieldChanged('{{ machine.id }}', 'mac_address')}"
                                              class="tech-mono">
                                            <span x-text="fieldChanges['{{ machine.id }}'] && fieldChanges['{{ machine.id }}'].mac_address !== undefined ? 
                                                         fieldChanges['{{ machine.id }}'].mac_address : 
                                                         '{{ machine.mac_address }}'" class="tech-mono"></span>
                                        </span>
                                        <input x-show="editingField === '{{ machine.id }}-mac_address'"
                                               x-ref="macAddress{{ machine.id }}"
                                               x-on:click.stop
                                               x-on:keydown.enter.stop="updateField('{{ machine.id }}', 'mac_address', $event.target.value); stopEditing();"
                                               x-on:keydown.escape.stop="stopEditing()"
                                               x-on:blur="updateField('{{ machine.id }}', 'mac_address', $event.target.value); stopEditing();"
                                               x-effect="if(editingField === '{{ machine.id }}-mac_address') setTimeout(() => $refs['macAddress{{ machine.id }}'].focus(), 50)"
                                               type="text"
                                               value="{{ machine.mac_address }}"
                                               class="w-full border-b border-indigo-500 bg-transparent focus:outline-none focus:border-indigo-700 dark:text-white tech-mono">
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400 tech-mono">
                                    <div x-on:click.stop="startEditing('{{ machine.id }}', 'ip_address', '{{ machine.ip_address }}')" 
                                         :class="{'cursor-text': isAuthenticated}">
                                        <span x-show="editingField !== '{{ machine.id }}-ip_address'"
                                              :class="{'text-purple-700 dark:text-purple-400 font-medium': hasFieldChanged('{{ machine.id }}', 'ip_address')}"
                                              class="tech-mono">
                                            <span x-text="fieldChanges['{{ machine.id }}'] && fieldChanges['{{ machine.id }}'].ip_address !== undefined ? 
                                                         fieldChanges['{{ machine.id }}'].ip_address : 
                                                         '{{ machine.ip_address }}'" class="tech-mono"></span>
                                        </span>
                                        <input x-show="editingField === '{{ machine.id }}-ip_address'"
                                               x-ref="ipAddress{{ machine.id }}"
                                               x-on:click.stop
                                               x-on:keydown.enter.stop="if(validateIp($event.target.value)) { updateField('{{ machine.id }}', 'ip_address', $event.target.value); stopEditing(); }"
                                               x-on:keydown.escape.stop="stopEditing()"
                                               x-on:blur="if(validateIp($event.target.value)) { updateField('{{ machine.id }}', 'ip_address', $event.target.value); stopEditing(); }"
                                               x-effect="if(editingField === '{{ machine.id }}-ip_address') setTimeout(() => $refs['ipAddress{{ machine.id }}'].focus(), 50)"
                                               type="text"
                                               value="{{ machine.ip_address }}"
                                               class="w-full border-b border-indigo-500 bg-transparent focus:outline-none focus:border-indigo-700 dark:text-white tech-mono">
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-3 py-1 inline-flex text-sm leading-5 font-semibold rounded-full 
                                        {% if machine.status == "Ready" %}
                                            bg-green-100 text-green-800 dark:bg-green-400/10 dark:text-green-300 dark:border dark:border-green-500/20
                                        {% elif machine.status == "InstallingOS" %}
                                            bg-yellow-100 text-yellow-800 dark:bg-yellow-400/10 dark:text-yellow-300 dark:border dark:border-yellow-500/20
                                        {% elif machine.status == "AwaitingAssignment" %}
                                            bg-blue-100 text-blue-800 dark:bg-blue-400/10 dark:text-blue-300 dark:border dark:border-blue-500/20
                                        {% elif machine.status == "ExistingOS" %}
                                            bg-sky-100 text-sky-800 dark:bg-sky-400/10 dark:text-sky-300 dark:border dark:border-sky-500/20
                                        {% else %}
                                            bg-red-100 text-red-800 dark:bg-red-400/10 dark:text-red-300 dark:border dark:border-red-500/20
                                        {% endif %}">
                                        {% if machine.status == "Ready" %}
                                            Provisioned
                                        {% elif machine.status == "InstallingOS" %}
                                            Installing OS
                                        {% elif machine.status == "AwaitingAssignment" %}
                                            Awaiting OS Selection
                                        {% elif machine.status == "ExistingOS" %}
                                            Existing OS
                                        {% else %}
                                            Error {# Explicitly handle Error or other unexpected statuses #}
                                        {% endif %}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                    <div class="relative" @click.stop>
                                        <div class="flex items-center cursor-pointer" @click="toggleOsDropdown('{{ machine.id }}')">
                                            {% if machine.os_choice %}
                                                <span class="flex items-center">
                                                    {{ machine.os_choice | format_os_icon | safe }} 
                                                    <span class="ml-1">{{ machine.os_choice | format_os }}</span>
                                                </span>
                                            {% else %}
                                                <span class="text-gray-400 italic flex items-center">
                                                    <i class="fas fa-square-question text-gray-400 mr-1"></i> No OS
                                                </span>
                                            {% endif %}
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                            </svg>
                                        </div>
                                        
                                        <!-- OS Dropdown -->
                                        <div 
                                            x-show="osDropdowns['{{ machine.id }}'] === true"
                                            x-transition:enter="transition ease-out duration-100"
                                            x-transition:enter-start="transform opacity-0 scale-95"
                                            x-transition:enter-end="transform opacity-100 scale-100"
                                            x-transition:leave="transition ease-in duration-75"
                                            x-transition:leave-start="transform opacity-100 scale-100"
                                            x-transition:leave-end="transform opacity-0 scale-95"
                                            class="absolute z-10 mt-1 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none dark:bg-black dark:ring-gray-700"
                                            @click.outside="osDropdowns['{{ machine.id }}'] = false"
                                            x-cloak
                                        >
                                            <div class="py-1">
                                                <!-- OS Options -->
                                                <a href="#" @click.prevent="selectOs('{{ machine.id }}', 'ubuntu-2204')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-gray-700 dark:hover:text-white flex items-center">
                                                    <i class="fab fa-ubuntu text-orange-500 dark:text-orange-500 no-invert mr-2"></i> Ubuntu 22.04
                                                </a>
                                                <a href="#" @click.prevent="selectOs('{{ machine.id }}', 'ubuntu-2404')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-gray-700 dark:hover:text-white flex items-center">
                                                    <i class="fab fa-ubuntu text-orange-500 dark:text-orange-500 no-invert mr-2"></i> Ubuntu 24.04
                                                </a>
                                                <a href="#" @click.prevent="selectOs('{{ machine.id }}', 'debian-12')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-gray-700 dark:hover:text-white flex items-center">
                                                    <i class="fab fa-debian text-red-500 mr-2"></i> Debian 12
                                                </a>
                                                <a href="#" @click.prevent="selectOs('{{ machine.id }}', 'proxmox')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-gray-700 dark:hover:text-white flex items-center">
                                                    <i class="fas fa-server text-blue-500 mr-2"></i> Proxmox
                                                </a>
                                                <a href="#" @click.prevent="selectOs('{{ machine.id }}', 'talos')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-gray-700 dark:hover:text-white flex items-center">
                                                    <i class="fas fa-robot text-purple-500 mr-2"></i> Talos
                                                </a>
                                                <!-- Add more OS options as needed -->
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                    {% if machine.status == "InstallingOS" %}
                                        {% if workflow_infos[machine.id] %}
                                            <div class="flex flex-col space-y-1">
                                                <div class="flex justify-between text-xs">
                                                    <span>{{ workflow_infos[machine.id].progress }}%</span>
                                                    {% if workflow_infos[machine.id].current_action %}
                                                        <span class="ml-2 truncate max-w-[120px]">
                                                            {{ workflow_infos[machine.id].current_action }}
                                                        </span>
                                                    {% endif %}
                                                </div>
                                                <div class="w-full bg-gray-200 rounded-full h-2 dark:bg-gray-700">
                                                    <div class="bg-yellow-500 h-2 rounded-full dark:bg-yellow-600 workflow-progress-bar" data-machine-id="{{ machine.id }}" data-progress="{{ workflow_infos[machine.id].progress }}"></div>
                                                </div>
                                            </div>
                                        {% else %}
                                            <span class="text-xs italic text-gray-400">Awaiting progress data...</span>
                                        {% endif %}
                                    {% else %}
                                        {% if is_admin %} {# Wrap all actions in is_admin check #}
                                        <div class="flex space-x-1 items-center" @click.stop hx-preserve="true">
                                            {# Common Actions - Tags #}
                                            <button 
                                                @click="openTagModal(
                                                    '{{ machine.id }}', 
                                                    '{% if machine.hostname %}
                                                         {{ machine.hostname }}
                                                     {% elif machine.memorable_name %}
                                                         {{ machine.memorable_name }}
                                                     {% else %}
                                                         {{ machine.id }}
                                                     {% endif %}'
                                                )"
                                                class="inline-flex items-center px-3 py-1 border border-transparent text-sm leading-5 font-medium rounded text-purple-700 bg-purple-100 hover:bg-purple-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 dark:bg-purple-900 dark:text-purple-200 dark:hover:bg-purple-800"
                                            >
                                                üè∑Ô∏è Tags
                                            </button>
                                            
                                            {# Apply Button - Only show when there are changes to apply #}
                                            <template x-if="fieldChanges['{{ machine.id }}'] && Object.keys(fieldChanges['{{ machine.id }}']).length > 0">
                                                <button @click="fieldChanges['{{ machine.id }}'].mac_address ? confirmMacChange('{{ machine.id }}') : applyChanges('{{ machine.id }}')" 
                                                        class="inline-flex items-center px-3 py-1 border border-transparent text-sm leading-5 font-medium rounded text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:bg-blue-900 dark:text-blue-200 dark:hover:bg-blue-800">
                                                    ‚ö° Apply
                                                </button>
                                            </template>
                                            
                                            {# Reimage Action - Only show when there are no changes to apply #}
                                            <template x-if="!fieldChanges['{{ machine.id }}'] || Object.keys(fieldChanges['{{ machine.id }}']).length === 0">
                                                {% if machine.status == "Ready" or machine.status == "AwaitingAssignment" or machine.status == "ExistingOS" or machine.status == "Offline" %}
                                                <button @click="openReimageModal('{{ machine.id }}')" class="inline-flex items-center px-3 py-1 border border-transparent text-sm leading-5 font-medium rounded text-cyan-700 bg-cyan-100 hover:bg-cyan-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500 dark:bg-cyan-900 dark:text-cyan-200 dark:hover:bg-cyan-800">
                                                    ‚ôªÔ∏è Reimage
                                                </button>
                                                {% endif %}
                                            </template>

                                            {# Power Action #}
                                            {% if machine.bmc_credentials %}
                                            <button @click="openPowerModal('{{ machine.id }}')" class="inline-flex items-center px-3 py-1 border border-transparent text-sm leading-5 font-medium rounded text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                                ‚èª Power
                                            </button>
                                            {% endif %}
                                            
                                            {# Delete Action #}
                                            <button @click="openDeleteModal('{{ machine.id }}')" class="ml-3 inline-flex items-center p-1 border border-transparent text-sm leading-5 font-medium rounded text-red-700 bg-red-100 hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 dark:bg-red-900 dark:text-red-200 dark:hover:bg-red-800"> {# Added ml-3 for spacing #}
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                                                </svg>
                                            </button>
                                        </div>
                                        {% endif %} {# End is_admin check for actions #}
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="6" class="px-6 py-10 text-center text-gray-500 dark:text-gray-400">
                                    <p class="mb-2">No machines discovered yet.</p>
                                    <p class="text-sm italic">Machines will appear here once they connect to Dragonfly.</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    {# === MODALS === (Moved inside the main x-data div) #}
    <div id="status-modal" class="relative z-10" aria-labelledby="modal-title" role="dialog" aria-modal="true" x-show="statusModal" x-cloak>
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto" @click="statusModal = false">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6" 
                    @click.stop>
                    <!-- Status modal content (Placeholder/Not Used Currently) -->
                    Status Modal Content
                </div>
            </div>
        </div>
    </div>

    <div id="os-modal" class="relative z-10" aria-labelledby="modal-title" role="dialog" aria-modal="true" x-show="osModal" x-cloak>
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto" @click="osModal = false">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6" 
                    @click.stop>
                    <!-- OS modal content (Placeholder/Not Used Currently) -->
                    OS Modal Content
                </div>
            </div>
        </div>
    </div>

    <div id="delete-modal" class="relative z-10" aria-labelledby="modal-title" role="dialog" aria-modal="true" x-show="deleteModal" x-cloak>
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto" @click="deleteModal = false">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6" 
                    @click.stop>
                    <!-- Delete modal content (Generated by showDeleteModal in JS) -->
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                            <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left">
                            <h3 class="text-base font-semibold leading-6 text-gray-900 dark:text-white" id="modal-title">Delete Machine</h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500 dark:text-gray-300">
                                    Are you sure you want to delete machine <code x-text="currentMachineId"></code>? This action cannot be undone.
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                        <button type="button" class="inline-flex w-full justify-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 sm:ml-3 sm:w-auto" @click="deleteMachine(currentMachineId)">Delete</button>
                        <button type="button" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto dark:bg-gray-600 dark:text-white dark:ring-gray-500 dark:hover:bg-gray-500" @click="deleteModal = false">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Tag Editor Modal #}
    <div id="tag-modal" class="relative z-20" aria-labelledby="tag-modal-title" role="dialog" aria-modal="true" x-show="tagModal" x-cloak>
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
        <div class="fixed inset-0 z-20 overflow-y-auto" @click="$dispatch('close-tag-modal')">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6" 
                    @click.stop x-data="tagEditorData()" x-init="if (tagModal) loadTags(currentMachineId)" x-show="tagModal">
                    <h3 class="text-lg font-medium leading-6 text-gray-900 dark:text-white mb-1" id="tag-modal-title">
                        Edit Tags for <code class="text-purple-600 dark:text-purple-400" x-text="currentMachineName"></code>
                    </h3>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">Machine ID: <code class="text-xs" x-text="currentMachineId"></code></p>

                    {# Loading State #}
                    <template x-if="isLoading">
                        <div class="text-center p-4">
                            <span class="text-gray-500 dark:text-gray-400">Loading tags...</span>
                        </div>
                    </template>

                    {# Error Message #}
                    <template x-if="errorMessage">
                        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                            <strong class="font-bold">Error:</strong>
                            <span class="block sm:inline" x-text="errorMessage"></span>
                        </div>
                    </template>

                    {# Tag Editor Content #}
                    <template x-if="!isLoading">
                        <div>
                            {# Display existing tags #}
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Current Tags:</label>
                                <div class="mt-1 flex flex-wrap gap-2" x-show="tags.length > 0">
                                    <template x-for="(tag, index) in tags" :key="index">
                                        <span class="inline-flex items-center rounded-full bg-purple-100 dark:bg-purple-900 py-0.5 pl-2.5 pr-1 text-sm font-medium text-purple-700 dark:text-purple-200">
                                            <span x-text="tag"></span>
                                            <button @click="removeTag(index)" type="button" class="ml-0.5 inline-flex h-4 w-4 flex-shrink-0 items-center justify-center rounded-full text-purple-400 hover:bg-purple-200 hover:text-purple-500 focus:bg-purple-500 focus:text-white focus:outline-none">
                                                <span class="sr-only">Remove tag</span>
                                                <svg class="h-2 w-2" stroke="currentColor" fill="none" viewBox="0 0 8 8">
                                                    <path stroke-linecap="round" stroke-width="1.5" d="M1 1l6 6m0-6L1 7" />
                                                </svg>
                                            </button>
                                        </span>
                                    </template>
                                </div>
                                <p x-show="tags.length === 0" class="mt-1 text-sm text-gray-500 dark:text-gray-400 italic">No tags assigned.</p>
                            </div>

                            {# Add New Tag Input #}
                            <div class="mb-4">
                                <label for="new-tag-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Add New Tag:</label>
                                <div class="mt-1 flex rounded-md shadow-sm">
                                    <input type="text" id="new-tag-input" x-model="newTag" @keydown.enter.prevent="addTag()" @keydown.space.prevent="addTag()" placeholder="Enter tag name" class="block w-full flex-1 rounded-none rounded-l-md border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    <button @click="addTag()" type="button" class="relative -ml-px inline-flex items-center space-x-2 rounded-r-md border border-gray-300 bg-gray-50 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100 focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 dark:bg-gray-600 dark:border-gray-600 dark:text-gray-200 dark:hover:bg-gray-500">
                                        <span>Add</span>
                                    </button>
                                </div>
                                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Press Enter or Space to add the tag.</p>
                            </div>
                        </div>
                    </template>

                    {# Modal Buttons #}
                    <div class="mt-5 sm:mt-6 sm:grid sm:grid-flow-row-dense sm:grid-cols-2 sm:gap-3">
                        <button 
                            type="button" 
                            class="inline-flex w-full justify-center rounded-md border border-transparent bg-indigo-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 sm:col-start-2 sm:text-sm disabled:opacity-50"
                            @click="saveTags()" 
                            :disabled="isLoading"
                        >
                            Save Tags
                        </button>
                        <button 
                            type="button" 
                            class="mt-3 inline-flex w-full justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-base font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 sm:col-start-1 sm:mt-0 sm:text-sm dark:bg-gray-600 dark:text-white dark:border-gray-500 dark:hover:bg-gray-500"
                            @click="$dispatch('close-tag-modal')"
                        >
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Reimage Modal #}
    <div id="reimage-modal" class="relative z-10" aria-labelledby="modal-title" role="dialog" aria-modal="true" x-show="reimageModal" x-cloak>
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto" @click="reimageModal = false">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6" 
                    @click.stop>
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-cyan-100 sm:mx-0 sm:h-10 sm:w-10">
                            <svg class="h-6 w-6 text-cyan-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12c0-1.232-.046-2.453-.138-3.662a4.006 4.006 0 0 0-3.7-3.7 48.678 48.678 0 0 0-7.324 0 4.006 4.006 0 0 0-3.7 3.7c-.092 1.21-.138 2.43-.138 3.662v.012c0 1.232.046 2.453.138 3.662a4.006 4.006 0 0 0 3.7 3.7 48.656 48.656 0 0 0 7.324 0 4.006 4.006 0 0 0 3.7-3.7c.092-1.21.138-2.43.138-3.662v-.012Zm-7 0a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Z" />
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left">
                            <h3 class="text-base font-semibold leading-6 text-gray-900 dark:text-white" id="modal-title">Reimage Machine</h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500 dark:text-gray-300">Select an OS to reimage machine <code x-text="currentMachineId"></code> with. (Not Implemented)</p>
                                {# TODO: Add OS selection dropdown/buttons and trigger reimage API call #}
                            </div>
                        </div>
                    </div>
                    <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                        <button type="button" class="disabled:opacity-50 inline-flex w-full justify-center rounded-md bg-cyan-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-cyan-500 sm:ml-3 sm:w-auto" disabled>Reimage</button>
                        <button type="button" @click="reimageModal = false" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto dark:bg-gray-600 dark:text-white dark:ring-gray-500 dark:hover:bg-gray-500">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Power Modal #}
    <div id="power-modal" class="relative z-10" aria-labelledby="modal-title" role="dialog" aria-modal="true" x-show="powerModal" x-cloak>
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto" @click="powerModal = false">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6" 
                    @click.stop>
                     <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                            <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                               <path stroke-linecap="round" stroke-linejoin="round" d="M5.636 5.636a9 9 0 1 0 12.728 0M12 3v9" />
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left">
                            <h3 class="text-base font-semibold leading-6 text-gray-900 dark:text-white" id="modal-title">Power Control</h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500 dark:text-gray-300">Control power for machine <code x-text="currentMachineId"></code>. (Not Implemented)</p>
                                {# TODO: Add buttons for Power On, Power Off, Reboot using BMC API #}
                            </div>
                        </div>
                    </div>
                    <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse space-x-reverse space-x-2">
                        <button type="button" @click="powerModal = false" class="inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto dark:bg-gray-600 dark:text-white dark:ring-gray-500 dark:hover:bg-gray-500">Cancel</button>
                        <button type="button" class="disabled:opacity-50 inline-flex w-full justify-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 sm:w-auto" disabled>Power Off</button>
                        <button type="button" class="disabled:opacity-50 inline-flex w-full justify-center rounded-md bg-green-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-500 sm:w-auto" disabled>Power On</button>
                     </div>
                </div>
            </div>
        </div>
    </div>
    {# === END MODALS === #}

</div> {# End of main x-data div #}
{% endblock %}

{% block scripts %}
{# Add the idiomorph script BEFORE your main script block if possible #}
{# Ideally, move this to your base.html head or before the main htmx script #}
<script src="https://unpkg.com/idiomorph/dist/idiomorph-ext.min.js"></script> 

<script>
    // Check if user is authenticated before allowing admin actions
    function requireAdmin(callback) {
        // window.isAuthenticated is now set by Alpine's x-init
        if (!window.isAuthenticated) {
            alert("You need to be logged in as admin to perform this action.");
            return false;
        }
        return callback();
    }

    // Alpine.js component for the Tag Editor Modal
    function tagEditorData() {
        return {
            tags: [],
            newTag: '',
            isLoading: false,
            errorMessage: null,
            currentMachineId: null, // To store the machine ID when loading

            loadTags(machineId) {
                if (!machineId) return;
                this.currentMachineId = machineId;
                this.isLoading = true;
                this.errorMessage = null;
                fetch(`/api/machines/${machineId}/tags`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        this.tags = Array.isArray(data) ? data : []; // Ensure it's an array
                    })
                    .catch(error => {
                        console.error("Error loading tags:", error);
                        this.errorMessage = "Could not load tags. " + error.message;
                        this.tags = []; // Clear tags on error
                    })
                    .finally(() => {
                        this.isLoading = false;
                    });
            },

            addTag() {
                const tagToAdd = this.newTag.trim();
                if (tagToAdd && !this.tags.includes(tagToAdd)) {
                    this.tags.push(tagToAdd);
                }
                this.newTag = ''; // Clear input
            },

            removeTag(index) {
                this.tags.splice(index, 1);
            },

            saveTags() {
                if (!this.currentMachineId) return;
                this.isLoading = true;
                this.errorMessage = null;
                fetch(`/api/machines/${this.currentMachineId}/tags`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(this.tags)
                })
                .then(response => {
                    if (!response.ok) {
                         // Try to parse error message from backend
                        return response.json().then(err => {
                            throw new Error(err.message || `HTTP error! status: ${response.status}`);
                        }).catch(() => {
                             throw new Error(`HTTP error! status: ${response.status}`); // Fallback error
                        });
                    }
                    return response.json(); 
                })
                .then(data => {
                    // Optionally handle success response data if needed
                    this.$dispatch('close-tag-modal');
                    // Trigger refresh - relying on SSE if backend emits event
                     // htmx.trigger(document.body, 'refreshMachines'); 
                })
                .catch(error => {
                    console.error("Error saving tags:", error);
                    this.errorMessage = "Could not save tags. " + error.message;
                })
                .finally(() => {
                    this.isLoading = false;
                });
            }
        };
    }

    // Initialize Alpine.js
    document.addEventListener('alpine:init', () => {
        Alpine.data('tagEditorData', tagEditorData);
    });

    // Make sure loadTags is called when the modal becomes visible
    // We added this to the x-init on the modal div itself: x-init="if (tagModal) loadTags(currentMachineId)"
    // Need to also watch currentMachineId changes if the modal stays open and ID changes (unlikely here)

    // Debounced refresh function (if needed)
    function debouncedRefresh() {
        clearTimeout(window._updateDebounceTimer);
        window._updateDebounceTimer = setTimeout(() => {
            htmx.trigger(document.body, 'refreshMachines');
        }, 250); // 250ms debounce
    }

    // Server-sent events handling
    let evtSource = null;
    let reconnectAttempts = 0;
    const MAX_RECONNECT_ATTEMPTS = 5;
    
    // Map to track progress bars on the page
    let progressBars = {};
    let animationFrameId = null;
    
    // --- Helper functions for color ---
    function getProgressColorName(progress) {
        if (progress <= 40) {
            return 'orange';
        } else if (progress <= 80) {
            return 'cyan';
        } else {
            return 'green';
        }
    }

    // Map color names to Tailwind classes
    const colorClasses = {
        orange: ['bg-orange-500', 'dark:bg-orange-600'],
        cyan: ['bg-cyan-500', 'dark:bg-cyan-600'],
        green: ['bg-green-500', 'dark:bg-green-600']
    };
    // --- End Helper functions ---

    // Function to update progress bars with smooth animation
    function updateProgressBarsAnimation() {
        let needsUpdate = false;
        
        // Update each progress bar
        for (const machineId in progressBars) {
            const barData = progressBars[machineId];
            const {current, target} = barData;

            if (Math.abs(current - target) > 0.1 || target === 0 && current !== 0 /* Ensure it animates back to 0 if needed */ ) {
                // Smoothly animate towards target
                const delta = (target - current) * 0.1; // Adjust multiplier for faster/slower animation
                barData.current += delta;
                // Ensure current doesn't overshoot target significantly in one step
                if ((delta > 0 && barData.current > target) || (delta < 0 && barData.current < target)) {
                     barData.current = target;
                }
                needsUpdate = true;
                
                // Update the DOM
                const progressBar = document.querySelector(`.workflow-progress-bar[data-machine-id="${machineId}"]`);
                if (progressBar) {
                    const currentProgressRounded = Math.round(barData.current);
                    // Update width
                    progressBar.style.width = `${currentProgressRounded}%`;
                    
                    // Update text
                    const textDisplay = progressBar.closest('div.w-full').previousElementSibling?.querySelector('span:first-child');
                    if (textDisplay) {
                        textDisplay.textContent = `${currentProgressRounded}%`;
                    }

                    // --- Update Color ---
                    const newColorName = getProgressColorName(currentProgressRounded);
                    if (newColorName !== barData.currentColorName) {
                        // Remove old classes
                        if (barData.currentColorName && colorClasses[barData.currentColorName]) {
                            progressBar.classList.remove(...colorClasses[barData.currentColorName]);
                        }
                        // Add new classes
                        if (colorClasses[newColorName]) {
                            progressBar.classList.add(...colorClasses[newColorName]);
                        }
                        barData.currentColorName = newColorName; // Update stored color name
                    }
                    // --- End Update Color ---
                }
            } else if (Math.abs(current - target) <= 0.1 && current !== target) {
                 // Snap to final target value if very close
                 barData.current = target;
                 // Update DOM one last time for pixel perfection
                 const progressBar = document.querySelector(`.workflow-progress-bar[data-machine-id="${machineId}"]`);
                 if (progressBar) {
                     const finalProgress = Math.round(barData.current);
                     progressBar.style.width = `${finalProgress}%`;
                     const textDisplay = progressBar.closest('div.w-full').previousElementSibling?.querySelector('span:first-child');
                     if (textDisplay) { textDisplay.textContent = `${finalProgress}%`; }
                     
                     // Ensure final color is set
                     const finalColorName = getProgressColorName(finalProgress);
                     if (finalColorName !== barData.currentColorName) {
                         if (barData.currentColorName && colorClasses[barData.currentColorName]) { progressBar.classList.remove(...colorClasses[barData.currentColorName]); }
                         if (colorClasses[finalColorName]) { progressBar.classList.add(...colorClasses[finalColorName]); }
                         barData.currentColorName = finalColorName;
                     }
                 }
            }
        }
        
        // Continue animation if needed
        if (needsUpdate) {
            animationFrameId = requestAnimationFrame(updateProgressBarsAnimation);
        } else {
            console.log('Progress animation loop stopped.');
            animationFrameId = null;
        }
    }
    
    // Initialize progress tracking
    function initializeProgressBars() {
        // Intentionally simple: just find existing bars. 
        // Let htmx:afterSwap handle the main initialization/update logic.
        if (document.querySelector('.workflow-progress-bar') && !animationFrameId) {
             console.log('Initial progress bars found, starting animation loop.');
             animationFrameId = requestAnimationFrame(updateProgressBarsAnimation);
        }
    }
    
    // Update progress targets when the machine list refreshes
    document.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'machine-list') {
            console.log('htmx:afterSwap detected for machine-list');
            
            const oldProgressBars = {...progressBars}; // Keep track of previous state
            const currentMachineIds = new Set(); // Track IDs present in the new HTML
            
            // Re-initialize map with new elements and target values from data-progress
            let hasProgressBars = false;
            document.querySelectorAll('.workflow-progress-bar').forEach(bar => {
                hasProgressBars = true;
                const machineId = bar.getAttribute('data-machine-id');
                currentMachineIds.add(machineId); // Mark this ID as present
                const newTargetProgress = parseInt(bar.getAttribute('data-progress'), 10);
                
                let currentProgress;
                let currentColorName;

                if (oldProgressBars[machineId]) {
                    // Existing bar: Use old current value, update target
                    currentProgress = oldProgressBars[machineId].current;
                    currentColorName = oldProgressBars[machineId].currentColorName; 
                    // Ensure the initial color class matches the stored name
                     const expectedColorName = getProgressColorName(Math.round(currentProgress));
                     if (expectedColorName !== currentColorName) {
                          console.warn(`Correcting stored color for ${machineId}. Was ${currentColorName}, should be ${expectedColorName}`);
                          currentColorName = expectedColorName;
                     }

                } else {
                    // New bar: Start animation from 0, set target
                    currentProgress = 0; 
                    currentColorName = getProgressColorName(0); // Should be 'orange'
                }

                progressBars[machineId] = {
                    current: currentProgress, 
                    target: newTargetProgress,
                    currentColorName: currentColorName 
                };

                // --- Ensure Initial Color Classes are Set ---
                // Remove potentially incorrect classes from previous renders/states
                Object.values(colorClasses).flat().forEach(cls => bar.classList.remove(cls));
                // Add the correct initial classes based on *current* state
                const initialColorName = getProgressColorName(Math.round(currentProgress)); // Use current for initial display
                if(initialColorName !== currentColorName) {
                    console.warn(`Mismatch initial color name for ${machineId}, using ${initialColorName}`);
                    progressBars[machineId].currentColorName = initialColorName; // Correct the state too
                }
                if (colorClasses[initialColorName]) {
                    bar.classList.add(...colorClasses[initialColorName]);
                }
                 // Set initial width
                 bar.style.width = `${Math.round(currentProgress)}%`;
                // --- End Initial Color ---

                console.log(`Updated progressBars[${machineId}]: current=${currentProgress.toFixed(1)}, target=${newTargetProgress}, color=${progressBars[machineId].currentColorName}`);
            });

            // Remove data for machines no longer in the list
            for (const machineId in progressBars) {
                if (!currentMachineIds.has(machineId)) {
                    console.log(`Removing progress data for disappeared machine: ${machineId}`);
                    delete progressBars[machineId];
                }
            }
            
            // Start animation loop ONLY if there are progress bars and it's not already running
            if (hasProgressBars && !animationFrameId) {
                console.log('Starting progress animation loop.');
                animationFrameId = requestAnimationFrame(updateProgressBarsAnimation);
            } else if (!hasProgressBars && animationFrameId) {
                // Stop animation if no bars are left
                console.log('No progress bars found, stopping animation loop.');
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
        }
    });

    function connectEventSource() {
        // Check if already connected
        if (window.dragonflyEvtSource && window.dragonflyEvtSource.readyState !== EventSource.CLOSED) {
            console.log('EventSource already open.');
            return; 
        }

        if (evtSource) { // Reuse existing evtSource variable if page reloaded strangely
            evtSource.close();
        }

        console.log("Connecting to EventSource...");
        evtSource = new EventSource('/api/events');
        window.dragonflyEvtSource = evtSource; // Store globally to check existence
        
        evtSource.onmessage = function(event) {
            console.log('Event received:', event.data);
            const [type, id] = event.data.split(':');
            
            switch(type) {
                case 'machine_discovered':
                    console.log('New machine discovered!');
                    debouncedRefresh();
                    break;
                case 'machine_updated':
                    console.log('Machine updated!');
                    debouncedRefresh();
                    break;
                case 'machine_deleted':
                    console.log('Machine deleted!');
                    debouncedRefresh();
                    break;
            }
        };

        evtSource.onopen = function() {
            console.log('EventSource connected');
            reconnectAttempts = 0;
        };

        evtSource.onerror = function(err) {
            console.error("EventSource failed:", err);
            evtSource.close();
            
            if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                reconnectAttempts++;
                const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
                console.log(`Reconnecting in ${delay}ms (attempt ${reconnectAttempts})`);
                setTimeout(connectEventSource, delay);
            }
        };
    }

    // Initial connection
    connectEventSource();
    
    // Initialize progress bars on page load (will start animation if bars exist)
    document.addEventListener('DOMContentLoaded', function() {
        // Populate the progressBars map initially based on DOM state
        progressBars = {}; // Clear just in case
         document.querySelectorAll('.workflow-progress-bar').forEach(bar => {
            const machineId = bar.getAttribute('data-machine-id');
            const initialProgress = parseInt(bar.getAttribute('data-progress'), 10);
            const initialColorName = getProgressColorName(initialProgress);
            
            progressBars[machineId] = {
                current: initialProgress, // Start current at the initial target for first load
                target: initialProgress,
                currentColorName: initialColorName
            };
             // Set initial color and width explicitly
             Object.values(colorClasses).flat().forEach(cls => bar.classList.remove(cls)); // Clear first
             if (colorClasses[initialColorName]) {
                bar.classList.add(...colorClasses[initialColorName]);
             }
             bar.style.width = `${initialProgress}%`;
        });
        initializeProgressBars(); // This will check if bars exist and start the animation loop if needed
    });

    // Clean up when leaving the page
    window.addEventListener('beforeunload', () => {
        if (evtSource) {
            evtSource.close();
        }
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
        }
    });

    function deleteMachine(id) {
        // Find the component controlling the delete modal *before* the fetch
        // let componentRoot = document.getElementById('delete-modal')?.closest('[x-data]'); // No longer needed

        requireAdmin(() => {
            fetch(`/api/machines/${id}`, {
                method: 'DELETE',
            })
            .then(response => {
                if (response.ok) {
                    // Dispatch an event to close the modal
                    window.dispatchEvent(new CustomEvent('close-delete-modal'));
                    
                    // Trigger table refresh via SSE (already handled by backend event)
                    // htmx.trigger(document.querySelector('tbody#machine-list'), 'refreshMachines'); // Redundant if SSE works
                } else {
                    // Handle error response from server potentially
                    response.json().then(err => {
                         console.error('Error deleting machine:', err);
                         alert(`Error deleting machine: ${err.message || 'Unknown error'}`);
                    }).catch(() => {
                         alert('Error deleting machine and failed to parse error response.');
                    });
                }
            })
            .catch(error => {
                 console.error('Network or other error deleting machine:', error);
                 alert('Network error deleting machine. See console.');
            });
        });
    }
</script>
{% endblock %}