{% extends "base.html" %}

{% block content %}
{# Add styles for the custom border width at the top of the file #}
<style>
    .border-3 {
        border-width: 3px !important;
    }
</style>
{# Remove data attributes, embed JSON in script tags #}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8"
     x-data="machineDetailsData()" 
     x-init="initializeComponent()">

    {# Embed JSON data using script tags #}
    <script id="machine-data-json" type="application/json">
        {{ machine_json | safe }} {# Use safe within script tag #}
    </script>
    <script id="workflow-data-json" type="application/json">
        {{ workflow_info_json | safe }} {# Use safe within script tag #}
    </script>

    <div class="flex justify-between items-center mb-8">
        <h2 class="text-2xl font-bold leading-7 text-gray-900 dark:text-white" x-text="machine.hostname || machine.ip_address || 'Loading...'">Machine Details</h2> 
        <a href="/machines" class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
            Back to Machines
        </a>
    </div>

    <div class="bg-white dark:bg-[#1e293b] shadow overflow-hidden sm:rounded-lg mb-6 border border-transparent dark:border-white dark:border-opacity-5 dark:shadow-lg">
        <div class="px-4 py-5 sm:px-6 flex justify-between items-center">
            {# Use Alpine data #}
            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" x-text="machine.hostname || machine.ip_address">
            </h3>
            <div class="flex items-center">
                <span class="font-bold text-gray-900 dark:text-white mr-2">Status:</span>
                 {# Bind classes and text to Alpine data #}
                <span id="machine-status-indicator" class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full" 
                      :class="{
                          'bg-green-100 text-green-800 dark:bg-green-400/10 dark:text-green-300 dark:border dark:border-green-500/20': machine.status === 'Ready',
                          'bg-yellow-100 text-yellow-800 dark:bg-yellow-400/10 dark:text-yellow-300 dark:border dark:border-yellow-500/20': machine.status === 'InstallingOS',
                          'bg-sky-100 text-sky-800 dark:bg-sky-400/10 dark:text-sky-300 dark:border dark:border-sky-500/20': machine.status === 'ExistingOS',
                          'bg-blue-100 text-blue-800 dark:bg-blue-400/10 dark:text-blue-300 dark:border dark:border-blue-500/20': machine.status === 'AwaitingAssignment',
                          'bg-red-100 text-red-800 dark:bg-red-400/10 dark:text-red-300 dark:border dark:border-red-500/20': !['Ready', 'InstallingOS', 'ExistingOS', 'AwaitingAssignment'].includes(machine.status)
                      }">
                    <span x-text="
                        machine.status === 'Ready' ? 'Provisioned' :
                        machine.status === 'InstallingOS' ? 'Installing OS' :
                        machine.status === 'AwaitingAssignment' ? 'Awaiting OS Selection' :
                        machine.status"></span>
                </span>
            </div>
        </div>

        <!-- Deployment Progress Section - Use x-if based on Alpine data -->
        <template x-if="machine.status === 'InstallingOS'">
            <template x-if="workflow_info">
                <div class="border-t border-gray-200 dark:border-gray-700 p-4 sm:p-6 bg-yellow-50 dark:bg-yellow-900/10"
                     id="workflow-progress-container"> {# Keep ID for potential direct targeting? #}
                    <div class="mb-4">
                        <h3 class="text-lg font-medium leading-6 text-gray-900 dark:text-yellow-100">Deployment Progress</h3>
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-300">
                            Template: <span class="font-semibold" x-text="workflow_info.template_name"></span>
                             <template x-if="workflow_info.current_action"> â€¢ Current action: <span x-text="workflow_info.current_action"></span></template>
                             <template x-if="workflow_info.current_action == 'Completed via kexec detection'">
                                <span class="ml-2 italic">(Auto-detected successful deployment)</span>
                            </template>
                        </p>
                    </div>
                    
                    {# ... rest of the progress section, binding to workflow_info ... #}
                    <div class="relative pt-1">
                        <div class="flex mb-2 items-center justify-between">
                             <div>
                                <span id="workflow-state-badge" class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full"
                                     :class="{
                                        'text-red-600 bg-red-200 dark:text-red-200 dark:bg-red-800/30': workflow_info.state === 'STATE_FAILED',
                                        'text-yellow-600 bg-yellow-200 dark:text-yellow-200 dark:bg-yellow-800/30': workflow_info.state !== 'STATE_FAILED'
                                     }">
                                     <span x-text="workflow_info.state === 'STATE_FAILED' ? 'Failed' : 'In Progress'"></span>
                                </span>
                            </div>
                             <div class="text-right">
                                <span id="workflow-progress-percent-text" class="text-xs font-semibold inline-block text-yellow-600 dark:text-yellow-200 workflow-progress-percent"
                                      x-text="workflow_info.progress + '% Complete'">
                                </span>
                            </div>
                        </div>
                        <div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-yellow-200 dark:bg-yellow-700/30">
                            <div
                                id="workflow-progress-bar"
                                class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center workflow-overall-progress"
                                :class="workflow_info.state === 'STATE_FAILED' ? 'bg-red-500 dark:bg-red-600' : 'bg-yellow-500 dark:bg-yellow-600'"
                                :style="'width: ' + (workflow_info.progress || 0) + '%;'"
                                :data-progress="workflow_info.progress || 0">
                            </div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <h4 class="text-sm font-medium leading-6 text-gray-700 dark:text-gray-200 mb-2">Task Timeline</h4>
                        <div id="tasks-table-container" class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Action</th>
                                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Started At</th>
                                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Duration</th>
                                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Est. Duration</th>
                                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="tasks-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                     {# Use x-for to loop through Alpine data #}
                                     <template x-for="task in workflow_info.tasks" :key="task.name">
                                         <tr :data-task-name="task.name"
                                             :data-task-status="task.status"
                                             :data-started-at="task.started_at"
                                             :data-estimated-duration="task.estimated_duration">
                                             <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white" x-text="task.name"></td>
                                             <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400" x-text="task.started_at || 'N/A'"></td>
                                             <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                                 <template x-if="task.status === 'STATE_SUCCESS'">
                                                     <span x-text="task.reported_duration + 's'"></span>
                                                 </template>
                                                 <template x-if="task.status === 'STATE_RUNNING'">
                                                     <div class="relative w-32">
                                                         <div class="overflow-hidden h-2 text-xs flex rounded bg-blue-200 dark:bg-blue-700/30">
                                                             <div class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-blue-500 dark:bg-blue-600 task-progress-bar"
                                                                  :style="'width: ' + (taskProgressState[task.name]?.percent || 0) + '%;'"
                                                                  :data-progress="taskProgressState[task.name]?.percent || 0">
                                                             </div>
                                                         </div>
                                                         <div class="text-xs mt-1 progress-text" x-text="generateProgressText(taskProgressState[task.name])"></div>
                                                     </div>
                                                 </template>
                                                 <template x-if="task.status !== 'STATE_SUCCESS' && task.status !== 'STATE_RUNNING'">
                                                     <span>Pending</span>
                                                 </template>
                                             </td>
                                             <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                                 {# Display estimated duration first - Use Alpine #}
                                                 <template x-if="task.estimated_duration !== null && task.estimated_duration !== undefined">
                                                     <span x-text="task.estimated_duration + 's'"></span>
                                                 </template>
                                                 <template x-if="task.estimated_duration === null || task.estimated_duration === undefined">
                                                     <span>N/A</span>
                                                 </template>
    
                                                 {# Separately check and display comparison if possible and relevant - Use Alpine #}
                                                 <template x-if="task.status === 'STATE_SUCCESS' && 
                                                            task.estimated_duration !== null && task.estimated_duration !== undefined && 
                                                            task.reported_duration !== null && task.reported_duration !== undefined &&
                                                            task.reported_duration !== task.estimated_duration">
                                                     <template x-if="task.reported_duration > task.estimated_duration">
                                                         <span class="text-red-500 ml-1" x-text="'(+' + (task.reported_duration - task.estimated_duration) + 's)'"></span>
                                                     </template>
                                                     <template x-if="task.reported_duration < task.estimated_duration">
                                                         <span class="text-green-500 ml-1" x-text="'(-' + (task.estimated_duration - task.reported_duration) + 's)'"></span>
                                                     </template>
                                                 </template>
                                             </td>
                                            <td class="px-3 py-2 whitespace-nowrap text-sm">
                                                {# Use Alpine :class for status styling #}
                                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                                                      :class="{
                                                          'bg-green-100 text-green-800 dark:bg-green-400/10 dark:text-green-300': task.status === 'STATE_SUCCESS',
                                                          'bg-red-100 text-red-800 dark:bg-red-400/10 dark:text-red-300': task.status === 'STATE_FAILED',
                                                          'bg-yellow-100 text-yellow-800 dark:bg-yellow-400/10 dark:text-yellow-300': task.status === 'STATE_RUNNING',
                                                          'bg-gray-100 text-gray-800 dark:bg-gray-400/10 dark:text-gray-300': !['STATE_SUCCESS', 'STATE_FAILED', 'STATE_RUNNING'].includes(task.status)
                                                      }">
                                                    <span x-text="task.status"></span> {# Use Alpine x-text #}
                                                </span>
                                            </td>
                                        </tr>
                                     </template>
                                </tbody>
                            </table>
                        </div>

                        {# Display estimated completion using Alpine #}
                        <template x-if="workflow_info && workflow_info.estimated_completion !== null && workflow_info.estimated_completion !== undefined">
                            <div class="mt-4 text-sm text-gray-600 dark:text-gray-300">
                                <p>Estimated completion: <span x-text="workflow_info.estimated_completion"></span></p>
                            </div>
                        </template>
                    </div>
                </div>
            </template>
             <template x-if="!workflow_info">
                <div class="border-t border-gray-200 dark:border-gray-700 p-4 sm:p-6 bg-gray-50 dark:bg-gray-800/30">
                     <p class="text-sm text-gray-500 dark:text-gray-400 italic">Waiting for workflow information...</p>
                 </div>
            </template>
        </template>

        <div class="border-t border-gray-200 dark:border-gray-700">
            <!-- Two-column layout for Basic Info and Network Config -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 p-4 sm:p-6">
                 <!-- Basic Information -->
                 <div class="bg-gray-50 dark:bg-gray-800/50 rounded-lg shadow-sm overflow-hidden border border-gray-100 dark:border-gray-700">
                    <div class="px-4 py-3 bg-gray-100 dark:bg-gray-700">
                        <h3 class="text-lg font-medium leading-6 text-gray-900 dark:text-white">Basic Information</h3>
                    </div>
                    <div class="px-4 py-4">
                        <dl class="divide-y divide-gray-200 dark:divide-gray-700">
                            {# MAC Address #}
                            <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4">
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">MAC Address</dt>
                                <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2 tech-mono" 
                                    x-text="machine.mac_address" x-show="!isEditing"></dd>
                                <template x-if="isEditing">
                                    <input type="text" id="mac_address" x-model="editForm.mac_address" 
                                           class="mt-1 block w-full border border-gray-400 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm sm:col-span-2 tech-mono">
                                </template>
                            </div>
                            {# Hostname #}
                            <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4">
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Hostname</dt>
                                <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2" 
                                    x-text="machine.hostname || 'Not set'" x-show="!isEditing"></dd>
                                <template x-if="isEditing">
                                    <input type="text" id="hostname" x-model="editForm.hostname" 
                                           class="mt-1 block w-full border border-gray-400 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm sm:col-span-2">
                                </template>
                            </div>
                            {# Memorable Name #}
                            <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4">
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Machine Name</dt>
                                <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2" x-show="!isEditing">
                                    {{ machine.memorable_name | default('Not set') }}
                                </dd>
                                <template x-if="isEditing">
                                    <input type="text" id="memorable_name" x-model="editForm.memorable_name" 
                                           class="mt-1 block w-full border border-gray-400 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm sm:col-span-2">
                                </template>
                            </div>
                            {# Created At #}
                            <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4">
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Created</dt>
                                <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2">
                                    {{ created_at_formatted }}
                                </dd>
                            </div>
                            {# Last Updated #}
                            <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4">
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Last updated</dt>
                                <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2">{{ updated_at_formatted }}</dd>
                            </div>
                            {# Last Deployment Duration (Read Only) #}
                            {% if machine.last_deployment_duration is not none %}
                            <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4">
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Last deployment duration</dt>
                                <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2">
                                    {% set duration = machine.last_deployment_duration.unwrap() %}
                                    {% if duration < 60 %}
                                        {{ duration }} seconds
                                    {% elif duration < 3600 %}
                                        {{ duration / 60 }} minutes
                                    {% else %}
                                        {{ duration / 3600 }} hours {{ (duration % 3600) / 60 }} minutes
                                    {% endif %}
                                </dd>
                            </div>
                            {% endif %}
                            {# OS #}
                            <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4">
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">OS</dt>
                                <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2 flex items-center" x-show="!isEditing">
                                     <template x-if="machine.os_choice">
                                        <span>
                                            {# Need a way to format OS icon/name in Alpine #}
                                            <i class="fab fa-ubuntu text-orange-500 mr-2" x-show="machine.os_choice.includes('ubuntu')"></i>
                                            <span class="ml-2" x-text="machine.os_choice"></span>
                                        </span>
                                    </template>
                                    <template x-if="!machine.os_choice">
                                        <span>
                                            <i class="fas fa-square-question text-gray-500 mr-2"></i>
                                            <span>No OS Selected</span>
                                        </span>
                                    </template>
                                </dd>
                                <template x-if="isEditing">
                                    <select id="os_choice" x-model="editForm.os_choice" 
                                            class="mt-1 block w-full border border-gray-400 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm sm:col-span-2">
                                        <option value="">Select OS</option>
                                        <option value="ubuntu-2204">Ubuntu 22.04</option>
                                        <option value="ubuntu-2404">Ubuntu 24.04</option>
                                        <option value="debian-12">Debian 12</option>
                                        <option value="proxmox">Proxmox</option>
                                        <option value="talos">Talos</option>
                                    </select>
                                </template>
                            </div>
                        </dl>
                    </div>
                </div>

                 <!-- Network Configuration -->
                <div class="bg-blue-50 dark:bg-blue-900/10 rounded-lg shadow-sm overflow-hidden border border-blue-100 dark:border-blue-800/30">
                    <div class="px-4 py-3 bg-blue-100 dark:bg-blue-800/30">
                        <h3 class="text-lg font-medium leading-6 text-gray-900 dark:text-white">Network Configuration</h3>
                    </div>
                    <div class="px-4 py-4">
                        <dl class="divide-y divide-gray-200 dark:divide-gray-700">
                            {# IP Address #}
                            <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4">
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">IP Address</dt>
                                <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2 tech-mono" 
                                    x-text="machine.ip_address" x-show="!isEditing"></dd>
                                <template x-if="isEditing">
                                    <input type="text" id="ip_address" x-model="editForm.ip_address" 
                                           class="mt-1 block w-full border border-gray-400 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm sm:col-span-2 tech-mono">
                                </template>
                            </div>
                            {# NEW: IP Address Type #}
                            <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4">
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">IP Assignment</dt>
                                <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2">
                                    <span class="px-2 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full"
                                          :class="{'bg-cyan-100 text-cyan-800 dark:bg-cyan-400/10 dark:text-cyan-300': ipAddressType === 'DHCP', 
                                                   'bg-purple-100 text-purple-800 dark:bg-purple-400/10 dark:text-purple-300': ipAddressType !== 'DHCP'}">
                                        <span x-text="ipAddressType"></span>
                                    </span>
                                </dd>
                            </div>
                            {# DNS Servers (Read Only) #}
                            <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4">
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">DNS Servers</dt>
                                <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2">
                                    {% if machine.nameservers | length == 0 %}
                                        No DNS servers configured
                                    {% else %}
                                        {% for dns in machine.nameservers %}
                                        <span class="tech-mono">{{ dns }}</span><br>
                                        {% endfor %}
                                    {% endif %}
                                </dd>
                            </div>
                            {# BMC Type (Read Only) #}
                            <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4">
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">BMC Type</dt>
                                <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2 flex items-center">
                                    {% if machine.bmc_credentials %}
                                        {{ machine.bmc_credentials.bmc_type }}
                                    {% else %}
                                        None
                                        <button class="ml-3 inline-flex items-center px-3 py-1 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-green-100 text-green-800">
                                            Add BMC Credentials
                                        </button>
                                    {% endif %}
                                </dd>
                            </div>
                        </dl>
                    </div>
                </div>

                 <!-- Hardware Information -->
                 <div class="bg-green-50 dark:bg-green-900/10 rounded-lg shadow-sm overflow-hidden border border-green-100 dark:border-green-800/30 md:col-span-1">
                    <div class="px-4 py-3 bg-green-100 dark:bg-green-800/30">
                        <h3 class="text-lg font-medium leading-6 text-gray-900 dark:text-white">Hardware</h3>
                    </div>
                    <div class="px-4 py-4">
                        <dl class="divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- CPU Model -->
                            <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4">
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">CPU Model</dt>
                                <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2" x-text="machine.cpu_model || 'Unknown'"></dd>
                            </div>
                            <!-- CPU Cores -->
                            <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4">
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">CPU Cores</dt>
                                <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2" x-text="machine.cpu_cores !== null ? machine.cpu_cores : 'Unknown'"></dd>
                            </div>
                            <!-- Total RAM -->
                            <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4">
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Total RAM</dt>
                                <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2" 
                                    x-text="machine.total_ram_bytes !== null ? (machine.total_ram_bytes / (1024**3)).toFixed(1) + ' GiB' : 'Unknown'">
                                </dd>
                            </div>
                        </dl>
                    </div>
                </div>
            </div>

            <!-- Storage Information (Half Width) -->
            <div class="p-4 sm:p-4">
                <div class="bg-purple-50 dark:bg-purple-900/10 rounded-lg shadow-sm overflow-hidden border border-purple-100 dark:border-purple-800/30">
                    <div class="px-4 py-3 bg-purple-100 dark:bg-purple-800/30">
                        <h3 class="text-lg font-medium leading-6 text-gray-900 dark:text-white">Storage</h3>
                    </div>
                    <div class="px-4 py-4">
                        <div class="flex flex-col">
                            <div class="-mx-4 overflow-x-auto sm:-mx-6 lg:-mx-8">
                                <div class="inline-block min-w-full py-2 align-middle px-4 sm:px-6 lg:px-8">
                                    <div class="overflow-hidden rounded-md shadow ring-1 ring-black ring-opacity-5">
                                        <table class="min-w-full divide-y divide-gray-300 dark:divide-gray-600">
                                            <thead class="bg-gray-50 dark:bg-gray-700">
                                                <tr>
                                                    <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 dark:text-white sm:pl-6">DEVICE</th>
                                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-white">SIZE</th>
                                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-white">MODEL</th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-gray-200 dark:divide-gray-600 bg-white dark:bg-gray-800">
                                                <template x-for="disk in machine.disks" :key="disk.device">
                                                    <tr>
                                                        <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 dark:text-white sm:pl-6" x-text="disk.device"></td>
                                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 dark:text-gray-400">
                                                            <template x-if="disk.calculated_size">
                                                                <span x-text="disk.calculated_size"></span>
                                                            </template>
                                                            <template x-if="!disk.calculated_size && disk.size_bytes !== null && disk.size_bytes !== undefined">
                                                                <span x-text="formatBytes(disk.size_bytes)"></span>
                                                            </template>
                                                            <template x-if="!disk.calculated_size && (disk.size_bytes === null || disk.size_bytes === undefined)">
                                                                <span>Unknown Size</span>
                                                            </template>
                                                        </td>
                                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 dark:text-gray-400">
                                                            <template x-if="disk.model">
                                                                <span x-text="disk.model"></span>
                                                            </template>
                                                            <template x-if="!disk.model">
                                                                <span>Unknown</span>
                                                            </template>
                                                        </td>
                                                    </tr>
                                                </template>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="px-4 py-4 sm:px-6 bg-gray-50 dark:bg-gray-700 flex justify-end space-x-3">
            {% if is_authenticated %}
            {# Show Edit button when not editing #}
            <button x-show="!isEditing" 
                @click="startEditing()"
                class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium rounded-md"
            >
                Edit
            </button>
            
            {# Show Save and Cancel buttons when editing #}
            <template x-if="isEditing">
                <div>
                    <!-- Error Message -->
                    <div x-show="editFormError" class="text-sm text-red-600 dark:text-red-400 mb-2 text-right" x-text="editFormError"></div>
                    <div class="flex justify-end space-x-3">
                        <button @click="saveChanges()" 
                                :disabled="isSubmitting"
                                class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-md"
                                :class="{'opacity-50 cursor-not-allowed': isSubmitting}">
                            <span x-show="isSubmitting">
                                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Saving...
                            </span>
                            <span x-show="!isSubmitting">Save Changes</span>
                        </button>
                        <button @click="cancelEdit()" 
                                :disabled="isSubmitting"
                                class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-medium rounded-md"
                                :class="{'opacity-50 cursor-not-allowed': isSubmitting}">
                            Cancel
                        </button>
                    </div>
                </div>
            </template>
            
            {# Always show Delete button if authenticated #}
            <button 
                @click="deleteModalOpen = true" 
                class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-md"
            >
                Delete
            </button>
            {% endif %}
        </div>
    </div>
    
    <!-- Delete Machine Modal (Moved INSIDE x-data scope) -->
    <div x-show="deleteModalOpen" 
         x-cloak 
         class="fixed inset-0 z-50 overflow-y-auto"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div @click="deleteModalOpen = false" class="fixed inset-0 bg-gray-500 dark:bg-gray-900 bg-opacity-75 dark:bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            
            <!-- Modal Content -->
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900 sm:mx-0 sm:h-10 sm:w-10">
                            <svg class="h-6 w-6 text-red-600 dark:text-red-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">
                                Delete Machine
                            </h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500 dark:text-gray-400">
                                    Are you sure you want to delete this machine? This action cannot be undone.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button @click="deleteMachine()" 
                            :disabled="isDeleting"
                            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm"
                            :class="{'opacity-50 cursor-not-allowed': isDeleting}">
                        <span x-show="isDeleting">
                            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Deleting...
                        </span>
                        <span x-show="!isDeleting">Delete</span>
                    </button>
                    <button @click="deleteModalOpen = false" 
                            :disabled="isDeleting"
                            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm"
                            :class="{'opacity-50 cursor-not-allowed': isDeleting}">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
  // Define helper functions in the script scope
  const formatBytes = (bytes, decimals = 1) => { 
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const dm = decimals < 0 ? 0 : decimals;
      const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
  };
  const findMatchingStreamTasks = (fileName) => { 
      const taskRows = document.querySelectorAll('#tasks-table-body tr[data-task-name]');
      const matchingRows = [];
      taskRows.forEach(row => {
          const taskNameAttr = row.getAttribute('data-task-name').toLowerCase();
          const fileNameLower = (fileName || '').toLowerCase();
          if (taskNameAttr.startsWith('stream image') || (fileNameLower && taskNameAttr.includes(fileNameLower))) {
              if (!taskNameAttr.includes('complete') && !taskNameAttr.includes('failed')) {
                  matchingRows.push(row);
              }
          }
      });
      if (matchingRows.length === 0) {
          taskRows.forEach(row => {
              const taskNameAttr = row.getAttribute('data-task-name').toLowerCase();
              if (taskNameAttr.startsWith('stream image')) {
                  if (!taskNameAttr.includes('complete') && !taskNameAttr.includes('failed')) {
                      matchingRows.push(row);
                  }
              }
          });
      }
      return matchingRows;
  };
  const startProgressAnimation = (element) => {
      if (element && !element.classList.contains('animate-progress')) {
          element.classList.add('animate-progress');
      }
  };
  const stopProgressAnimation = (element) => {
       if (element) {
          element.classList.remove('animate-progress');
      }
  };

  // Alpine component function
  function machineDetailsData() { 
    return {
        // --- Properties ---
        machine: { 
            id: null, 
            status: 'Loading...', 
            hostname: null, 
            ip_address: null, 
            mac_address: null, 
            memorable_name: null,
            os_choice: null, 
            disks: [], 
            nameservers: [],
            last_deployment_duration: null,
            bmc_credentials: null // Add other keys as needed by template
        }, 
        workflow_info: null,
        machineId: '', 
        machineIp: '',
        taskProgressState: {},
        evtSource: null,
        selectedStatus: '', // For the status update modal
        fetchDebounceTimer: null, // Timer for debouncing fetches
        error: null,

        // Inline edit properties
        isEditing: false, // Replaces editModalOpen
        editForm: { // Keep this to hold edits
            hostname: '',
            memorable_name: '',
            mac_address: '',
            ip_address: '',
            os_choice: ''
        },
        editFormError: '',
        isSubmitting: false,
        
        // Delete modal properties
        deleteModalOpen: false,
        isDeleting: false,
        
        // IP Address Type
        ipAddressType: 'Unknown',
        
        // --- Methods --- 
        // Renamed from openEditModal
        startEditing() {
            // Populate editForm with current machine data
            this.editForm = {
                hostname: this.machine.hostname || '',
                memorable_name: this.machine.memorable_name || '',
                mac_address: this.machine.mac_address || '',
                ip_address: this.machine.ip_address || '',
                os_choice: this.machine.os_choice || ''
            };
            this.editFormError = ''; // Clear previous errors
            this.isEditing = true;
        },
        
        cancelEdit() {
            this.isEditing = false;
            this.editFormError = ''; // Clear errors on cancel
            // No need to reset editForm, startEditing will repopulate
        },
        
        saveChanges() {
            this.isSubmitting = true;
            this.editFormError = '';
            
            // Validate MAC address format
            if (this.editForm.mac_address && !/^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$/.test(this.editForm.mac_address)) {
                this.editFormError = 'Invalid MAC address format. Please use XX:XX:XX:XX:XX:XX format.';
                this.isSubmitting = false;
                return;
            }
            
            // Validate IP address format if provided
            if (this.editForm.ip_address && !/^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(this.editForm.ip_address)) {
                this.editFormError = 'Invalid IP address format. Must be a valid IPv4 address.';
                this.isSubmitting = false;
                return;
            }
            
            // Validate hostname format if provided
            if (this.editForm.hostname && !/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(this.editForm.hostname)) {
                this.editFormError = 'Invalid hostname format. Must follow RFC-1123 standard.';
                this.isSubmitting = false;
                return;
            }
            
            fetch(`/api/machines/${this.machine.id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(this.editForm)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.message || 'Failed to update machine');
                    });
                }
                return response.json();
            })
            .then(data => {
                // Update the machine data directly in our model
                Object.assign(this.machine, this.editForm);
                
                // Show success toast
                if (window.showToast) {
                    window.showToast(`Machine updated successfully`, 'success');
                }
                
                // Exit editing mode
                this.isEditing = false; 
            })
            .catch(error => {
                this.editFormError = error.message || 'An error occurred while updating the machine';
                console.error('Error updating machine:', error);
                // Remain in editing mode on error
            })
            .finally(() => {
                this.isSubmitting = false;
            });
        },
        
        deleteMachine() {
            this.isDeleting = true;
            
            fetch(`/api/machines/${this.machine.id}`, {
                method: 'DELETE',
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || `HTTP error! status: ${response.status}`);
                    });
                }
                return response.text();
            })
            .then(() => {
                // Show success toast
                if (window.showToast) {
                    window.showToast(`Machine deleted successfully`, 'success');
                }
                
                // Redirect to machines list
                window.location.href = '/machines';
            })
            .catch(error => {
                if (window.showToast) {
                    window.showToast(`Failed to delete machine: ${error.message}`, 'error');
                }
                console.error('Error deleting machine:', error);
                this.deleteModalOpen = false;
            })
            .finally(() => {
                this.isDeleting = false;
            });
        },

        initSSE() {
            console.log("Initializing SSE connection...");
            if (this.evtSource && this.evtSource.readyState !== EventSource.CLOSED) {
                 console.log("SSE connection already open.");
                 return;
            }
            if (!this.machineId || this.machineId === 'error') {
                 console.warn("Cannot initialize SSE without a valid machine ID.");
                 return; // Don't init if ID not set or error
            }

            // Close existing connection if any (e.g., after error retry)
            if (this.evtSource) {
                this.evtSource.close();
            }

            console.log(`Attempting SSE connection to /api/events`);
            this.evtSource = new EventSource('/api/events');
            window.globalEvtSource = this.evtSource; // Keep global reference if needed elsewhere

            this.evtSource.onopen = () => {
                console.log("SSE connection opened.");
                this.error = null; // Clear error on successful connection
            };

            this.evtSource.onerror = (err) => {
                console.error('Global SSE connection error:', err);
                // Removed sse.close() to allow auto-reconnect
                console.log('SSE connection error. Browser will attempt to reconnect automatically.');
                // Optionally set an error state for the UI
                this.error = "Connection lost. Attempting to reconnect..."; 
            };

            // Generic message handler (if needed)
            this.evtSource.onmessage = (event) => {
                 console.log("Generic SSE message received:", event.data);
            };

            // --- Listener Replacement Start ---
            // Listen for machine updates with debounced fetch fallback
            this.evtSource.addEventListener('machine_updated', (event) => {
                console.log('Received machine_updated event:', event.data);
                try {
                    const eventData = JSON.parse(event.data);
                    
                    // Clear any pending fetch timeout
                    clearTimeout(this.fetchDebounceTimer);

                    // Check if the event contains the full machine object
                    if (eventData.machine) {
                        // Full data received directly in the event
                        console.log('Processing full data from SSE event.');
                        // Ensure we only update if the ID matches the current machine
                        if (eventData.machine.id === this.machine.id) {
                            this.machine = eventData.machine;
                            this.workflow_info = eventData.workflow_info || null; 
                            console.log('Updated machine state from SSE event:', this.machine);
                            console.log('Updated workflow info from SSE event:', this.workflow_info);
                        } else {
                            console.warn('Received full machine_updated event for a different machine ID:', eventData.machine.id, 'Expected:', this.machine.id);
                        }
                    } else if (eventData.id === this.machine.id) {
                        // Only ID received, debounce the fetch for the current machine
                        console.log(`Debouncing fetch for machine ${eventData.id}...`);
                        this.fetchDebounceTimer = setTimeout(() => {
                            console.log(`Executing debounced fetch for machine ${eventData.id}`);
                            fetch(`/api/machines/${eventData.id}`)
                                .then(response => {
                                    if (!response.ok) {
                                        // Throw an error to be caught by .catch()
                                        throw new Error(`Network response was not ok: ${response.statusText} (${response.status})`);
                                    }
                                    return response.json();
                                })
                                .then(fullData => {
                                    console.log('Fetched full data after event:', fullData);
                                    if (fullData.machine && fullData.machine.id === this.machine.id) {
                                        this.machine = fullData.machine;
                                        this.workflow_info = fullData.workflow_info || null;
                                        console.log('Updated machine state via fetch:', this.machine);
                                        console.log('Updated workflow info via fetch:', this.workflow_info);
                                        this.error = null; // Clear fetch error on success
                                    } else if (fullData.machine && fullData.machine.id !== this.machine.id) {
                                        console.warn('Fetched data belongs to a different machine ID:', fullData.machine.id, 'Expected:', this.machine.id);
                                    } else {
                                        console.warn('Fetched data missing machine structure or ID mismatch:', fullData);
                                    }
                                })
                                .catch(error => {
                                    // Log the network error 
                                    console.error('Error fetching full machine data:', error);
                                    // Update UI error state
                                    this.error = `Failed to fetch update for ${eventData.id}: ${error.message}. Retrying on next event.`;
                                });
                        }, 32); // <-- Changed debounce delay from 500 to 32ms
                    } else {
                        // Event is for a different machine or has unexpected format
                        console.warn('Ignoring machine_updated event: ID mismatch or invalid format.', 'Event ID:', eventData.id, 'Current Machine ID:', this.machine.id);
                    }
                } catch (e) {
                    console.error('Error parsing machine_updated event data:', e, 'Raw data:', event.data);
                    // Potentially update UI error state if parsing fails critically
                    this.error = "Error processing update event.";
                }
            });
            // --- Listener Replacement End ---

            // Listen for machine discovered events
            this.evtSource.addEventListener('machine_discovered', (event) => {
                console.log("SSE Listener: machine_discovered received:", event.data);
                // Add parsing and update logic here
            });

            // Add other specific listeners (ip_download_progress, task_progress) here if needed
            this.evtSource.addEventListener('ip_download_progress', (event) => {
                console.log("[PROGRESS_LISTENER] Listener is active!");
                console.log("SSE Listener: ip_download_progress received:", event.data);
                try {
                    const progressData = JSON.parse(event.data);
                    // Update logic based on progressData...
                    // Example: Find relevant task and update its progress visually
                    if (progressData.machine_id === this.machineId) {
                         console.log("Matching machine ID for progress update.");
                         const taskName = progressData.file_name || 'stream image'; // Use lowercase default
                         const bytesDownloaded = progressData.bytes_downloaded;
                         const totalSize = progressData.total_size;
                         const calculatedProgress = (totalSize > 0) ? (bytesDownloaded / totalSize * 100) : 0;

                         // Update the reactive state. Alpine will handle the DOM update.
                         // Ensure the task exists in the state before updating
                         if (this.taskProgressState[taskName] !== undefined) {
                            // Direct assignment for Alpine 3 reactivity
                            this.taskProgressState[taskName] = {
                                percent: calculatedProgress,
                                bytesDownloaded: bytesDownloaded,
                                totalSize: totalSize
                            };
                            console.log(`Updated taskProgressState for ${taskName}:`, JSON.stringify(this.taskProgressState[taskName]));
                         } else {
                            // Log if the task name from the event doesn't match any known task
                            console.warn(`Task state key not found for progress update: ${taskName}`);
                         }
                     }
                } catch (e) {
                     console.error('Error processing ip_download_progress event:', e, event.data);
                }
            });

             // Example for task_progress (adjust format if needed)
             this.evtSource.addEventListener('task_progress', (event) => {
                 console.log("SSE Listener: task_progress received:", event.data);
                 // Add parsing and update logic here
             });

        },

        initializeComponent() {
            console.log("Initializing Machine Details Component");

            // Check if JSON data is available
            const machineDataElement = document.getElementById('machine-data-json');
            const workflowDataElement = document.getElementById('workflow-data-json');

            if (machineDataElement && machineDataElement.textContent) {
                try {
                    this.machine = JSON.parse(machineDataElement.textContent);
                    console.log("Machine data loaded from JSON:", this.machine);
                    
                    // Set IP Address Type from template variable
                    this.ipAddressType = '{{ ip_address_type | safe }}';
                    console.log("IP Address Type:", this.ipAddressType);
                    
                    this.editForm = { ...this.machine }; // Initialize edit form
                } catch (e) {
                    console.error("Failed to parse machine JSON:", e);
                    // Set default error state
                    this.machine = { id: 'error', ip_address: 'error', status: 'Error parsing data', hostname: 'Error' };
                    this.workflow_info = null;
                    this.machineId = 'error';
                    this.machineIp = 'error';
                }
            } else {
                console.error("Machine data not found in script tag.");
                // Set default error state
                this.machine = { id: 'error', ip_address: 'error', status: 'Error parsing data', hostname: 'Error' };
                this.workflow_info = null;
                this.machineId = 'error';
                this.machineIp = 'error';
            }

            // Initialize task progress state from DOM after initial render
            this.$nextTick(() => {
                if (this.workflow_info && this.workflow_info.tasks) {
                    this.workflow_info.tasks.forEach(task => {
                        // Initialize with the structure expected by the template
                        if (this.taskProgressState[task.name] === undefined) { // Avoid overwriting if already updated by SSE
                            this.taskProgressState[task.name] = { 
                                percent: task.progress || 0,
                                bytesDownloaded: 0, // Assume 0 initially
                                totalSize: 0 // Assume 0 initially, update via SSE
                            };
                        }
                    });
                    console.log("Initial taskProgressState:", JSON.stringify(this.taskProgressState));
                }
            });

            // Initialize SSE connection AFTER initial data is parsed and properties are set
            this.initSSE(); 
        },

        // Helper function to format progress text
        generateProgressText(progressInfo) {
            if (!progressInfo) {
                return '0%'; // Or 'Pending' or whatever default
            }
            const percent = progressInfo.percent || 0;
            if (progressInfo.totalSize > 0) {
                const downloadedMB = (progressInfo.bytesDownloaded / (1024 * 1024)).toFixed(1);
                const totalMB = (progressInfo.totalSize / (1024 * 1024)).toFixed(1);
                return `${percent.toFixed(1)}% (${downloadedMB}/${totalMB} MB)`;
            } else {
                return `${percent.toFixed(1)}%`;
            }
        },

        fetchMachineData() {
            if (!this.machineId) return;
            // ... existing code ...
            this.evtSource.addEventListener('ip_download_progress', (event) => {
                console.log("[PROGRESS_LISTENER] Listener is active!"); // Added listener active log
                console.log("SSE Listener: ip_download_progress received:", event.data);
                try {
                    const progressData = JSON.parse(event.data);
                    // Update logic based on progressData...
                    // Example: Find relevant task and update its progress visually
                    if (progressData.machine_id === this.machineId) {
                         console.log("Matching machine ID for progress update.");
                         const taskName = progressData.file_name || 'stream image'; // Use lowercase default
                         const bytesDownloaded = progressData.bytes_downloaded;
                         const totalSize = progressData.total_size;
                         const calculatedProgress = (totalSize > 0) ? (bytesDownloaded / totalSize * 100) : 0;

                         // Update the reactive state. Alpine will handle the DOM update.
                         // Ensure the task exists in the state before updating
                         if (this.taskProgressState[taskName] !== undefined) {
                            // Direct assignment for Alpine 3 reactivity
                            this.taskProgressState[taskName] = {
                                percent: calculatedProgress,
                                bytesDownloaded: bytesDownloaded,
                                totalSize: totalSize
                            };
                            console.log(`Updated taskProgressState for ${taskName}:`, JSON.stringify(this.taskProgressState[taskName]));
                         } else {
                            // Log if the task name from the event doesn't match any known task
                            console.warn(`Task state key not found for progress update: ${taskName}`);
                         }
                     }
                } catch (e) {
                     console.error('Error processing ip_download_progress event:', e, event.data);
                }
            });

             // Example for task_progress (adjust format if needed)
             this.evtSource.addEventListener('task_progress', (event) => {
                 console.log("SSE Listener: task_progress received:", event.data);
                 // Add parsing and update logic here
             });

        }
    };
  }

  document.addEventListener('DOMContentLoaded', () => {
    console.log("Machine details page loaded, Alpine component should initialize shortly.");
  });
</script>
{% endblock %}