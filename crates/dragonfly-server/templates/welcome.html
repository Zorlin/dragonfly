{% extends "base.html" %}

{% block title %}Welcome to Dragonfly{% endblock %}

{% block content %}
<div class="py-8 px-4 sm:px-0" id="welcome-container">
    <div class="text-center mb-10">
        <h1 class="text-4xl font-bold bg-gradient-to-r from-green-500 to-purple-600 bg-clip-text text-transparent dark:from-indigo-400 dark:to-purple-300 dark:drop-shadow-[0_0_6px_rgba(129,140,248,0.5)]">
            Welcome to Dragonfly
        </h1>
        <p class="mt-4 text-xl text-gray-600 dark:text-gray-300 max-w-3xl mx-auto">
            Dragonfly is a metal management system that lets you create and manage servers and computers‚Äî
            installing operating systems, software, and more automatically.
        </p>
        <p class="mt-2 text-lg text-gray-500 dark:text-gray-400 max-w-3xl mx-auto">
            It's fast, flexible, and designed to scale from a single machine to a global fleet.
        </p>
    </div>

    <div class="mt-12 max-w-6xl mx-auto">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 text-center mb-4">Choose Your Flight Path</h2>
        <p class="mb-6 text-center text-gray-800 dark:text-gray-100 font-bold text-md">
            You can change your mind later, or mix and match.
        </p>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8" id="card-container">
            <!-- Simple Mode -->
            <a href="/setup/simple" class="card-link" data-href="/setup/simple">
                <div class="flight-card bg-emerald-800 dark:bg-emerald-900/90 rounded-xl shadow-md overflow-hidden border border-emerald-700 dark:border-emerald-800 transition-all hover:shadow-lg hover:scale-[1.02] duration-300 flex flex-col" style="height: 16em;">
                    <div class="p-6 flex-grow">
                        <div class="flex justify-center items-center mb-6">
                            <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-emerald-700 dark:bg-emerald-800">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-emerald-300 dark:text-emerald-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                                </svg>
                            </div>
                        </div>
                        <h3 class="text-xl font-semibold text-white mb-3 text-center">Simple</h3>
                        <p class="text-emerald-100 dark:text-emerald-200 mt-6 mb-4 text-center">
                            Simple operating system deployment. Requires you to define your machines to deploy them.
                        </p>
                    </div>
                </div>
            </a>
            <!-- Flight Mode -->
            <a href="/setup/flight" class="card-link" data-href="/setup/flight">
                <div class="flight-card bg-purple-900 dark:bg-purple-950/90 rounded-xl shadow-md overflow-hidden border border-purple-800 dark:border-purple-800 transition-all hover:shadow-lg hover:scale-[1.02] duration-300 flex flex-col" style="height: 16em;">
                    <div class="p-6 flex-grow">
                        <div class="flex justify-center items-center mb-6">
                            <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-purple-800 dark:bg-purple-800">
                                <span class="text-2xl">üêâ</span>
                            </div>
                        </div>
                        <h3 class="text-center text-xl font-semibold text-white mb-2">Flight</h3>
                        <p class="text-center text-purple-100 dark:text-purple-200 mt-6 mb-2">
                            The full power of Dragonfly. Machines register themselves and provision in real time.
                        </p>
                    </div>
                </div>
            </a>
            
            <!-- Swarm Mode -->
            <a href="/setup/swarm" class="card-link" data-href="/setup/swarm">
                <div class="flight-card bg-cyan-800 dark:bg-cyan-900/90 rounded-xl shadow-md overflow-hidden border border-cyan-700 dark:border-cyan-800 transition-all hover:shadow-lg hover:scale-[1.02] duration-300 flex flex-col" style="height: 16em;">
                    <div class="p-6 flex-grow">
                        <div class="flex justify-center items-center mb-6">
                            <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-cyan-700 dark:bg-cyan-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-cyan-300 dark:text-cyan-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
                                </svg>
                            </div>
                        </div>
                        <h3 class="text-center text-xl font-semibold text-white mb-2">Swarm</h3>
                        <p class="text-center text-cyan-100 dark:text-cyan-200 mt-6 mb-6">
                            Dragonfly, distributed. High availability, horizontal scaling and other goodies.
                        </p>
                    </div>
                </div>
            </a>
        </div>
    </div>
</div>

<style>
    @keyframes glow {
        0% { box-shadow: 0 0 5px rgba(255, 255, 255, 0.3); }
        50% { box-shadow: 0 0 10px 5px rgba(255, 255, 255, 0.7); }
        100% { box-shadow: 0 0 5px rgba(255, 255, 255, 0.3); }
    }
    
    @keyframes flyAway {
        0% { transform: scale(1) translateY(0); opacity: 1; }
        25% { transform: scale(1.1) translateY(0); opacity: 1; }
        100% { transform: scale(0.1) translateY(-500px); opacity: 0; }
    }
    
    @keyframes fadeOut {
        0% { opacity: 1; }
        100% { opacity: 0; }
    }
    
    .card-glowing {
        animation: glow 1s ease-in-out;
    }
    
    .card-fly-away {
        animation: flyAway 1.5s cubic-bezier(0.165, 0.84, 0.44, 1) forwards;
    }
    
    .card-fade-out {
        animation: fadeOut 1s ease-in-out forwards;
    }
    
    .fade-out {
        animation: fadeOut 1s ease-in-out forwards;
        animation-delay: 0.8s;
    }
    
    .no-scroll {
        overflow: hidden;
    }
    
    /* Input focus styles - apply when gamepad or keyboard is active */
    .input-active .card-focused {
        outline: 3px solid white;
        box-shadow: 0 0 15px 5px rgba(255, 255, 255, 0.5);
        transform: scale(1.05);
        transition: all 0.2s ease-in-out;
    }
    
    /* Controller button guide */
    .controller-guide {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        font-size: 0.9rem;
        z-index: 100;
        display: none;
    }
    
    .controller-guide.active {
        display: block;
    }
    
    /* Keyboard guide */
    .keyboard-guide {
        position: fixed;
        bottom: 20px;
        left: 20px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        font-size: 0.9rem;
        z-index: 100;
        display: none;
    }
    
    .keyboard-guide.active {
        display: block;
    }
</style>

<div class="controller-guide" id="xbox-guide">
    <div><span class="mr-2">‚óÄ ‚ñ∂</span> Navigate cards</div>
    <div><span class="mr-2">A</span> Select card</div>
</div>

<div class="keyboard-guide" id="keyboard-guide">
    <div><span class="mr-2">‚Üê ‚Üí</span> Navigate cards</div>
    <div><span class="mr-2">Enter</span> Select card</div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const cards = document.querySelectorAll('.card-link');
        const container = document.getElementById('welcome-container');
        const cardContainer = document.getElementById('card-container');
        const controllerGuide = document.getElementById('xbox-guide');
        const keyboardGuide = document.getElementById('keyboard-guide');
        let currentCardIndex = 1;
        let isGamepadConnected = false;
        let isKeyboardActive = false;
        let animationInProgress = false;
        
        // Function to handle card selection and animation
        function selectCard(card) {
            if (animationInProgress) return;
            animationInProgress = true;
            
            const href = card.getAttribute('data-href');
            const selectedCard = card.querySelector('.flight-card');
            
            // Apply glow effect to selected card
            selectedCard.classList.add('card-glowing');
            
            // After glow, start animations
            setTimeout(() => {
                // Prevent scrolling during animation
                document.body.classList.add('no-scroll');
                
                // Get all cards
                const allCards = cardContainer.querySelectorAll('.flight-card');
                
                // Make only the selected card fly away
                selectedCard.classList.add('card-fly-away');
                
                // Fade out all other cards
                allCards.forEach((c) => {
                    if (c !== selectedCard) {
                        c.classList.add('card-fade-out');
                    }
                });
                
                // Fade out the rest of the content
                container.classList.add('fade-out');
                
                // Navigate after animations complete
                setTimeout(() => {
                    window.location.href = href;
                }, 1800);
            }, 800);
        }
        
        // Mouse/touch click event handling
        cards.forEach((card, index) => {
            card.addEventListener('click', function(e) {
                e.preventDefault();
                selectCard(this);
            });
        });
        
        // Xbox controller support
        function updateCardFocus() {
            cards.forEach((card, index) => {
                const flightCard = card.querySelector('.flight-card');
                if (index === currentCardIndex) {
                    flightCard.classList.add('card-focused');
                } else {
                    flightCard.classList.remove('card-focused');
                }
            });
        }
        
        // Function to activate input mode (keyboard or gamepad)
        function activateInputMode() {
            document.body.classList.add('input-active');
            updateCardFocus();
        }
        
        // Mouse/touch click event handling
        cards.forEach((card, index) => {
            card.addEventListener('click', function(e) {
                e.preventDefault();
                selectCard(this);
            });
        });
        
        // Gamepad connection handler
        window.addEventListener("gamepadconnected", (e) => {
            console.log("Xbox controller connected");
            isGamepadConnected = true;
            activateInputMode();
            controllerGuide.classList.add('active');
            
            // Initialize focus on first connecting gamepad
            updateCardFocus();
            
            // Start polling for gamepad input
            if (!pollInterval) {
                pollInterval = setInterval(pollGamepad, 100);
            }
        });
        
        window.addEventListener("gamepaddisconnected", (e) => {
            console.log("Xbox controller disconnected");
            isGamepadConnected = false;
            
            // Don't remove input-active if keyboard is still active
            if (!isKeyboardActive) {
                document.body.classList.remove('input-active');
            }
            
            controllerGuide.classList.remove('active');
            
            // Remove focus styling when gamepad disconnects
            cards.forEach(card => {
                card.querySelector('.flight-card').classList.remove('card-focused');
            });
            
            // Stop polling if no gamepads connected
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        });
        
        // Check if gamepad already connected (page refresh case)
        function checkGamepad() {
            const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
            for (let i = 0; i < gamepads.length; i++) {
                if (gamepads[i]) {
                    isGamepadConnected = true;
                    activateInputMode();
                    controllerGuide.classList.add('active');
                    
                    if (!pollInterval) {
                        pollInterval = setInterval(pollGamepad, 100);
                    }
                    break;
                }
            }
        }
        
        let buttonPressed = false;
        let pollInterval;
        
        // Poll for gamepad input
        function pollGamepad() {
            if (animationInProgress) return;
            
            const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
            if (!gamepads[0]) return;
            
            const gamepad = gamepads[0]; // Using first connected gamepad
            
            // D-pad right or analog stick right
            if ((gamepad.buttons[15] && gamepad.buttons[15].pressed) || 
                (gamepad.axes[0] > 0.5 && !buttonPressed)) {
                buttonPressed = true;
                currentCardIndex = (currentCardIndex + 1) % cards.length;
                updateCardFocus();
            }
            // D-pad left or analog stick left
            else if ((gamepad.buttons[14] && gamepad.buttons[14].pressed) || 
                    (gamepad.axes[0] < -0.5 && !buttonPressed)) {
                buttonPressed = true;
                currentCardIndex = (currentCardIndex - 1 + cards.length) % cards.length;
                updateCardFocus();
            }
            // A button for selection
            else if (gamepad.buttons[0] && gamepad.buttons[0].pressed && !buttonPressed) {
                buttonPressed = true;
                selectCard(cards[currentCardIndex]);
            }
            // Reset button pressed state when buttons are released
            else if (!(gamepad.buttons[14] && gamepad.buttons[14].pressed) && 
                    !(gamepad.buttons[15] && gamepad.buttons[15].pressed) &&
                    !(gamepad.buttons[0] && gamepad.buttons[0].pressed) &&
                    Math.abs(gamepad.axes[0]) < 0.5) {
                buttonPressed = false;
            }
        }
        
        // Check for already connected gamepads
        checkGamepad();
        
        // Support keyboard navigation always
        document.addEventListener('keydown', function(e) {
            if (animationInProgress) return;
            
            // Activate keyboard navigation on first key press
            if (!isKeyboardActive && (e.key === 'ArrowRight' || e.key === 'ArrowLeft' || e.key === 'Enter' || e.key === ' ')) {
                isKeyboardActive = true;
                activateInputMode();
                keyboardGuide.classList.add('active');
            }
            
            // Arrow keys for navigation
            if (e.key === 'ArrowRight') {
                currentCardIndex = (currentCardIndex + 1) % cards.length;
                updateCardFocus();
            } else if (e.key === 'ArrowLeft') {
                currentCardIndex = (currentCardIndex - 1 + cards.length) % cards.length;
                updateCardFocus();
            } 
            // Enter/Space for selection
            else if (e.key === 'Enter' || e.key === ' ') {
                selectCard(cards[currentCardIndex]);
            }
        });
    });
</script>
{% endblock %}
